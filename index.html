<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaxBot â€” GST & E-Doc Intelligence Platform</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --orange:#ff6b00;
  --orange-soft:#fff3eb;
  --black:#111111;
  --gray:#666;
  --border-light:#e6e6e6;
}
</style>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --ink:#07090f;--ink2:#0f1117;--ink3:#161a24;--ink4:#1e2330;
  --orange:#ff6b00;--orange2:#ff8c00;--orange3:#ff4000;
  --blue:#3b82f6;--blue2:#60a5fa;--blue-glow:rgba(59,130,246,0.4);
  --og:rgba(255,107,0,0.1);
  --text:#eef0f6;--text2:#8892a4;--text3:#3d4455;
  --success:#00dba0;--danger:#ff3b5c;--warn:#f59e0b;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.12);
  --card-bg:rgba(255,255,255,0.035);
  --card-hover:rgba(255,255,255,0.065);
  --radius:18px;--radius-sm:10px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden}
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--ink);
  color:var(--text);
  position:relative;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOISE TEXTURE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:0.6;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity 0.35s ease;
  z-index:1;overflow:hidden;
}
.screen.active{opacity:1;pointer-events:all;z-index:10}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSITION CURTAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#curtain{
  position:fixed;inset:0;
  background:linear-gradient(135deg,var(--orange3),var(--orange),var(--orange2));
  z-index:9999;pointer-events:none;
  clip-path:circle(0% at 50% 50%);
  transition:clip-path 0.42s cubic-bezier(0.4,0,0.2,1),opacity 0.42s ease;
  opacity:0;
}
#curtain.show{clip-path:circle(150% at 50% 50%);opacity:1;pointer-events:all}
#curtain.hide{clip-path:circle(0% at 50% 50%);opacity:0;pointer-events:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-landing{
  background:var(--ink);
  flex-direction:column;align-items:center;
  gap:0;padding:20px;
  overflow-y:auto;
  align-items:center;
  justify-content:flex-start;
  padding-top:64px;
  padding-bottom:40px;
}
/* Radial aurora bg */
#screen-landing::after{
  content:'';position:absolute;
  top:50%;left:50%;transform:translate(-50%,-50%);
  width:900px;height:900px;
  background:
    radial-gradient(ellipse at 30% 40%,rgba(59,130,246,0.06) 0%,transparent 55%),
    radial-gradient(ellipse at 70% 60%,rgba(255,107,0,0.06) 0%,transparent 55%);
  pointer-events:none;z-index:0;
}
/* Subtle grid */
#screen-landing::before{
  content:'';position:absolute;inset:0;
  background-image:
    linear-gradient(rgba(255,255,255,0.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.025) 1px,transparent 1px);
  background-size:60px 60px;
  pointer-events:none;z-index:0;
}

.land-content{
  position:relative;z-index:10;
  display:flex;flex-direction:column;align-items:center;
  text-align:center;
  gap:0;
}

/* Brand pill */
.brand-pill{
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(255,107,0,0.1);
  border:1px solid rgba(255,107,0,0.25);
  border-radius:100px;
  padding:6px 16px 6px 10px;
  font-size:11px;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;
  color:var(--orange);margin-bottom:20px;
}
.brand-pill-dot{
  width:6px;height:6px;background:var(--orange);
  border-radius:50%;animation:dotBlink 2s infinite;
}
@keyframes dotBlink{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(255,107,0,0.5)}50%{opacity:0.5;box-shadow:0 0 0 5px rgba(255,107,0,0)}}

.land-title{
  font-family:'Syne',sans-serif;
  font-size:clamp(34px,5.5vw,72px);
  font-weight:800;line-height:1.0;
  letter-spacing:-2.5px;
  margin-bottom:4px;
}
.land-title span{
  background:linear-gradient(135deg,var(--orange),var(--orange2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.land-sub-title{
  font-size:clamp(13px,1.4vw,16px);
  color:var(--text2);font-weight:400;
  max-width:440px;line-height:1.65;
  margin-bottom:0;
}

/* â•â• 3D ROBOT â•â• */
.bot-scene{
  position:relative;z-index:2;
  display:flex;align-items:flex-end;gap:20px;
  margin:22px 0 26px;
}
/* Ground shadow */
.bot-scene::after{
  content:'';position:absolute;
  bottom:-4px;left:50%;transform:translateX(-50%);
  width:100px;height:16px;
  background:radial-gradient(ellipse,rgba(59,130,246,0.3) 0%,transparent 70%);
  border-radius:50%;
  animation:groundPulse 2.8s ease-in-out infinite;
}
@keyframes groundPulse{0%,100%{transform:translateX(-50%) scaleX(1);opacity:0.6}50%{transform:translateX(-50%) scaleX(0.65);opacity:0.25}}

.robot-wrap{
  position:relative;
  cursor:pointer;
  animation:robotFloat 2.8s ease-in-out infinite;
  filter:drop-shadow(0 0 20px rgba(59,130,246,0.35)) drop-shadow(0 14px 32px rgba(0,0,0,0.55));
}
@keyframes robotFloat{
  0%  {transform:translateY(0) rotateY(-5deg) rotateX(2deg) rotateZ(-0.5deg)}
  50% {transform:translateY(-11px) rotateY(5deg) rotateX(-2deg) rotateZ(0.5deg)}
  100%{transform:translateY(0) rotateY(-5deg) rotateX(2deg) rotateZ(-0.5deg)}
}
.robot-wrap.jumping{
  animation:robotJump 0.75s cubic-bezier(0.3,1.5,0.7,1) forwards;
}
@keyframes robotJump{
  0%  {transform:translateY(0) scale(1)}
  30% {transform:translateY(-90px) scale(1.12) rotateZ(-10deg)}
  65% {transform:translateY(-70px) scale(1.06) rotateZ(8deg)}
  100%{transform:translateY(-240px) scale(0) rotateZ(20deg)}
}

.robot-svg{width:130px;height:168px}

/* Robot arm animations */
.arm-l-g{animation:armL 0.85s ease-in-out infinite alternate;transform-origin:27px 72px}
.arm-r-g{animation:armR 0.85s ease-in-out infinite alternate;transform-origin:103px 72px}
@keyframes armL{0%{transform:rotate(-15deg)}100%{transform:rotate(11deg)}}
@keyframes armR{0%{transform:rotate(11deg)}100%{transform:rotate(-15deg)}}
.leg-l-g{animation:legL 0.85s ease-in-out infinite alternate;transform-origin:47px 132px}
.leg-r-g{animation:legR 0.85s ease-in-out infinite alternate;transform-origin:83px 132px}
@keyframes legL{0%{transform:rotate(-11deg)}100%{transform:rotate(8deg)}}
@keyframes legR{0%{transform:rotate(8deg)}100%{transform:rotate(-11deg)}}

/* Blue eye glow */
.eye-glow-anim{animation:eyeGlowPulse 2.2s ease-in-out infinite}
@keyframes eyeGlowPulse{0%,100%{opacity:0.7}50%{opacity:1}}
/* Antenna */
.ant-dot{animation:antPulse 1.8s ease-in-out infinite}
@keyframes antPulse{0%,100%{opacity:1}50%{opacity:0.2}}
/* Chest light */
.chest-light{animation:chestBeat 2.4s ease-in-out infinite}
@keyframes chestBeat{0%,100%{opacity:1}50%{opacity:0.45}}
/* Screen scanline */
.screen-line{animation:scanLine 3s linear infinite}
@keyframes scanLine{0%{transform:translateY(-8px);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:translateY(16px);opacity:0}}

/* â•â• SPEECH BUBBLE â•â• */
.speech-bubble{
  position:relative;
  background:#fff;
  color:#111;
  border-radius:20px 20px 20px 5px;
  padding:14px 18px;
  max-width:210px;
  font-size:13.5px;font-weight:500;line-height:1.55;
  box-shadow:0 10px 36px rgba(0,0,0,0.28),0 0 0 1px rgba(0,0,0,0.06);
  animation:bubblePop 0.5s cubic-bezier(0.3,1.5,0.7,1) 0.3s both;
  margin-bottom:16px;
}
.speech-bubble::before{
  content:'';position:absolute;
  bottom:-9px;left:18px;
  width:0;height:0;
  border-left:10px solid transparent;
  border-right:0 solid transparent;
  border-top:10px solid #fff;
}
@keyframes bubblePop{0%{transform:scale(0.5) translateY(10px);opacity:0}100%{transform:scale(1) translateY(0);opacity:1}}
.speech-bubble strong{color:var(--orange)}
.t-dot{display:inline-flex;gap:3px}
.t-dot span{width:5px;height:5px;background:#aaa;border-radius:50%;animation:tdot 1.2s ease-in-out infinite}
.t-dot span:nth-child(2){animation-delay:.2s}
.t-dot span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:translateY(0);opacity:0.4}40%{transform:translateY(-5px);opacity:1}}

/* â•â• CTA BUTTON â•â• */
.cta-btn{
  position:relative;z-index:100;
  display:inline-flex;align-items:center;gap:10px;
  background:linear-gradient(135deg,var(--orange),var(--orange3));
  color:#fff;border:none;border-radius:100px;
  padding:17px 46px;
  font-family:'Syne',sans-serif;font-size:15px;font-weight:800;
  letter-spacing:0.3px;cursor:pointer;
  transition:transform 0.2s,box-shadow 0.2s;
  box-shadow:0 8px 32px rgba(255,107,0,0.35),inset 0 1px 0 rgba(255,255,255,0.2);
  animation:ctaPulse 2.5s ease-in-out infinite;
}
@keyframes ctaPulse{0%,100%{box-shadow:0 8px 32px rgba(255,107,0,0.35),inset 0 1px 0 rgba(255,255,255,0.2),0 0 0 0 rgba(255,107,0,0.35)}50%{box-shadow:0 8px 32px rgba(255,107,0,0.35),inset 0 1px 0 rgba(255,255,255,0.2),0 0 0 16px rgba(255,107,0,0)}}
.cta-btn:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 14px 40px rgba(255,107,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2)}
.cta-btn:active{transform:scale(0.97)}
.cta-arrow{font-size:18px;transition:transform 0.2s}
.cta-btn:hover .cta-arrow{transform:translateX(5px)}
.cta-hint{position:relative;z-index:2;margin-top:13px;font-size:11px;color:var(--text3);letter-spacing:0.5px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED MENU SCREEN STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.menu-screen{
  background:var(--ink);
  flex-direction:column;
  align-items:center;justify-content:center;
  padding:32px 20px;
}
/* Diagonal stripe accent */
.menu-screen::before{
  content:'';position:absolute;
  top:0;right:0;width:40%;height:100%;
  background:linear-gradient(135deg,transparent 50%,rgba(255,107,0,0.018) 50%);
  pointer-events:none;
}
.menu-screen::after{
  content:'';position:absolute;
  top:-300px;left:-300px;width:800px;height:800px;
  background:radial-gradient(circle,rgba(255,107,0,0.04) 0%,transparent 60%);
  pointer-events:none;
}

/* Back button */
.back-btn{
  position:absolute;top:24px;left:24px;
  display:inline-flex;align-items:center;gap:7px;
  background:var(--card-bg);
  border:1px solid var(--border);
  color:var(--text2);border-radius:100px;
  padding:8px 16px 8px 12px;
  font-size:12px;font-weight:600;
  cursor:pointer;transition:all 0.2s;
  font-family:'Plus Jakarta Sans',sans-serif;
  z-index:20;
  backdrop-filter:blur(12px);
}
.back-btn:hover{border-color:var(--orange);color:var(--orange);background:var(--og)}
.back-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}

/* Screen header */
.screen-hdr{
  text-align:center;margin-bottom:40px;
  position:relative;z-index:2;
}
.breadcrumb{
  display:inline-flex;align-items:center;gap:6px;
  font-size:11px;color:var(--text3);
  margin-bottom:16px;
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:100px;padding:5px 14px;
  letter-spacing:0.3px;
}
.breadcrumb .bc-item{color:var(--text2)}
.breadcrumb .bc-sep{color:var(--text3);font-size:9px}
.breadcrumb .bc-active{color:var(--orange);font-weight:600}
.screen-hdr h2{
  font-family:'Syne',sans-serif;
  font-size:clamp(28px,4vw,50px);
  font-weight:800;letter-spacing:-1.5px;line-height:1.1;
  color:var(--text);margin-bottom:10px;
}
.screen-hdr h2 em{font-style:normal;color:var(--orange)}
.screen-hdr p{font-size:14px;color:var(--text2);max-width:420px;margin:0 auto;line-height:1.6}

/* â•â• OPTION CARDS â•â• */
.option-grid{
  display:flex;gap:18px;flex-wrap:wrap;
  justify-content:center;
  position:relative;z-index:2;
  max-width:920px;
}

.option-card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:32px 28px 28px;
  min-width:220px;max-width:260px;
  flex:1;cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34,1.2,0.64,1);
  position:relative;overflow:hidden;text-align:left;
  backdrop-filter:blur(16px);
}
/* Glossy top sheen */
.option-card::before{
  content:'';position:absolute;
  top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);
}
/* Hover glow line */
.option-card::after{
  content:'';position:absolute;
  top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--orange3),var(--orange),var(--orange2));
  transform:scaleX(0);transform-origin:left;
  transition:transform 0.35s ease;
}
.option-card:hover{
  border-color:rgba(255,107,0,0.35);
  transform:translateY(-8px) scale(1.02);
  background:var(--card-hover);
  box-shadow:0 24px 60px rgba(0,0,0,0.4),0 0 0 1px rgba(255,107,0,0.12),inset 0 1px 0 rgba(255,255,255,0.08);
}
.option-card:hover::after{transform:scaleX(1)}
.option-card:active{transform:translateY(-3px) scale(0.99)}

.card-eyebrow{
  display:flex;align-items:center;gap:8px;
  font-size:10px;font-weight:700;
  color:var(--orange);letter-spacing:2px;text-transform:uppercase;
  margin-bottom:18px;
}
.card-eyebrow::after{
  content:'';flex:1;height:1px;
  background:linear-gradient(90deg,rgba(255,107,0,0.3),transparent);
}
.card-icon-wrap{
  width:52px;height:52px;
  border-radius:14px;
  background:linear-gradient(135deg,rgba(255,107,0,0.15),rgba(255,107,0,0.05));
  border:1px solid rgba(255,107,0,0.2);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;margin-bottom:16px;
  transition:transform 0.3s,box-shadow 0.3s;
}
.option-card:hover .card-icon-wrap{
  transform:scale(1.1) rotate(-5deg);
  box-shadow:0 8px 24px rgba(255,107,0,0.25);
}
.card-title{
  font-family:'Syne',sans-serif;
  font-size:21px;font-weight:800;
  color:var(--text);margin-bottom:8px;line-height:1.1;
}
.card-desc{font-size:12px;color:var(--text2);line-height:1.65}
.card-cta{
  display:inline-flex;align-items:center;gap:5px;
  margin-top:20px;font-size:11px;font-weight:700;
  color:var(--orange);letter-spacing:0.3px;
  opacity:0;transform:translateX(-8px);
  transition:all 0.25s;
}
.option-card:hover .card-cta{opacity:1;transform:translateX(0)}
.card-cta svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}

/* Coming soon chip */
.cs-chip{
  position:absolute;top:14px;right:14px;
  font-size:9px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;
  color:var(--text3);background:var(--ink3);
  border:1px solid var(--border);
  border-radius:100px;padding:3px 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECONCILIATION TOOL SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-recon{
  flex-direction:column;align-items:stretch;
  justify-content:flex-start;
  overflow-y:auto;padding:0;
  background:var(--ink);
}
.recon-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 28px;
  background:rgba(7,9,15,0.95);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;
  backdrop-filter:blur(20px);
  flex-shrink:0;
}
.rtb-logo{display:flex;align-items:center;gap:11px}
.rtb-icon{
  width:36px;height:36px;
  background:linear-gradient(135deg,var(--orange),var(--orange3));
  border-radius:9px;display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-weight:800;font-size:11px;color:#fff;
  box-shadow:0 0 16px rgba(255,107,0,0.35);
}
.rtb-logo h3{
  font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--text);
}
.rtb-logo p{font-size:10px;color:var(--text2)}

.ri{max-width:1060px;margin:0 auto;padding:32px 24px 80px;width:100%}
.ri .hero{text-align:center;margin-bottom:32px}
.ri .hero h2{font-family:'Syne',sans-serif;font-size:clamp(20px,2.8vw,34px);font-weight:800;letter-spacing:-1px;margin-bottom:8px;line-height:1.1}
.ri .hero h2 span{color:var(--orange)}
.ri .hero p{font-size:13px;color:var(--text2);max-width:480px;margin:0 auto;line-height:1.6}

.ri .upload-grid{display:grid;grid-template-columns:1fr 44px 1fr;gap:0;margin-bottom:26px;align-items:stretch}
.ri .divider{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px}
.ri .div-line{flex:1;width:1px;background:var(--border)}
.ri .div-vs{font-size:10px;color:var(--text3);font-weight:700;background:var(--ink3);border:1px solid var(--border);width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.ri .ucard{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:22px;transition:border-color 0.25s;position:relative;overflow:hidden;backdrop-filter:blur(16px)}
.ri .ucard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent)}
.ri .ucard::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--orange3),var(--orange));opacity:0;transition:opacity 0.3s}
.ri .ucard.loaded{border-color:rgba(255,107,0,0.4)}
.ri .ucard.loaded::after{opacity:1}
.ri .src-tag{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.8px;color:var(--orange);background:var(--og);border:1px solid rgba(255,107,0,0.2);padding:3px 9px;border-radius:100px;margin-bottom:13px}
.ri .dropzone{border:1.5px dashed rgba(255,255,255,0.1);border-radius:var(--radius-sm);padding:22px 16px;text-align:center;transition:all 0.2s;position:relative;background:rgba(0,0,0,0.2);cursor:pointer}
.ri .dropzone:hover,.ri .dropzone.over{border-color:var(--orange);background:var(--og)}
.ri .dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;z-index:10}
.ri .dz-icon{font-size:26px;margin-bottom:7px}
.ri .dz-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:2px}
.ri .dz-sub{font-size:11px;color:var(--text2)}
.ri .dz-fmt{font-size:10px;color:var(--text3);margin-top:5px}
.ri .browse-btn{display:flex;align-items:center;justify-content:center;gap:7px;margin-top:10px;width:100%;background:linear-gradient(135deg,var(--orange),var(--orange3));color:#fff;border:none;border-radius:var(--radius-sm);padding:9px 0;font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all 0.2s;position:relative;z-index:1;box-shadow:0 4px 14px rgba(255,107,0,0.3)}
.ri .browse-btn:hover{box-shadow:0 8px 24px rgba(255,107,0,0.45);transform:translateY(-1px)}

/* â”€â”€ Upload progress bar â”€â”€ */
.ri .upload-progress{display:none;margin-top:10px;background:rgba(0,0,0,0.22);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 13px}
.ri .upload-progress.on{display:block}
.ri .up-label{font-size:10px;font-weight:600;color:var(--text2);margin-bottom:7px;display:flex;justify-content:space-between;align-items:center}
.ri .up-label span{color:var(--orange);font-weight:800;font-size:11px}
.ri .up-track{height:6px;background:rgba(255,255,255,0.07);border-radius:6px;overflow:hidden}
.ri .up-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--orange3),var(--orange),var(--orange2));border-radius:6px;transition:width 0.3s ease;box-shadow:0 0 10px rgba(255,107,0,0.55)}
.ri .up-status{font-size:10px;color:var(--text2);margin-top:6px;text-align:center;min-height:14px}

/* â”€â”€ Upload success banner â”€â”€ */
.ri .upload-success{display:none;margin-top:10px;background:rgba(0,219,160,0.08);border:1px solid rgba(0,219,160,0.3);border-radius:var(--radius-sm);padding:10px 13px;align-items:center;gap:9px}
.ri .upload-success.on{display:flex}
.ri .us-icon{font-size:18px;flex-shrink:0}
.ri .us-text{font-size:11px;color:var(--success);font-weight:700;flex:1;word-break:break-all}
.ri .us-meta{font-size:10px;color:var(--text2);flex-shrink:0;white-space:nowrap}
.ri .finfo{display:none;margin-top:10px;background:rgba(255,107,0,0.06);border:1px solid rgba(255,107,0,0.2);border-radius:var(--radius-sm);padding:9px 11px;align-items:center;gap:9px}
.ri .finfo.on{display:flex}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.4)}}
.ri .fdot{width:7px;height:7px;background:var(--orange);border-radius:50%;flex-shrink:0;animation:pulse 2s infinite}
.ri .fname{font-size:11px;color:var(--text);flex:1;word-break:break-all}
.ri .fmeta{font-size:10px;color:var(--text2);flex-shrink:0;white-space:nowrap}
.ri .fclear{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 3px;flex-shrink:0;transition:color 0.15s;line-height:1}
.ri .fclear:hover{color:var(--danger)}
.ri .debug-box{margin-top:9px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15);border-radius:var(--radius-sm);padding:9px 11px;display:none}
.ri .debug-box.on{display:block}
.ri .debug-title{font-size:9px;font-weight:700;color:var(--warn);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.ri .debug-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.ri .debug-row{font-size:9px;font-family:monospace;background:rgba(255,255,255,0.04);border-radius:4px;padding:3px 7px;display:flex;justify-content:space-between;gap:8px}
.ri .debug-field{color:var(--text2)}
.ri .debug-found{color:var(--success)}
.ri .debug-miss{color:var(--danger)}
/* â•â• MATCHING RULES BOX â•â• */
.matching-rules-box{background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.08);border-left:4px solid var(--blue);border-radius:var(--radius);margin:0 0 24px 0;overflow:hidden}
.mrb-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;cursor:pointer;background:rgba(59,130,246,0.06);user-select:none;transition:background 0.2s}
.mrb-header:hover{background:rgba(59,130,246,0.1)}
.mrb-header h3{margin:0;font-size:15px;font-weight:700;color:var(--text)}
.mrb-toggle-icon{font-size:12px;color:var(--text2);transition:transform 0.3s}
.mrb-toggle-icon.collapsed{transform:rotate(-90deg)}
.mrb-body{padding:16px 20px 20px;display:flex;flex-direction:column;gap:16px}
.mrb-notes h4,.mrb-filters h4{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px}
.mrb-notes ul{padding-left:18px;display:flex;flex-direction:column;gap:6px}
.mrb-notes ul li{font-size:13px;color:var(--text);line-height:1.5}
.mrb-notes ul li strong{color:var(--blue2)}
.mrb-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.mrb-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:var(--radius-sm);padding:12px 14px;display:flex;flex-direction:column;gap:7px}
.mrb-cat-badge{display:inline-block;font-size:11px;font-weight:800;letter-spacing:0.08em;padding:2px 8px;border-radius:4px;align-self:flex-start}
.mrb-b2b .mrb-cat-badge{background:rgba(0,219,160,0.15);color:var(--success)}
.mrb-cdn .mrb-cat-badge{background:rgba(245,158,11,0.15);color:var(--warn)}
.mrb-b2cs .mrb-cat-badge{background:rgba(59,130,246,0.15);color:var(--blue2)}
.mrb-b2cl .mrb-cat-badge{background:rgba(255,107,0,0.15);color:var(--orange)}
.mrb-source{font-size:12px;color:var(--text);line-height:1.5}
.mrb-source em{color:var(--text2);font-style:normal}
.mrb-vs{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em}
.src-label{display:inline-block;font-size:10px;font-weight:700;padding:1px 6px;border-radius:3px;margin-right:4px;letter-spacing:0.05em}
.emg-label{background:rgba(0,219,160,0.12);color:var(--success)}
.comp-label{background:rgba(255,107,0,0.12);color:var(--orange)}
/* â•â• END MATCHING RULES BOX â•â• */
.ri .run-section{text-align:center;margin-bottom:32px}
.ri .btn-run{background:linear-gradient(135deg,var(--orange),var(--orange3));color:#fff;border:none;border-radius:100px;padding:15px 52px;font-size:14px;font-weight:700;font-family:'Syne',sans-serif;cursor:pointer;transition:all 0.25s;box-shadow:0 8px 28px rgba(255,107,0,0.3),inset 0 1px 0 rgba(255,255,255,0.15)}
.ri .btn-run:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 14px 36px rgba(255,107,0,0.5)}
.ri .btn-run:disabled{background:var(--ink3);color:var(--text3);box-shadow:none;cursor:not-allowed}
.ri .run-hint{font-size:11px;color:var(--text3);margin-top:7px}
.ri .prog-wrap{max-width:460px;margin:16px auto 0;display:none}
.ri .prog-track{height:3px;background:var(--border);border-radius:3px;overflow:hidden}
.ri .prog-fill{height:100%;background:linear-gradient(90deg,var(--orange3),var(--orange),var(--orange2));border-radius:3px;width:0%;transition:width 0.45s ease;box-shadow:0 0 8px var(--orange)}
.ri .prog-lbl{text-align:center;font-size:11px;color:var(--text2);margin-top:7px}
.ri .err-bar{max-width:660px;margin:12px auto;background:rgba(255,59,92,0.08);border:1px solid rgba(255,59,92,0.3);border-radius:var(--radius-sm);padding:9px 15px;font-size:12px;color:var(--danger);display:none;text-align:center}
.ri .results{display:none}
.ri .res-hdr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px}
.ri .res-hdr h3{font-family:'Syne',sans-serif;font-size:19px;font-weight:800}
.ri .res-hdr h3 span{color:var(--orange)}
.ri .chips{display:flex;gap:8px;flex-wrap:wrap}
.ri .chip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:100px;font-size:11px;font-weight:600;border:1px solid}
.ri .chip.g{color:var(--success);border-color:rgba(0,219,160,0.3);background:rgba(0,219,160,0.06)}
.ri .chip.r{color:var(--danger);border-color:rgba(255,59,92,0.3);background:rgba(255,59,92,0.06)}
.ri .chip .dot{width:5px;height:5px;border-radius:50%}
.ri .chip.g .dot{background:var(--success)}.ri .chip.r .dot{background:var(--danger)}
.ri .btn-xl{background:rgba(0,219,160,0.08);border:1px solid rgba(0,219,160,0.25);color:var(--success);border-radius:100px;padding:8px 18px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s}
.ri .btn-xl:hover{background:rgba(0,219,160,0.16)}
.ri .tbl-wrap{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;overflow-x:auto;backdrop-filter:blur(16px)}
.ri table{width:100%;border-collapse:collapse}
.ri thead tr{background:rgba(255,255,255,0.03);border-bottom:1px solid var(--border)}
.ri thead th{padding:11px 15px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.3px;color:var(--text3);text-align:left;white-space:nowrap}
.ri thead th:not(:first-child){text-align:right}
.ri tbody tr{border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.12s}
.ri tbody tr:last-child{border-bottom:none}
.ri tbody tr:hover{background:rgba(255,255,255,0.02)}
.ri tbody tr.red-row{background:rgba(255,59,92,0.04)}
.ri tbody tr.red-row:hover{background:rgba(255,59,92,0.07)}
.ri tbody tr.amber-row{background:rgba(245,158,11,0.04)}
.ri tbody tr.amber-row:hover{background:rgba(245,158,11,0.07)}
.ri tbody td{padding:14px 15px;font-size:13px}
.ri tbody td:not(:first-child){text-align:right;font-family:monospace;font-size:12px}
.ri .ct{font-weight:600;font-size:13px}.ri .cd{font-size:10px;color:var(--text3);margin-top:2px}
.ri .vm{color:var(--text3)}.ri .dp{color:var(--danger)}.ri .dn{color:var(--warn)}.ri .dz{color:var(--text3)}
.ri .badge{display:inline-flex;align-items:center;font-size:9px;font-weight:700;padding:3px 9px;border-radius:100px;letter-spacing:0.6px;text-transform:uppercase}
.ri .bm{background:rgba(0,219,160,0.1);color:var(--success);border:1px solid rgba(0,219,160,0.25)}
.ri .bdm{background:rgba(59,130,246,0.1);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.ri .bvm{background:rgba(245,158,11,0.1);color:var(--warn);border:1px solid rgba(245,158,11,0.3)}
.ri .bim{background:rgba(255,59,92,0.1);color:var(--danger);border:1px solid rgba(255,59,92,0.25)}
.ri .bd{background:rgba(255,59,92,0.1);color:var(--danger);border:1px solid rgba(255,59,92,0.25)}
.ri .bn{background:rgba(255,255,255,0.04);color:var(--text3);border:1px solid var(--border)}
/* â”€â”€ STATUS FILTER TABS â”€â”€ */
.status-filter-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;padding:14px 18px;background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:12px;}
.sf-label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-right:4px;white-space:nowrap;}
.sf-btn{display:inline-flex;align-items:center;gap:6px;padding:5px 13px;border-radius:100px;border:1px solid var(--border);background:var(--card-bg);color:var(--text2);font-size:11px;font-weight:700;cursor:pointer;transition:all 0.18s;font-family:'Plus Jakarta Sans',sans-serif;letter-spacing:0.3px;}
.sf-btn:hover{border-color:rgba(255,255,255,0.18);color:var(--text);}
.sf-btn.active{color:#fff;}
.sf-btn.sf-all.active{background:rgba(255,107,0,0.18);border-color:rgba(255,107,0,0.45);color:var(--orange);}
.sf-btn.sf-match.active{background:rgba(0,219,160,0.15);border-color:rgba(0,219,160,0.4);color:var(--success);}
.sf-btn.sf-deemed.active{background:rgba(59,130,246,0.15);border-color:rgba(59,130,246,0.4);color:#60a5fa;}
.sf-btn.sf-valmis.active{background:rgba(245,158,11,0.15);border-color:rgba(245,158,11,0.4);color:var(--warn);}
.sf-btn.sf-invmis.active{background:rgba(255,59,92,0.15);border-color:rgba(255,59,92,0.4);color:var(--danger);}
.sf-count{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-size:9px;font-weight:800;background:rgba(255,255,255,0.1);}
/* hide rows per filter */
tr.sf-hidden{display:none!important;}
.ri tfoot tr{background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,107,0,0.2)}
.ri tfoot td{padding:12px 15px;font-weight:700;font-size:12px;font-family:monospace;text-align:right}
.ri tfoot td:first-child{font-family:'Syne',sans-serif;font-size:13px;color:var(--orange);text-align:left}
.ri .notes{margin-top:14px;background:var(--card-bg);border:1px solid var(--border);border-left:3px solid var(--orange);border-radius:var(--radius-sm);padding:14px 18px;font-size:11px;color:var(--text2);line-height:1.9;backdrop-filter:blur(16px)}
.ri .notes strong{color:var(--text)}
@keyframes spin{to{transform:rotate(360deg)}}
.ri .spin{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD SUMMARY CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ri .dashboard-summary{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:14px;margin-bottom:22px;
}
.ri .summary-card{
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:16px;padding:20px 14px;text-align:center;
  backdrop-filter:blur(12px);transition:all 0.22s;
  position:relative;overflow:hidden;cursor:default;
}
.ri .summary-card::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
  border-radius:0 0 16px 16px;opacity:0;transition:opacity 0.22s;
}
.ri .summary-card.s-total::after{background:var(--orange)}
.ri .summary-card.s-match::after{background:var(--success)}
.ri .summary-card.s-mismatch::after{background:var(--danger)}
.ri .summary-card.s-missing::after{background:var(--warn)}
.ri .summary-card:hover{transform:translateY(-4px);box-shadow:0 14px 36px rgba(0,0,0,0.3)}
.ri .summary-card:hover::after{opacity:1}
.ri .sum-icon{font-size:20px;margin-bottom:6px;line-height:1}
.ri .sum-title{font-size:10px;font-weight:700;letter-spacing:1.4px;text-transform:uppercase;color:var(--text3)}
.ri .sum-count{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;line-height:1;margin-top:5px}
.ri .sum-sub{font-size:10px;color:var(--text3);margin-top:3px}
.ri .summary-card.s-total .sum-count{color:var(--orange)}
.ri .summary-card.s-match .sum-count{color:var(--success)}
.ri .summary-card.s-mismatch .sum-count{color:var(--danger)}
.ri .summary-card.s-missing .sum-count{color:var(--warn)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY BREAKDOWN STRIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ri .category-summary{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:10px;margin-bottom:22px;
}
.ri .cat-card{
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:12px;padding:14px 16px;
  transition:all 0.2s;cursor:pointer;
}
.ri .cat-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.25)}
.ri .cat-card .cat-label{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  color:var(--text3);margin-bottom:7px;display:flex;align-items:center;gap:6px;
}
.ri .cat-card strong{
  display:block;font-family:'Syne',sans-serif;font-size:26px;font-weight:800;line-height:1;
}
.ri .cat-card .cat-rows{font-size:10px;color:var(--text3);margin-top:3px}
.ri .cat-card.cc-match{border-left:3px solid var(--success)}
.ri .cat-card.cc-deemed{border-left:3px solid #60a5fa}
.ri .cat-card.cc-invmis{border-left:3px solid var(--danger)}
.ri .cat-card.cc-valmis{border-left:3px solid var(--warn)}
.ri .cat-card.cc-match strong{color:var(--success)}
.ri .cat-card.cc-deemed strong{color:#60a5fa}
.ri .cat-card.cc-invmis strong{color:var(--danger)}
.ri .cat-card.cc-valmis strong{color:var(--warn)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE-LEVEL DETAIL PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ri .inv-detail-section{margin-top:28px}
.ri .inv-detail-hdr{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:14px;
}
.ri .inv-detail-hdr h4{
  font-family:'Syne',sans-serif;font-size:17px;font-weight:800;
}
.ri .inv-detail-hdr h4 span{color:var(--orange)}
.ri .inv-cat-tabs{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;
  padding:10px 14px;background:rgba(255,255,255,0.02);
  border:1px solid var(--border);border-radius:10px;
}
.ri .inv-tab{
  padding:5px 14px;border-radius:100px;border:1px solid var(--border);
  background:transparent;color:var(--text2);font-size:11px;font-weight:700;
  cursor:pointer;transition:all 0.18s;font-family:'Plus Jakarta Sans',sans-serif;
}
.ri .inv-tab:hover{border-color:rgba(255,255,255,0.2);color:var(--text)}
.ri .inv-tab.active{background:rgba(255,107,0,0.18);border-color:rgba(255,107,0,0.45);color:var(--orange)}
.ri .inv-toolbar{
  display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;
}
.ri .inv-search{
  flex:1;min-width:180px;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:8px 13px;font-size:12px;
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;outline:none;
  transition:border-color 0.2s;
}
.ri .inv-search:focus{border-color:var(--orange)}
.ri .inv-search::placeholder{color:var(--text3)}
.ri .inv-count-lbl{font-size:11px;color:var(--text3);white-space:nowrap}
.ri .inv-src-toggle{
  display:flex;gap:4px;background:var(--ink3);border-radius:100px;padding:3px;border:1px solid var(--border);
}
.ri .ist-btn{
  padding:4px 12px;border-radius:100px;border:none;background:transparent;
  color:var(--text2);font-size:10px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  transition:all 0.15s;text-transform:uppercase;letter-spacing:0.5px;
}
.ri .ist-btn.active{background:var(--orange);color:#fff}
.ri .inv-tbl-wrap{
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);overflow:hidden;
  backdrop-filter:blur(16px);max-height:500px;overflow-y:auto;overflow-x:auto;
}
.ri .inv-tbl-wrap::-webkit-scrollbar{width:4px;height:4px}
.ri .inv-tbl-wrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.ri .inv-tbl-wrap table{width:100%;border-collapse:collapse;min-width:780px}
.ri .inv-tbl-wrap thead tr{
  background:var(--ink3);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:5;
}
.ri .inv-tbl-wrap thead th{
  padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;
  letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;
}
.ri .inv-tbl-wrap thead th.r{text-align:right}
.ri .inv-tbl-wrap tbody tr{border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s}
.ri .inv-tbl-wrap tbody tr:hover{background:rgba(255,255,255,0.04)}
.ri .inv-tbl-wrap tbody td{padding:9px 13px;font-size:12px;color:var(--text);white-space:nowrap}
.ri .inv-tbl-wrap tbody td.mono{font-family:monospace;text-align:right}
.ri .inv-tbl-wrap tbody td.good{color:var(--success)}
.ri .inv-tbl-wrap tbody td.bad{color:var(--danger)}
.ri .inv-tbl-wrap tbody td.warn{color:var(--warn)}
.ri .inv-tbl-wrap tbody td.dim{color:var(--text3)}
.ri .inv-empty{padding:40px;text-align:center;font-size:12px;color:var(--text3)}
.ri .inv-src-badge{
  display:inline-flex;align-items:center;font-size:9px;font-weight:700;
  padding:2px 7px;border-radius:100px;text-transform:uppercase;letter-spacing:0.8px;
}
.ri .isb-comp{background:rgba(59,130,246,0.15);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.ri .isb-emg{background:rgba(255,107,0,0.12);color:var(--orange);border:1px solid rgba(255,107,0,0.25)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECONCILIATION LOGIC PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ri .logic-panel{
  margin-top:28px;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);backdrop-filter:blur(16px);overflow:hidden;
}
.ri .logic-panel-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.05);
  cursor:pointer;transition:background 0.18s;user-select:none;
}
.ri .logic-panel-hdr:hover{background:rgba(255,255,255,0.03)}
.ri .logic-panel-hdr h4{
  font-family:'Syne',sans-serif;font-size:14px;font-weight:800;
  display:flex;align-items:center;gap:9px;color:var(--text);
}
.ri .lp-chevron{font-size:16px;color:var(--orange);transition:transform 0.25s;display:inline-block}
.ri .logic-panel-body{padding:20px;display:none}
.ri .logic-panel-body.lp-open{display:block}
.ri .logic-section-title{
  font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  color:var(--text3);margin-bottom:12px;padding-bottom:7px;
  border-bottom:1px solid var(--border);
}
.ri .logic-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px;
}
.ri .logic-cat-block{
  background:rgba(0,0,0,0.25);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:14px;
}
.ri .logic-cat-block h5{
  font-size:11px;font-weight:800;color:var(--orange);
  text-transform:uppercase;letter-spacing:0.8px;
  margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);
}
.ri .logic-rule{
  display:flex;gap:8px;margin-bottom:8px;align-items:flex-start;
  font-size:11px;line-height:1.5;
}
.ri .lr-src{
  flex-shrink:0;font-size:9px;font-weight:700;padding:2px 7px;
  border-radius:100px;text-transform:uppercase;letter-spacing:0.6px;white-space:nowrap;margin-top:1px;
}
.ri .lr-src.lrs-comp{background:rgba(59,130,246,0.15);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.ri .lr-src.lrs-emg{background:rgba(255,107,0,0.12);color:var(--orange);border:1px solid rgba(255,107,0,0.25)}
.ri .lr-text{color:var(--text2)}
.ri .lr-text code{
  background:rgba(255,255,255,0.07);border-radius:4px;
  padding:1px 5px;font-size:10px;font-family:monospace;color:var(--text);
}
.ri .tol-note{
  background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.18);
  border-radius:var(--radius-sm);padding:12px 16px;font-size:11px;
  color:var(--text2);line-height:1.7;margin-bottom:18px;
}
.ri .tol-note strong{color:var(--warn)}
.ri .status-legend{
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
}
.ri .sl-item{
  background:rgba(0,0,0,0.25);border:1px solid var(--border);
  border-radius:10px;padding:13px;
}
.ri .sl-badge{
  font-size:9px;font-weight:700;padding:3px 8px;border-radius:100px;
  display:inline-block;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;
}
.ri .sl-b-m{background:rgba(0,219,160,0.1);color:var(--success);border:1px solid rgba(0,219,160,0.25)}
.ri .sl-b-d{background:rgba(59,130,246,0.1);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.ri .sl-b-v{background:rgba(245,158,11,0.1);color:var(--warn);border:1px solid rgba(245,158,11,0.25)}
.ri .sl-b-i{background:rgba(255,59,92,0.1);color:var(--danger);border:1px solid rgba(255,59,92,0.25)}
.ri .sl-title{font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px}
.ri .sl-desc{font-size:10px;color:var(--text3);line-height:1.5}

@media(max-width:700px){
  .ri .dashboard-summary{grid-template-columns:repeat(2,1fr)}
  .ri .category-summary{grid-template-columns:repeat(2,1fr)}
  .ri .logic-grid{grid-template-columns:1fr}
  .ri .status-legend{grid-template-columns:repeat(2,1fr)}
}

/* â•â• COMING SOON SCREEN â•â• */
.coming-wrap{position:relative;z-index:2;text-align:center;padding:20px}
.cs-badge{
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.25);
  border-radius:100px;padding:6px 16px;
  font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--warn);margin-bottom:24px;
}
.cs-icon-wrap{
  width:90px;height:90px;border-radius:24px;
  background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));
  border:1px solid rgba(245,158,11,0.2);
  display:flex;align-items:center;justify-content:center;
  font-size:42px;margin:0 auto 24px;
}
.coming-wrap h3{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;letter-spacing:-1px;margin-bottom:10px}
.coming-wrap p{color:var(--text2);font-size:14px;max-width:320px;margin:0 auto 28px;line-height:1.6}

/* â•â• RESPONSIVE â•â• */
@media(max-width:660px){
  .option-grid{flex-direction:column;align-items:center}
  .option-card{min-width:280px;max-width:90vw}
  .ri .upload-grid{grid-template-columns:1fr}
  .ri .divider{flex-direction:row;height:36px}
  .ri .div-line{flex:1;height:1px;width:auto}
  .land-title{letter-spacing:-1.5px}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN â€” LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen" style="
  display:flex;justify-content:center;align-items:center;
  height:100vh;width:100vw;
  background:linear-gradient(135deg,#07090f 0%,#161a24 100%);
  position:fixed;inset:0;z-index:99999;
  font-family:'Inter',sans-serif;
">
  <div style="
    width:420px;max-width:94vw;padding:44px 40px;
    background:#fff;border-radius:20px;
    box-shadow:0 32px 80px rgba(0,0,0,0.4);
  ">
    <div style="text-align:center;margin-bottom:30px;">
      <div style="font-size:36px;margin-bottom:8px;">ğŸ¤–</div>
      <h2 style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#111;margin-bottom:4px;">Ease My GST</h2>
      <p style="color:#888;font-size:13px;">Internal Operations Platform</p>
    </div>
    <div style="margin-bottom:12px;">
      <label style="font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.8px;display:block;margin-bottom:6px;">User ID</label>
      <input id="loginUser" placeholder="Enter your user ID"
        onkeydown="if(event.key==='Enter')login()"
        style="width:100%;padding:12px 14px;border:1.5px solid #e5e5e5;border-radius:10px;font-family:'Inter',sans-serif;font-size:14px;outline:none;box-sizing:border-box;transition:border-color 0.2s;"
        onfocus="this.style.borderColor='#ff6b00'" onblur="this.style.borderColor='#e5e5e5'">
    </div>
    <div style="margin-bottom:20px;">
      <label style="font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.8px;display:block;margin-bottom:6px;">Password</label>
      <input id="loginPass" type="password" placeholder="Enter your password"
        onkeydown="if(event.key==='Enter')login()"
        style="width:100%;padding:12px 14px;border:1.5px solid #e5e5e5;border-radius:10px;font-family:'Inter',sans-serif;font-size:14px;outline:none;box-sizing:border-box;transition:border-color 0.2s;"
        onfocus="this.style.borderColor='#ff6b00'" onblur="this.style.borderColor='#e5e5e5'">
    </div>
    <button onclick="login()" style="
      width:100%;padding:13px;background:linear-gradient(135deg,#ff6b00,#ff4000);
      color:#fff;border:none;border-radius:10px;font-family:'Inter',sans-serif;
      font-size:15px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 20px rgba(255,107,0,0.35);
      transition:transform 0.2s,box-shadow 0.2s;
    " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 28px rgba(255,107,0,0.5)'"
       onmouseout="this.style.transform='';this.style.boxShadow='0 6px 20px rgba(255,107,0,0.35)'">
      Login â†’
    </button>
    <div id="loginError" style="color:#ff3b5c;font-size:13px;text-align:center;margin-top:10px;min-height:18px;"></div>
    <p style="text-align:center;margin-top:18px;font-size:13px;color:#888;">
      New user? <a href="#" onclick="showSignup();return false;" style="color:#ff6b00;font-weight:700;text-decoration:none;">Sign Up</a>
    </p>
    <p style="text-align:center;margin-top:10px;font-size:11px;color:#ccc;">
      ğŸ’¡ Default admin: ID <strong>admin</strong> / Pass <strong>admin123</strong>
    </p>
    <button onclick="navigate('screen-faq-language')" style="
      width:100%;margin-top:12px;padding:10px;
      background:transparent;border:1.5px solid #e5e5e5;
      border-radius:10px;font-family:'Inter',sans-serif;
      font-size:12px;font-weight:600;cursor:pointer;color:#888;
      transition:all 0.2s;
    " onmouseover="this.style.borderColor='#ff6b00';this.style.color='#ff6b00'" onmouseout="this.style.borderColor='#e5e5e5';this.style.color='#888'">
      â† Back to Public FAQs
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN â€” SIGNUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="signupScreen" style="
  display:none;justify-content:center;align-items:center;
  height:100vh;width:100vw;
  background:linear-gradient(135deg,#07090f 0%,#161a24 100%);
  position:fixed;inset:0;z-index:99999;
  font-family:'Inter',sans-serif;overflow-y:auto;
">
  <div style="
    width:420px;max-width:94vw;padding:40px;
    background:#fff;border-radius:20px;
    box-shadow:0 32px 80px rgba(0,0,0,0.4);
    margin:20px auto;
  ">
    <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:30px;margin-bottom:6px;">âœ¨</div>
      <h2 style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#111;margin-bottom:4px;">Create Account</h2>
      <p style="color:#888;font-size:12px;">Fill all details to register</p>
    </div>
    <style>
      .auth-input { width:100%;padding:11px 14px;border:1.5px solid #e5e5e5;border-radius:10px;font-family:'Inter',sans-serif;font-size:13px;outline:none;box-sizing:border-box;margin-bottom:11px;transition:border-color 0.2s; }
      .auth-input:focus { border-color:#ff6b00; }
      .auth-label { font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.8px;display:block;margin-bottom:5px; }
    </style>
    <label class="auth-label">First Name</label>
    <input id="firstName" class="auth-input" placeholder="First name">
    <label class="auth-label">Last Name</label>
    <input id="lastName" class="auth-input" placeholder="Last name">
    <label class="auth-label">Gmail Account</label>
    <input id="gmail" class="auth-input" placeholder="yourname@gmail.com" type="email">
    <label class="auth-label">User ID</label>
    <input id="newUser" class="auth-input" placeholder="Choose a user ID (type 'admin' for admin role)">
    <label class="auth-label">Password</label>
    <input id="newPass" class="auth-input" placeholder="Create a password" type="password">
    <button onclick="signup()" style="
      width:100%;padding:13px;background:linear-gradient(135deg,#ff6b00,#ff4000);
      color:#fff;border:none;border-radius:10px;font-family:'Inter',sans-serif;
      font-size:14px;font-weight:700;cursor:pointer;margin-top:6px;
      box-shadow:0 6px 20px rgba(255,107,0,0.3);
    ">Register âœ…</button>
    <button onclick="backToLogin()" style="
      width:100%;padding:11px;background:#f5f5f5;border:1.5px solid #e5e5e5;
      border-radius:10px;font-family:'Inter',sans-serif;font-size:13px;
      font-weight:600;cursor:pointer;margin-top:8px;color:#555;
    ">â† Back to Login</button>
    <div id="signupMsg" style="color:#00dba0;font-size:13px;text-align:center;margin-top:10px;min-height:18px;"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp" style="display:none;">

<!-- CURTAIN -->
<div id="curtain"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 1 â€” LANDING â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-landing">
  <div class="land-content">

    <div class="brand-pill">
      <div class="brand-pill-dot"></div>
      TaxBot Intelligence Platform
    </div>

    <h1 class="land-title">Your Smart<br><span>GST &amp; E-Doc</span><br>Partner</h1>
    <p class="land-sub-title">AI-powered reconciliation, compliance automation and e-document management â€” all in one place.</p>

    <!-- BOT SCENE -->
    <div class="bot-scene">

      <!-- Speech Bubble -->
      <div class="speech-bubble" id="speech-bubble">
        Hello! How can I<br>help you today? ğŸ‘‹
      </div>

      <!-- 3D Robot SVG -->
      <div class="robot-wrap" id="robot-wrap" onclick="startApp()">
        <svg class="robot-svg" viewBox="0 0 130 168" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <!-- Body gradient â€” 3D top-lit -->
            <linearGradient id="bodyGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f8faff"/>
              <stop offset="40%" stop-color="#edf0f8"/>
              <stop offset="100%" stop-color="#d4d9e8"/>
            </linearGradient>
            <!-- Head gradient -->
            <linearGradient id="headGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#f8faff"/>
              <stop offset="60%" stop-color="#edf0f8"/>
              <stop offset="100%" stop-color="#cdd2e2"/>
            </linearGradient>
            <!-- Blue iris gradient -->
            <radialGradient id="eyeGrad" cx="35%" cy="30%" r="65%">
              <stop offset="0%" stop-color="#93c5fd"/>
              <stop offset="45%" stop-color="#3b82f6"/>
              <stop offset="100%" stop-color="#1d4ed8"/>
            </radialGradient>
            <!-- Eye outer glow filter -->
            <filter id="eyeBlur" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="2.5" result="blur"/>
              <feComposite in="SourceGraphic" in2="blur" operator="over"/>
            </filter>
            <!-- Body side shadow -->
            <linearGradient id="sideGrad" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#c0c5d5"/>
              <stop offset="100%" stop-color="#a8afc2"/>
            </linearGradient>
          </defs>

          <!-- â• ANTENNA â• -->
          <line x1="65" y1="18" x2="65" y2="5" stroke="#c0c8d8" stroke-width="2.5" stroke-linecap="round"/>
          <circle cx="65" cy="4" r="4" fill="#3b82f6" class="ant-dot"/>
          <circle cx="65" cy="4" r="7" fill="rgba(59,130,246,0.2)" class="ant-dot"/>

          <!-- â• HEAD â• -->
          <!-- Head 3D side face (right edge) -->
          <rect x="91" y="20" width="5" height="30" rx="3" fill="url(#sideGrad)" opacity="0.6"/>
          <!-- Head main face -->
          <rect x="33" y="18" width="58" height="35" rx="11" fill="url(#headGrad)" stroke="rgba(200,208,225,0.6)" stroke-width="1"/>
          <!-- Head top highlight -->
          <rect x="36" y="18" width="52" height="6" rx="5" fill="rgba(255,255,255,0.6)"/>

          <!-- Neck -->
          <rect x="57" y="53" width="16" height="8" rx="3" fill="#d8dde8" stroke="rgba(200,208,225,0.4)" stroke-width="1"/>

          <!-- â• LEFT EYE â• -->
          <!-- Eye socket -->
          <ellipse cx="49" cy="34" rx="9" ry="9" fill="#0a1628"/>
          <!-- Eye glow halo -->
          <ellipse cx="49" cy="34" rx="9" ry="9" fill="rgba(59,130,246,0.25)" class="eye-glow-anim" filter="url(#eyeBlur)"/>
          <!-- Iris -->
          <circle cx="49" cy="34" r="7" fill="url(#eyeGrad)"/>
          <!-- Pupil -->
          <circle cx="49" cy="34" r="3.5" fill="#001133"/>
          <!-- Primary shine (large) -->
          <ellipse cx="51.5" cy="31" rx="2.5" ry="1.8" fill="rgba(255,255,255,0.92)" transform="rotate(-20,51.5,31)"/>
          <!-- Secondary shine (small) -->
          <circle cx="47.5" cy="37" r="1" fill="rgba(255,255,255,0.55)"/>
          <!-- Blue rim light -->
          <circle cx="49" cy="34" r="7" fill="none" stroke="rgba(96,165,250,0.4)" stroke-width="1"/>

          <!-- â• RIGHT EYE â• -->
          <ellipse cx="81" cy="34" rx="9" ry="9" fill="#0a1628"/>
          <ellipse cx="81" cy="34" rx="9" ry="9" fill="rgba(59,130,246,0.25)" class="eye-glow-anim" filter="url(#eyeBlur)"/>
          <circle cx="81" cy="34" r="7" fill="url(#eyeGrad)"/>
          <circle cx="81" cy="34" r="3.5" fill="#001133"/>
          <ellipse cx="83.5" cy="31" rx="2.5" ry="1.8" fill="rgba(255,255,255,0.92)" transform="rotate(-20,83.5,31)"/>
          <circle cx="79.5" cy="37" r="1" fill="rgba(255,255,255,0.55)"/>
          <circle cx="81" cy="34" r="7" fill="none" stroke="rgba(96,165,250,0.4)" stroke-width="1"/>

          <!-- Smile -->
          <path d="M 52 46 Q 65 54 78 46" stroke="#6b7a96" stroke-width="2.2" fill="none" stroke-linecap="round"/>

          <!-- â• BODY â• -->
          <!-- Body 3D right side -->
          <rect x="93" y="65" width="6" height="50" rx="4" fill="url(#sideGrad)" opacity="0.55"/>
          <!-- Body main -->
          <rect x="22" y="62" width="72" height="54" rx="14" fill="url(#bodyGrad)" stroke="rgba(200,208,225,0.5)" stroke-width="1"/>
          <!-- Body top highlight -->
          <rect x="25" y="62" width="66" height="8" rx="6" fill="rgba(255,255,255,0.5)"/>

          <!-- Orange stripe accent -->
          <rect x="22" y="78" width="72" height="7" fill="rgba(255,107,0,0.1)" rx="0"/>

          <!-- Chest panel -->
          <rect x="36" y="72" width="58" height="36" rx="8" fill="rgba(0,0,0,0.04)" stroke="rgba(180,188,210,0.35)" stroke-width="1"/>

          <!-- Chest center light (orange glowing) -->
          <circle cx="65" cy="82" r="6" fill="rgba(255,107,0,0.15)" class="chest-light"/>
          <circle cx="65" cy="82" r="4" fill="#ff6b00" class="chest-light"/>
          <circle cx="64" cy="81" r="1.5" fill="rgba(255,220,180,0.9)"/>

          <!-- Mini display screen on chest -->
          <rect x="42" y="91" width="46" height="12" rx="4" fill="#0a1628" stroke="rgba(59,130,246,0.3)" stroke-width="1"/>
          <!-- Scanline on screen -->
          <rect x="44" y="96" width="12" height="1.5" rx="1" fill="rgba(59,130,246,0.7)" class="screen-line"/>
          <!-- Screen dots -->
          <circle cx="76" cy="97" r="1.5" fill="rgba(0,219,160,0.8)"/>
          <circle cx="80" cy="97" r="1.5" fill="rgba(255,107,0,0.7)"/>
          <circle cx="84" cy="97" r="1.5" fill="rgba(255,59,92,0.6)"/>

          <!-- Corner bolts -->
          <circle cx="30" cy="70" r="2" fill="#b8bfcf"/>
          <circle cx="100" cy="70" r="2" fill="#b8bfcf"/>
          <circle cx="30" cy="108" r="2" fill="#b8bfcf"/>
          <circle cx="100" cy="108" r="2" fill="#b8bfcf"/>

          <!-- â• LEFT ARM â• -->
          <g class="arm-l-g">
            <rect x="6" y="63" width="16" height="36" rx="8" fill="url(#bodyGrad)" stroke="rgba(200,208,225,0.5)" stroke-width="1"/>
            <rect x="8" y="63" width="12" height="5" rx="4" fill="rgba(255,255,255,0.5)"/>
            <!-- Arm orange stripe -->
            <rect x="6" y="72" width="16" height="3" fill="rgba(255,107,0,0.15)"/>
          </g>

          <!-- â• RIGHT ARM â• -->
          <g class="arm-r-g">
            <rect x="108" y="63" width="16" height="36" rx="8" fill="url(#bodyGrad)" stroke="rgba(200,208,225,0.5)" stroke-width="1"/>
            <rect x="110" y="63" width="12" height="5" rx="4" fill="rgba(255,255,255,0.5)"/>
            <rect x="108" y="72" width="16" height="3" fill="rgba(255,107,0,0.15)"/>
          </g>

          <!-- â• LEFT LEG â• -->
          <g class="leg-l-g">
            <rect x="32" y="115" width="20" height="32" rx="10" fill="url(#bodyGrad)" stroke="rgba(200,208,225,0.5)" stroke-width="1"/>
            <rect x="34" y="115" width="16" height="6" rx="4" fill="rgba(255,255,255,0.4)"/>
            <!-- Foot -->
            <rect x="29" y="141" width="26" height="9" rx="5" fill="#d4d9e8" stroke="rgba(200,208,225,0.4)" stroke-width="1"/>
          </g>

          <!-- â• RIGHT LEG â• -->
          <g class="leg-r-g">
            <rect x="78" y="115" width="20" height="32" rx="10" fill="url(#bodyGrad)" stroke="rgba(200,208,225,0.5)" stroke-width="1"/>
            <rect x="80" y="115" width="16" height="6" rx="4" fill="rgba(255,255,255,0.4)"/>
            <!-- Foot -->
            <rect x="75" y="141" width="26" height="9" rx="5" fill="#d4d9e8" stroke="rgba(200,208,225,0.4)" stroke-width="1"/>
          </g>

        </svg>
      </div>
    </div>

    <button class="cta-btn" onclick="startApp()">
      Get Started
      <span class="cta-arrow">&#8594;</span>
    </button>
    <p class="cta-hint">Click the robot or the button &mdash; no signup required</p>

    <div style="margin-top:20px;">
      <div style="
          display:inline-block;
          padding:14px 22px;
          background:var(--orange-soft);
          border:1px solid var(--orange);
          border-radius:12px;
          cursor:pointer;
          font-weight:600;
          color:var(--orange);
          font-family:'Inter',sans-serif;
          font-size:14px;
          transition:transform 0.2s,box-shadow 0.2s;
      "
      onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(255,107,0,0.2)'"
      onmouseout="this.style.transform='';this.style.boxShadow=''"
      onclick="navigate('screen-faq-language')">
        ğŸ“˜ View FAQs (No Login Required)
      </div>
    </div>

    <!-- â•â• TRACKER SECTION â•â• -->
    <div style="
      margin-top:36px;
      padding:24px 28px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,107,0,0.22);
      border-radius:16px;
      min-width:320px;
      max-width:480px;
      width:100%;
      text-align:left;
      backdrop-filter:blur(12px);
    ">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
        <span style="font-size:22px;">ğŸ“…</span>
        <h3 style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--text);letter-spacing:-0.3px;">Team Saturday Tracker â€” 2026</h3>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1;min-width:140px;">
          <div style="font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Ankit Team</div>
          <button onclick="showSaturday('Ankit')" style="
            background:linear-gradient(135deg,var(--orange),var(--orange3));
            color:#fff;border:none;border-radius:10px;
            padding:9px 16px;font-size:12px;font-weight:700;
            cursor:pointer;font-family:'Inter',sans-serif;
            width:100%;transition:opacity 0.2s;
          " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
            View Upcoming Saturday
          </button>
        </div>
        <div style="flex:1;min-width:140px;">
          <div style="font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Gurdeep Team</div>
          <button onclick="showSaturday('Gurdeep')" style="
            background:rgba(255,107,0,0.12);
            color:var(--orange);border:1px solid rgba(255,107,0,0.35);
            border-radius:10px;padding:9px 16px;font-size:12px;font-weight:700;
            cursor:pointer;font-family:'Inter',sans-serif;
            width:100%;transition:all 0.2s;
          " onmouseover="this.style.background='rgba(255,107,0,0.2)'" onmouseout="this.style.background='rgba(255,107,0,0.12)'">
            View Upcoming Saturday
          </button>
        </div>
      </div>
      <div id="trackerResult" style="
        margin-top:14px;
        font-size:13px;font-weight:600;
        color:var(--success);
        min-height:20px;
        font-family:'Inter',sans-serif;
      "></div>
      <button onclick="viewTrackerLogs()" style="
        margin-top:10px;background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);color:var(--text2);
        border-radius:8px;padding:7px 14px;font-size:11px;font-weight:600;
        cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.2s;
      " onmouseover="this.style.borderColor='rgba(255,107,0,0.4)';this.style.color='#ff6b00'"
         onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='var(--text2)'">
        ğŸ“‹ View Access Logs (Admin Only)
      </button>
    </div>

    <!-- â•â• TRAINING DECK SECTION â•â• -->
    <div style="
      margin-top:16px;
      padding:24px 28px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:16px;
      min-width:320px;
      max-width:480px;
      width:100%;
      text-align:left;
      backdrop-filter:blur(12px);
    ">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
        <span style="font-size:22px;">ğŸ“˜</span>
        <h3 style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--text);letter-spacing:-0.3px;">Training DECK</h3>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button onclick="openTrainingDeck('training_edoc')" style="
          flex:1;min-width:130px;
          background:rgba(59,130,246,0.1);
          color:#60a5fa;border:1px solid rgba(59,130,246,0.3);
          border-radius:10px;padding:10px 14px;font-size:12px;font-weight:700;
          cursor:pointer;font-family:'Inter',sans-serif;
          transition:all 0.2s;
        " onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='rgba(59,130,246,0.1)'">
          ğŸ“„ E-Doc Training
        </button>
        <button onclick="openTrainingDeck('training_gst')" style="
          flex:1;min-width:130px;
          background:rgba(0,219,160,0.08);
          color:var(--success);border:1px solid rgba(0,219,160,0.25);
          border-radius:10px;padding:10px 14px;font-size:12px;font-weight:700;
          cursor:pointer;font-family:'Inter',sans-serif;
          transition:all 0.2s;
        " onmouseover="this.style.background='rgba(0,219,160,0.16)'" onmouseout="this.style.background='rgba(0,219,160,0.08)'">
          ğŸ§¾ GST Training
        </button>
      </div>
      <p style="font-size:11px;color:var(--text3);margin-top:10px;">ğŸ”’ Admin access required to open decks</p>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 2 â€” PRODUCT SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-product">
  <button class="back-btn" onclick="goBack('screen-landing')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-active">Choose Product</span>
      </div>
      <h2>Choose Your <em>Product</em></h2>
      <p>Select the compliance module you want to work with today</p>
    </div>
    <div class="option-grid">

      <div class="option-card" onclick="navigate('screen-edoc')">
        <div class="card-eyebrow">01</div>
        <div class="card-icon-wrap">ğŸ“„</div>
        <div class="card-title">E&#8209;Doc</div>
        <div class="card-desc">E-Invoice generation, E-Way Bill management and electronic document compliance under GST.</div>
        <div class="card-cta">Explore E-Doc <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <div class="option-card" onclick="navigate('screen-gst')">
        <div class="card-eyebrow">02</div>
        <div class="card-icon-wrap">ğŸ§¾</div>
        <div class="card-title">GST</div>
        <div class="card-desc">GSTR-1 filing, GSTR-2B matching and intelligent reconciliation automation for all GST returns.</div>
        <div class="card-cta">Explore GST <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <div class="option-card" onclick="navigate('screen-faq-language')">
        <div class="card-eyebrow">03</div>
        <div class="card-icon-wrap">â“</div>
        <div class="card-title">FAQs</div>
        <div class="card-desc">Browse frequently asked questions on E-Invoice, E-Way Bill and GSTR in English or Hindi.</div>
        <div class="card-cta">Browse FAQs <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 3 â€” E-DOC (fixed: E-Invoice + E-Way Bill) â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-edoc">
  <button class="back-btn" onclick="goBack('screen-product')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-item">E-Doc</span><span class="bc-sep">â€º</span>
        <span class="bc-active">Choose Service</span>
      </div>
      <h2>E-Doc <em>Services</em></h2>
      <p>Need assistance related to which e-document service?</p>
    </div>
    <div class="option-grid">

      <div class="option-card" onclick="navigate('screen-coming','E-Invoice')">
        <div class="card-eyebrow">01</div>
        <div class="card-icon-wrap">ğŸ·ï¸</div>
        <div class="card-title">E&#8209;Invoice</div>
        <div class="card-desc">Generate and validate e-invoices under the GST framework. Auto-fetch IRN from IRP portal with QR code support.</div>
        <div class="cs-chip">Coming Soon</div>
        <div class="card-cta">Open E-Invoice <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <div class="option-card" onclick="navigate('screen-coming','E-Way Bill')">
        <div class="card-eyebrow">02</div>
        <div class="card-icon-wrap">ğŸšš</div>
        <div class="card-title">E&#8209;Way Bill</div>
        <div class="card-desc">Generate, extend and cancel E-Way Bills for goods in transit. Auto-populate Part-B and track vehicle details.</div>
        <div class="cs-chip">Coming Soon</div>
        <div class="card-cta">Open E-Way Bill <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 4 â€” GST MODULES â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-gst">
  <button class="back-btn" onclick="goBack('screen-product')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-item">GST</span><span class="bc-sep">â€º</span>
        <span class="bc-active">Choose Module</span>
      </div>
      <h2>GST <em>Modules</em></h2>
      <p>Select the GST function you need assistance with</p>
    </div>
    <div class="option-grid">

      <div class="option-card" onclick="navigate('screen-coming','GSTR-1 Filing')">
        <div class="card-eyebrow">01</div>
        <div class="card-icon-wrap">ğŸ“‹</div>
        <div class="card-title">GSTR&#8209;1</div>
        <div class="card-desc">Outward supplies return â€” file and manage your monthly or quarterly GSTR-1 with auto-validation.</div>
        <div class="cs-chip">Coming Soon</div>
        <div class="card-cta">Open GSTR-1 <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <div class="option-card" onclick="navigate('screen-coming','GSTR-2B Matching')">
        <div class="card-eyebrow">02</div>
        <div class="card-icon-wrap">ğŸ“Š</div>
        <div class="card-title">GSTR&#8209;2B</div>
        <div class="card-desc">Auto-drafted ITC statement â€” reconcile your purchase register against GSTR-2B with mismatch reports.</div>
        <div class="cs-chip">Coming Soon</div>
        <div class="card-cta">Open GSTR-2B <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <div class="option-card" onclick="navigate('screen-recon')">
        <div class="card-eyebrow">03</div>
        <div class="card-icon-wrap">ğŸ”</div>
        <div class="card-title">Reconciliation</div>
        <div class="card-desc">Auto-reconcile EaseMyGST &amp; Ginesys Composite data across all 8 GSTR-1 categories instantly.</div>
        <div class="card-cta">Open Tool <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 5 â€” RECONCILIATION â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-recon" style="flex-direction:column;align-items:stretch;justify-content:flex-start;overflow-y:auto;padding:0;">
  <div class="recon-topbar">
    <div class="rtb-logo">
      <div class="rtb-icon">G1</div>
      <div>
        <h3>GSTR-1 Reconciliation</h3>
        <p>EaseMyGST &times; Ginesys Composite &mdash; Exact Column Engine v4.0</p>
      </div>
    </div>
    <button class="back-btn" style="position:static" onclick="goBack('screen-gst')">
      <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      Back to GST
    </button>
  </div>

  <div class="ri">
    <div class="hero">
      <h2>Precise. Automatic. <span>Reconciled.</span></h2>
      <p>Uses exact column names from both files. Exports a full working Excel with matched rows and filter logic per category.</p>
    </div>

    <div class="upload-grid">
      <div class="ucard" id="card-emg">
        <div class="src-tag">EaseMyGST â€” GSTR-1 Sync File</div>
        <div class="dropzone" id="zone-emg">
          <input type="file" accept=".xlsx,.xls,.csv" id="file-emg" onchange="loadFile('emg',this)">
          <div class="dz-icon">ğŸ“„</div>
          <div class="dz-title">EMG Sync File</div>
          <div class="dz-sub">Drag &amp; drop here, or use Browse below</div>
          <div class="dz-fmt">.xlsx &middot; .xls &middot; .csv</div>
        </div>
        <button class="browse-btn" onclick="document.getElementById('file-emg').click()">ğŸ“‚ Browse &amp; Select EMG File</button>
        <div class="upload-progress" id="up-emg">
          <div class="up-label">Uploadingâ€¦ <span id="up-pct-emg">0%</span></div>
          <div class="up-track"><div class="up-fill" id="up-fill-emg"></div></div>
          <div class="up-status" id="up-status-emg">Reading fileâ€¦</div>
        </div>
        <div class="upload-success" id="us-emg">
          <div class="us-icon">âœ…</div>
          <div class="us-text" id="us-text-emg"></div>
          <div class="us-meta" id="us-meta-emg"></div>
        </div>
        <div class="finfo" id="fi-emg">
          <div class="fdot"></div>
          <div class="fname" id="fn-emg"></div>
          <div class="fmeta" id="fm-emg"></div>
          <button class="fclear" onclick="clearF('emg')">&times;</button>
        </div>
        <div class="debug-box" id="db-emg">
          <div class="debug-title">ğŸ” EMG Column Detection</div>
          <div class="debug-grid" id="dg-emg"></div>
        </div>
      </div>
      <div class="divider"><div class="div-line"></div><div class="div-vs">VS</div><div class="div-line"></div></div>
      <div class="ucard" id="card-composite">
        <div class="src-tag">Ginesys â€” Composite File</div>
        <div class="dropzone" id="zone-composite">
          <input type="file" accept=".xlsx,.xls,.csv" id="file-composite" onchange="loadFile('composite',this)">
          <div class="dz-icon">ğŸ“Š</div>
          <div class="dz-title">Composite Excel File</div>
          <div class="dz-sub">Drag &amp; drop here, or use Browse below</div>
          <div class="dz-fmt">.xlsx &middot; .xls &middot; .csv</div>
        </div>
        <button class="browse-btn" onclick="document.getElementById('file-composite').click()">ğŸ“‚ Browse &amp; Select Composite File</button>
        <div class="upload-progress" id="up-composite">
          <div class="up-label">Uploadingâ€¦ <span id="up-pct-composite">0%</span></div>
          <div class="up-track"><div class="up-fill" id="up-fill-composite"></div></div>
          <div class="up-status" id="up-status-composite">Reading fileâ€¦</div>
        </div>
        <div class="upload-success" id="us-composite">
          <div class="us-icon">âœ…</div>
          <div class="us-text" id="us-text-composite"></div>
          <div class="us-meta" id="us-meta-composite"></div>
        </div>
        <div class="finfo" id="fi-composite">
          <div class="fdot"></div>
          <div class="fname" id="fn-composite"></div>
          <div class="fmeta" id="fm-composite"></div>
          <button class="fclear" onclick="clearF('composite')">&times;</button>
        </div>
        <div class="debug-box" id="db-composite">
          <div class="debug-title">ğŸ” Composite Column Detection</div>
          <div class="debug-grid" id="dg-composite"></div>
        </div>
      </div>
    </div>

    <div class="err-bar" id="err-bar"></div>

    <!-- â•â• MATCHING RULES BOX â•â• -->
    <div class="matching-rules-box">
      <div class="mrb-header" onclick="toggleMatchingRules(this)">
        <h3>ğŸ“‹ Matching Rules &amp; Filter Logic</h3>
        <span class="mrb-toggle-icon">â–¼</span>
      </div>
      <div class="mrb-body">
        <div class="mrb-notes">
          <h4>âš ï¸ Important Notes</h4>
          <ul>
            <li>Only <strong>Posted Data</strong> in EMG â€” consider only <strong>Posted</strong> and <strong>Blank</strong> in <strong>DOCUMENT_STATUS</strong> from Composite.</li>
            <li><strong>ENTRY_DATE</strong> in Composite must match the same <strong>Month</strong> as EMG Return Period.</li>
            <li>Checking: <strong>Taxable Value, IGST, CGST, SGST, and Cess Amount</strong> only.</li>
          </ul>
        </div>
        <div class="mrb-filters">
          <h4>ğŸ” Category Filters Applied</h4>
          <div class="mrb-grid">
            <div class="mrb-card mrb-b2b">
              <div class="mrb-cat-badge">B2B RI</div>
              <div class="mrb-source"><span class="src-label emg-label">EMG</span> B2B + RI</div>
              <div class="mrb-vs">vs</div>
              <div class="mrb-source"><span class="src-label comp-label">Composite</span> OUTWARD SUPPLY, Other OUTWARD SUPPLY <em>+ GSTIN present</em></div>
            </div>
            <div class="mrb-card mrb-cdn">
              <div class="mrb-cat-badge">B2B CDN</div>
              <div class="mrb-source"><span class="src-label emg-label">EMG</span> B2B + C</div>
              <div class="mrb-vs">vs</div>
              <div class="mrb-source"><span class="src-label comp-label">Composite</span> SALES CREDIT NOTE <em>+ GSTIN present</em></div>
            </div>
            <div class="mrb-card mrb-b2cs">
              <div class="mrb-cat-badge">B2CS</div>
              <div class="mrb-source"><span class="src-label emg-label">EMG</span> B2CS, RI âˆ’ C = Net</div>
              <div class="mrb-vs">vs</div>
              <div class="mrb-source"><span class="src-label comp-label">Composite</span> OUTWARD SUPPLY + GSTIN blank <em>â€” Net_Amt â‰¤ â‚¹1,00,000 OR Local</em></div>
            </div>
            <div class="mrb-card mrb-b2cl">
              <div class="mrb-cat-badge">B2CL</div>
              <div class="mrb-source"><span class="src-label emg-label">EMG</span> B2CL, RI âˆ’ C = Net</div>
              <div class="mrb-vs">vs</div>
              <div class="mrb-source"><span class="src-label comp-label">Composite</span> OUTWARD SUPPLY + GSTIN blank + Net_Amt &gt; â‚¹1,00,000 AND Inter State</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="run-section">
      <button class="btn-run" id="btn-run" disabled onclick="runRecon()">âš¡ Run Reconciliation</button>
      <div class="run-hint" id="run-hint">Upload both files to begin</div>
      <div class="prog-wrap" id="prog-wrap">
        <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
        <div class="prog-lbl" id="prog-lbl">Starting... (large files may take 10â€“30s)</div>
      </div>
    </div>

    <div class="results" id="results">

      <!-- â•â• RESULTS HEADER â•â• -->
      <div class="res-hdr">
        <h3>Reconciliation <span>Results</span></h3>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="chips">
            <div class="chip g"><div class="dot"></div><span id="ch-m">0 Matched</span></div>
            <div class="chip r"><div class="dot"></div><span id="ch-d">0 Differences</span></div>
          </div>
          <button class="btn-xl" onclick="exportExcel()">â†“ Export Working Excel</button>
        </div>
      </div>

      <!-- â•â• DASHBOARD SUMMARY CARDS â•â• -->
      <div class="dashboard-summary">
        <div class="summary-card s-total">
          <div class="sum-icon">ğŸ“Š</div>
          <div class="sum-title">Total Categories</div>
          <div class="sum-count" id="dashTotal">0</div>
          <div class="sum-sub">reconciled</div>
        </div>
        <div class="summary-card s-match">
          <div class="sum-icon">âœ…</div>
          <div class="sum-title">Matched</div>
          <div class="sum-count" id="dashMatch">0</div>
          <div class="sum-sub">match + deemed</div>
        </div>
        <div class="summary-card s-mismatch">
          <div class="sum-icon">âš ï¸</div>
          <div class="sum-title">Mismatched</div>
          <div class="sum-count" id="dashMismatch">0</div>
          <div class="sum-sub">value + invoice</div>
        </div>
        <div class="summary-card s-missing">
          <div class="sum-icon">ğŸ”´</div>
          <div class="sum-title">Invoice Mismatch</div>
          <div class="sum-count" id="dashMissing">0</div>
          <div class="sum-sub">row count differs</div>
        </div>
      </div>

      <!-- â•â• INVOICE MATCH SUMMARY BANNER â•â• -->
      <div id="inv-match-banner" style="display:none;margin:16px 0;padding:18px 24px;background:rgba(0,0,0,0.35);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(16px);">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--text);margin-bottom:12px;">
          ğŸ“‹ Invoice Match Summary â€” All Categories
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;" id="inv-match-grid"></div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);" id="inv-match-total"></div>
      </div>

      <!-- â•â• CATEGORY BREAKDOWN STRIP â•â• -->
      <div class="category-summary">
        <div class="cat-card cc-match" onclick="scrollToInvDetail('MATCH')">
          <div class="cat-label">âœ“ Match</div>
          <strong id="catMatch">0</strong>
          <div class="cat-rows" id="catMatchRows">0 rows</div>
        </div>
        <div class="cat-card cc-deemed" onclick="scrollToInvDetail('DEEMED MATCH')">
          <div class="cat-label">~ Deemed Match</div>
          <strong id="catDeemed">0</strong>
          <div class="cat-rows" id="catDeemedRows">0 rows</div>
        </div>
        <div class="cat-card cc-invmis" onclick="scrollToInvDetail('INVOICE MISMATCH')">
          <div class="cat-label">âœ— Invoice Mismatch</div>
          <strong id="catInvMis">0</strong>
          <div class="cat-rows" id="catInvMisRows">0 rows</div>
        </div>
        <div class="cat-card cc-valmis" onclick="scrollToInvDetail('VALUE MISMATCH')">
          <div class="cat-label">âš  Value Mismatch</div>
          <strong id="catValMis">0</strong>
          <div class="cat-rows" id="catValMisRows">0 rows</div>
        </div>
      </div>

      <!-- â•â• STATUS FILTER TABS â•â• -->
      <div class="status-filter-bar" id="status-filter-bar">
        <span class="sf-label">Filter:</span>
        <button class="sf-btn sf-all active" onclick="applyStatusFilter('ALL',this)">ğŸ”² All <span class="sf-count" id="sf-cnt-all">0</span></button>
        <button class="sf-btn sf-match" onclick="applyStatusFilter('MATCH',this)">âœ“ Match <span class="sf-count" id="sf-cnt-match">0</span></button>
        <button class="sf-btn sf-deemed" onclick="applyStatusFilter('DEEMED MATCH',this)">~ Deemed Match <span class="sf-count" id="sf-cnt-deemed">0</span></button>
        <button class="sf-btn sf-valmis" onclick="applyStatusFilter('VALUE MISMATCH',this)">âš  Value Mismatch <span class="sf-count" id="sf-cnt-valmis">0</span></button>
        <button class="sf-btn sf-invmis" onclick="applyStatusFilter('INVOICE MISMATCH',this)">âœ— Invoice Mismatch <span class="sf-count" id="sf-cnt-invmis">0</span></button>
      </div>

      <!-- â•â• CATEGORY-LEVEL TABLE â•â• -->
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Category</th>
            <th>Composite Taxable Value (â‚¹)</th>
            <th>EMG Taxable Value (â‚¹)</th>
            <th>Difference (â‚¹)</th>
            <th>Status</th>
          </tr></thead>
          <tbody id="res-body"></tbody>
          <tfoot id="res-foot"></tfoot>
        </table>
      </div>

      <!-- â•â• INVOICE-LEVEL DETAIL PANEL â•â• -->
      <div class="inv-detail-section" id="inv-detail-section">
        <div class="inv-detail-hdr">
          <h4>Invoice-Level <span>Detail</span></h4>
          <div class="inv-src-toggle">
            <button class="ist-btn active" id="ist-comp" onclick="switchInvSrc('comp')">Composite</button>
            <button class="ist-btn" id="ist-emg" onclick="switchInvSrc('emg')">EMG</button>
            <button class="ist-btn" id="ist-both" onclick="switchInvSrc('both')">Both</button>
          </div>
        </div>

        <!-- Category tabs -->
        <div class="inv-cat-tabs" id="inv-cat-tabs"></div>

        <!-- Search + count -->
        <div class="inv-toolbar">
          <input class="inv-search" id="inv-search" type="text" placeholder="ğŸ”  Search GSTIN, invoice no, valueâ€¦" oninput="filterInvTable()">
          <div class="inv-count-lbl" id="inv-count-lbl">0 rows</div>
        </div>

        <!-- Invoice table -->
        <div class="inv-tbl-wrap" id="inv-tbl-wrap">
          <div class="inv-empty">Select a category above to view invoice-level rows.</div>
        </div>
      </div>

      <!-- â•â• LOGIC PANEL â•â• -->
      <div class="logic-panel" id="logic-panel">
        <div class="logic-panel-hdr" onclick="toggleLogicPanel()">
          <h4>ğŸ§® Reconciliation Logic <span style="font-size:11px;font-weight:400;color:var(--text3);margin-left:6px">â€” how every category is matched</span></h4>
          <span class="lp-chevron" id="lp-chevron">â–¼</span>
        </div>
        <div class="logic-panel-body" id="logic-panel-body">

          <div class="tol-note">
            <strong>Tolerance Rules:</strong> &nbsp;
            Difference â‰¤ â‚¹0.01 â†’ <strong style="color:var(--success)">MATCH</strong> &nbsp;|&nbsp;
            â‚¹0.01 â€“ â‚¹1.00 â†’ <strong style="color:#60a5fa">DEEMED MATCH</strong> (rounding) &nbsp;|&nbsp;
            &gt; â‚¹1.00, same row count â†’ <strong style="color:var(--warn)">VALUE MISMATCH</strong> &nbsp;|&nbsp;
            Row count differs â†’ <strong style="color:var(--danger)">INVOICE MISMATCH</strong>
          </div>

          <div class="logic-section-title">Category Filter Logic</div>
          <div class="logic-grid">

            <div class="logic-cat-block">
              <h5>B2B â€“ Regular Invoices</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><code>GST_APPLICABILITY</code> contains <code>outward supply</code> or <code>other outward</code> + <code>DOCUMENT_STATUS</code> = posted + <code>CP_GSTIN_NO</code> not blank</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Invoice type</code> = <code>B2B</code> + <code>Document Type</code> = <code>RI</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>B2B â€“ Credit / Debit Notes</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><strong>(a)</strong> <code>GST_APPLICABILITY</code> âŠ‡ <code>sales credit</code> / <code>sales debit</code> / <code>credit note</code> / <code>debit note</code> + posted + <code>CP_GSTIN_NO</code> not blank</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><strong>(b)</strong> <code>GST_APPLICABILITY</code> âŠ‡ <code>outward supply</code> / <code>other outward</code> + posted + <code>CP_GSTIN_NO</code> not blank + <code>TAXABLE_AMOUNT &lt; 0</code> (negative = return/reversal)</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Invoice type</code> = <code>B2B</code> + <code>Document Type</code> = <code>C</code> or <code>D</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>B2CS</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><code>GST_APPLICABILITY</code> contains <code>outward supply</code> + posted + <code>CP_GSTIN_NO</code> is blank (unregistered buyer)</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Invoice type</code> = <code>B2CS</code> + <code>Document Type</code> = <code>RI</code> or <code>C</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>Export Invoices</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><code>outward supply</code> + posted + <code>ENTRY_TRADETYPE</code> contains <code>export</code> or <code>import</code></span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Invoice type</code> = <code>EXWOP</code> or <code>EXWP</code> + <code>Document Type</code> = <code>RI</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>Export Credit Notes</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text"><code>sales credit note</code> or <code>credit note</code> + posted + <code>ENTRY_TRADETYPE</code> contains export/import</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Invoice type</code> = <code>EXWOP</code> / <code>EXWP</code> + <code>Document Type</code> = <code>C</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>Non-GST</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text">Outward applicability + <code>HSN_SAC_CODE</code> = <code>NONGSTIN</code> + all tax rates = 0</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Tax applicability</code> = <code>N</code> + <code>Document Type</code> = <code>RI</code> or <code>C</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>Exempt</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text">Outward applicability + all rates = 0 + <code>CP_GST_REGISTRATION_STATUS</code> contains <code>exempt</code> or = <code>E</code></span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Tax applicability</code> = <code>E</code> + <code>Document Type</code> = <code>RI</code> or <code>C</code></span>
              </div>
            </div>

            <div class="logic-cat-block">
              <h5>Nil Rated</h5>
              <div class="logic-rule">
                <span class="lr-src lrs-comp">Comp</span>
                <span class="lr-text" style="color:var(--text3);font-style:italic">No Composite filter â€” EMG-only category</span>
              </div>
              <div class="logic-rule">
                <span class="lr-src lrs-emg">EMG</span>
                <span class="lr-text"><code>Tax applicability</code> = <code>L</code> + <code>Document Type</code> = <code>RI</code> or <code>C</code></span>
              </div>
            </div>

          </div><!-- /logic-grid -->

          <div class="logic-section-title">Status Classification</div>
          <div class="status-legend">
            <div class="sl-item">
              <span class="sl-badge sl-b-m">âœ“ MATCH</span>
              <div class="sl-title">Perfect Match</div>
              <div class="sl-desc">Row count equal on both sides AND value difference â‰¤ â‚¹0.01 (floating-point safe)</div>
            </div>
            <div class="sl-item">
              <span class="sl-badge sl-b-d">~ DEEMED MATCH</span>
              <div class="sl-title">Rounding Tolerance</div>
              <div class="sl-desc">Row count equal + difference &gt; â‚¹0.01 but â‰¤ â‚¹1.00 â€” acceptable rounding variance</div>
            </div>
            <div class="sl-item">
              <span class="sl-badge sl-b-v">âš  VALUE MISMATCH</span>
              <div class="sl-title">Amount Differs</div>
              <div class="sl-desc">Row counts match but taxable value difference &gt; â‚¹1.00 â€” needs investigation</div>
            </div>
            <div class="sl-item">
              <span class="sl-badge sl-b-i">âœ— INVOICE MISMATCH</span>
              <div class="sl-title">Row Count Differs</div>
              <div class="sl-desc">One side has more invoices than the other â€” entries missing or duplicated</div>
            </div>
          </div>

          <div style="margin-top:18px;padding:12px 16px;background:rgba(255,255,255,0.025);border-radius:var(--radius-sm);font-size:11px;color:var(--text3);line-height:1.7">
            <strong style="color:var(--text2)">Document Status filter (Composite):</strong>
            Rows where <code style="background:rgba(255,255,255,0.07);padding:1px 5px;border-radius:4px;font-size:10px">DOCUMENT_STATUS</code> is blank, <code style="background:rgba(255,255,255,0.07);padding:1px 5px;border-radius:4px;font-size:10px">posted</code>, <code style="background:rgba(255,255,255,0.07);padding:1px 5px;border-radius:4px;font-size:10px">approved</code>, <code style="background:rgba(255,255,255,0.07);padding:1px 5px;border-radius:4px;font-size:10px">confirmed</code>, or null are treated as posted.
            Rows with other statuses (e.g. <em>draft</em>, <em>cancelled</em>) are excluded from reconciliation.
          </div>

        </div><!-- /logic-panel-body -->
      </div><!-- /logic-panel -->

      <div class="notes" id="notes"></div>

      <!-- MISMATCH DRILL-DOWN PANEL -->
      <div id="mismatch-drilldown" style="display:none;margin-top:32px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
          <h3 style="font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--text);">
            ğŸ” Mismatch <span style="color:var(--danger)">Drill-Down</span>
          </h3>
          <span style="font-size:11px;color:var(--text3);background:rgba(255,59,92,0.08);border:1px solid rgba(255,59,92,0.2);border-radius:100px;padding:3px 12px;">
            Invoice-level cause analysis
          </span>
        </div>
        <p style="font-size:12px;color:var(--text2);margin-bottom:18px;line-height:1.7;">
          For every <strong style="color:var(--danger)">Invoice Mismatch</strong> and <strong style="color:var(--warn)">Value Mismatch</strong> category,
          the table below shows <em>exactly which lines</em> in Composite and EMG are causing the discrepancy â€”
          including rows present in only one source and rows where taxable value differs.
        </p>
        <div id="dd-cat-tabs" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;"></div>
        <div id="dd-tbl-wrap" style="background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;backdrop-filter:blur(16px);max-height:600px;overflow-y:auto;overflow-x:auto;">
          <div style="padding:40px;text-align:center;font-size:12px;color:var(--text3);">Select a mismatched category above.</div>
        </div>
        <div id="dd-summary" style="margin-top:12px;padding:12px 16px;background:rgba(255,107,0,0.04);border:1px solid rgba(255,107,0,0.15);border-radius:10px;font-size:11.5px;color:var(--text2);line-height:1.8;display:none;"></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN â€” FAQ LANGUAGE SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-faq-language">
  <button class="back-btn" onclick="goBack('screen-product')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-item">FAQs</span><span class="bc-sep">â€º</span>
        <span class="bc-active">Language</span>
      </div>
      <h2>Select <em>Language</em></h2>
      <p>Please choose your preferred language</p>
    </div>
    <div class="option-grid">
      <div class="option-card" onclick="setLanguage('en')">
        <div class="card-eyebrow">01</div>
        <div class="card-icon-wrap">ğŸ‡¬ğŸ‡§</div>
        <div class="card-title">English</div>
        <div class="card-desc">Browse all GST FAQs in English.</div>
        <div class="card-cta">Select English <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="option-card" onclick="setLanguage('hi')">
        <div class="card-eyebrow">02</div>
        <div class="card-icon-wrap">ğŸ‡®ğŸ‡³</div>
        <div class="card-title">à¤¹à¤¿à¤‚à¤¦à¥€</div>
        <div class="card-desc">GST à¤¸à¥‡ à¤œà¥à¤¡à¤¼à¥‡ à¤¸à¤­à¥€ à¤¸à¤µà¤¾à¤² à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¦à¥‡à¤–à¥‡à¤‚à¥¤</div>
        <div class="card-cta">à¤¹à¤¿à¤‚à¤¦à¥€ à¤šà¥à¤¨à¥‡à¤‚ <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN â€” FAQ CATEGORY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-faq-category">
  <button class="back-btn" onclick="goBack('screen-faq-language')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-item">FAQs</span><span class="bc-sep">â€º</span>
        <span class="bc-active">Category</span>
      </div>
      <h2>Select <em>Service</em></h2>
      <p>Which GST service do you need answers about?</p>
    </div>
    <div class="option-grid">
      <div class="option-card" onclick="loadFAQ('einvoice')">
        <div class="card-eyebrow">01</div>
        <div class="card-icon-wrap">ğŸ·ï¸</div>
        <div class="card-title">E-Invoice</div>
        <div class="card-desc">IRN generation, IRP portal, time limits and more.</div>
        <div class="card-cta">View FAQs <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="option-card" onclick="loadFAQ('eway')">
        <div class="card-eyebrow">02</div>
        <div class="card-icon-wrap">ğŸšš</div>
        <div class="card-title">E-Way Bill</div>
        <div class="card-desc">Generation, cancellation, validity and Part-B updates.</div>
        <div class="card-cta">View FAQs <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
      <div class="option-card" onclick="loadFAQ('gstr')">
        <div class="card-eyebrow">03</div>
        <div class="card-icon-wrap">ğŸ“Š</div>
        <div class="card-title">GSTR</div>
        <div class="card-desc">GSTR-1, GSTR-2B, ITC statements and return filing.</div>
        <div class="card-cta">View FAQs <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN â€” FAQ CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-faq-content">
  <button class="back-btn" onclick="goBack('screen-faq-category')">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div style="position:relative;z-index:2;width:100%;display:flex;flex-direction:column;align-items:center;">
    <div class="screen-hdr">
      <div class="breadcrumb">
        <span class="bc-item">Home</span><span class="bc-sep">â€º</span>
        <span class="bc-item">FAQs</span><span class="bc-sep">â€º</span>
        <span class="bc-active" id="faq-breadcrumb-label">Category</span>
      </div>
      <h2 id="faq-content-title"><em>FAQs</em></h2>
    </div>
    <div id="faq-container" style="max-width:700px;width:100%;max-height:60vh;overflow-y:auto;padding-right:4px;"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 6 â€” COMING SOON â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen menu-screen" id="screen-coming">
  <button class="back-btn" onclick="goBack()">
    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    Back
  </button>
  <div class="coming-wrap">
    <div class="cs-badge">ğŸ”§ Under Development</div>
    <div class="cs-icon-wrap">ğŸš€</div>
    <h3 id="coming-title">Coming Soon</h3>
    <p>This module is being built with care and will be available shortly. Stay tuned!</p>
    <button class="cta-btn" style="font-size:13px;padding:13px 32px" onclick="goBack()">
      Go Back <span class="cta-arrow">&#8592;</span>
    </button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var navHistory = ['screen-landing'];
var currentScreen = 'screen-landing';
var isTransitioning = false;

function updateTopbarBack() {
  var btn = document.getElementById('topbar-back-btn');
  if (!btn) return;
  // Show back button on all screens except landing
  if (currentScreen === 'screen-landing') {
    btn.style.display = 'none';
  } else {
    btn.style.display = 'inline-flex';
  }
}

function toggleMatchingRules(header) {
  var body = header.nextElementSibling;
  var icon = header.querySelector('.mrb-toggle-icon');
  var isOpen = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'flex';
  icon.classList.toggle('collapsed', isOpen);
}

function navigate(targetId, comingTitle) {
  if (isTransitioning) return;
  if (comingTitle) document.getElementById('coming-title').textContent = comingTitle + ' â€” Coming Soon';
  isTransitioning = true;
  var curtain = document.getElementById('curtain');
  curtain.className = '';
  void curtain.offsetWidth;
  curtain.classList.add('show');
  setTimeout(function() {
    document.getElementById(currentScreen).classList.remove('active');
    document.getElementById(targetId).classList.add('active');
    if (targetId === 'screen-recon') document.getElementById(targetId).scrollTop = 0;
    navHistory.push(targetId);
    currentScreen = targetId;
    updateTopbarBack();
    curtain.classList.remove('show');
    curtain.classList.add('hide');
    setTimeout(function() { curtain.className = ''; isTransitioning = false; }, 450);
  }, 420);
}

function goBack(targetId) {
  if (isTransitioning) return;
  var target = targetId || (navHistory.length > 1 ? navHistory[navHistory.length - 2] : 'screen-landing');
  isTransitioning = true;
  var curtain = document.getElementById('curtain');
  curtain.className = '';
  void curtain.offsetWidth;
  curtain.classList.add('show');
  setTimeout(function() {
    document.getElementById(currentScreen).classList.remove('active');
    document.getElementById(target).classList.add('active');
    if (navHistory.length > 1) navHistory.pop();
    currentScreen = target;
    updateTopbarBack();
    curtain.classList.remove('show');
    curtain.classList.add('hide');
    setTimeout(function() { curtain.className = ''; isTransitioning = false; }, 450);
  }, 420);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROBOT SPEECH CYCLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var msgs = [
  'Hello! How can I<br>help you today? ğŸ‘‹',
  'I handle <strong>GST</strong><br>reconciliation for you!',
  'E-Invoice &amp; E-Way Bill<br>compliance made easy!',
  'Click <strong>Get Started</strong><br>to begin! ğŸš€'
];
var mIdx = 0;
setInterval(function() {
  var b = document.getElementById('speech-bubble');
  b.style.opacity = '0';
  b.style.transform = 'scale(0.9)';
  b.style.transition = 'all 0.2s ease';
  setTimeout(function() {
    mIdx = (mIdx + 1) % msgs.length;
    b.innerHTML = msgs[mIdx];
    b.style.opacity = '1';
    b.style.transform = 'scale(1)';
  }, 220);
}, 3200);

function startApp() {
  var r = document.getElementById('robot-wrap');
  r.classList.add('jumping');
  setTimeout(function() { r.classList.remove('jumping'); }, 750);
  navigate('screen-product');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXACT COLUMN DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var EMG_COL = {
  GSTIN_TAXPAYER:'GSTIN of Taxpayer', DOC_TYPE:'Document Type',
  INV_TYPE:'Invoice type', DOC_STATUS:'Document Status',
  CP_GSTIN:'GSTIN/ UIN of counterparty', TAXABLE_VALUE:'Taxable value',
  TAX_APPLICABILITY:'Tax applicability', IGST_RATE:'IGST Rate',
  CGST_RATE:'CGST Rate', SGST_RATE:'SGST/UTGST Rate',
  INV_NO:'Invoice No', DOC_NO:'Document No'
};
var COMP_COL = {
  ENTRY_TRADETYPE:'ENTRY_TRADETYPE', DOC_STATUS:'DOCUMENT_STATUS',
  GST_APP:'GST_APPLICABILITY', CP_GSTIN:'CP_GSTIN_NO',
  CP_REG_STATUS:'CP_GST_REGISTRATION_STATUS', HSN:'HSN_SAC_CODE',
  CGST_RATE:'CGST_RATE', SGST_RATE:'SGST_RATE', IGST_RATE:'IGST_RATE',
  TAXABLE_AMOUNT:'TAXABLE_AMOUNT',
  VOUCHER_NO:'VOUCHER_NO', INV_NO:'INVOICE_NO', DOC_NO:'DOCUMENT_NO'
};

var DATA = { emg:null, composite:null };
var RESULTS_STORE = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEY CLEANER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cleanKey(s) {
  return String(s)
    .replace(/[\u0000-\u001F\u007F\u00A0\u200B\u200C\u200D\uFEFF\u2028\u2029]/g,' ')
    .replace(/\s+/g,' ').trim();
}
function findExactCol(list, target) {
  var t = cleanKey(target).toLowerCase();
  for (var i=0;i<list.length;i++) if(cleanKey(list[i]).toLowerCase()===t) return list[i];
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEB WORKER BLOB â€” XLSX parsing off main thread
//  This is the ONLY reliable way to parse 78MB files
//  in a browser without allocation errors.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var WORKER_JS = `
importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');

self.onmessage = function(e) {
  var buf = e.data.buffer;
  var type = e.data.type;

  try {
    self.postMessage({ pct:10, msg:'Parsing workbookâ€¦' });

    var wb = XLSX.read(buf, {
      type      : 'buffer',
      cellDates : false,
      cellNF    : false,
      cellStyles: false,
      WTF       : false
    });
    buf = null;

    self.postMessage({ pct:35, msg:'Reading sheetâ€¦' });

    var sheetName = wb.SheetNames[0];
    var ws = wb.Sheets[sheetName];
    wb = null;

    if (!ws) {
      self.postMessage({ error: 'Could not read first sheet. File may be password-protected.' });
      return;
    }

    self.postMessage({ pct:50, msg:'Converting to rowsâ€¦' });

    var raw = XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:true });
    ws = null;

    if (!raw || raw.length < 2) {
      self.postMessage({ error: raw && raw.length === 1
        ? 'Only 1 row found â€” no data after header.'
        : 'File appears empty â€” no data in first sheet.' });
      return;
    }

    self.postMessage({ pct:60, msg:'Detecting header rowâ€¦' });

    // Find best header row
    var best=-1, hdrIdx=0;
    for (var i=0; i<Math.min(20,raw.length); i++) {
      var sc=0;
      for (var j=0; j<raw[i].length; j++) {
        var cv = String(raw[i][j]!==null&&raw[i][j]!==undefined?raw[i][j]:'').trim();
        if (cv.length>0 && isNaN(Number(cv))) sc++;
      }
      if (sc>best){ best=sc; hdrIdx=i; }
      if (sc>=5 && i>=1) break;
    }

    // Clean header
    function cleanKey(s){
      return String(s)
        .replace(/[\\u0000-\\u001F\\u007F\\u00A0\\u200B\\u200C\\u200D\\uFEFF\\u2028\\u2029]/g,' ')
        .replace(/\\s+/g,' ').trim();
    }

    var rawH = raw[hdrIdx], headers = [];
    for (var c=0; c<rawH.length; c++)
      headers.push(cleanKey(String(rawH[c]!==null&&rawH[c]!==undefined?rawH[c]:'')));

    var dataRows = raw.slice(hdrIdx+1);
    raw = null;
    var totalRows = dataRows.length;

    self.postMessage({ pct:65, msg:'Processing rowsâ€¦ (0 / '+totalRows.toLocaleString()+')' });

    // Process in chunks and report progress
    var rows = [];
    var CHUNK = 3000;
    for (var start=0; start<totalRows; start+=CHUNK) {
      var end = Math.min(start+CHUNK, totalRows);
      for (var r=start; r<end; r++) {
        var obj={}, has=false, row=dataRows[r];
        for (var c2=0; c2<headers.length; c2++) {
          if (headers[c2]) {
            var v = (row[c2]!==undefined&&row[c2]!==null) ? row[c2] : '';
            obj[headers[c2]] = v;
            if (String(v).trim()!=='') has=true;
          }
        }
        if (has) rows.push(obj);
      }
      var pct = 65 + Math.round((end/totalRows)*32);
      self.postMessage({ pct:pct, msg:'Processing rowsâ€¦ ('+end.toLocaleString()+' / '+totalRows.toLocaleString()+')' });
    }

    dataRows = null;

    self.postMessage({ done:true, rows:rows, headers:headers, hdrIdx:hdrIdx });

  } catch(ex) {
    self.postMessage({ error: ex.message });
  }
};
`;

var _workerBlob = null;
function getWorkerURL() {
  if (!_workerBlob) {
    _workerBlob = URL.createObjectURL(new Blob([WORKER_JS], { type:'application/javascript' }));
  }
  return _workerBlob;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE LOADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadFile(type, inp) {
  var file = inp.files[0]; if (!file) return;
  clearErr();

  /* reset card */
  ['fi','db','us','up'].forEach(function(p){
    var el = document.getElementById(p+'-'+type);
    if(el) el.classList.remove('on');
  });
  var fillEl   = document.getElementById('up-fill-'+type);
  var upEl     = document.getElementById('up-'+type);
  var pctEl    = document.getElementById('up-pct-'+type);
  var statusEl = document.getElementById('up-status-'+type);
  if(fillEl) fillEl.style.width='0%';
  document.getElementById('card-'+type).classList.remove('loaded');
  DATA[type] = null;
  if(upEl) upEl.classList.add('on');

  var isXLarge = file.size > 40*1024*1024;
  var prog = 0;

  function setBar(pct, msg) {
    prog = pct;
    if(fillEl)   fillEl.style.width   = pct+'%';
    if(pctEl)    pctEl.textContent    = Math.round(pct)+'%';
    if(statusEl) statusEl.textContent = msg;
  }

  setBar(0, isXLarge ? 'Reading large file ('+Math.round(file.size/1024/1024)+' MB)â€¦' : 'Reading fileâ€¦');

  /* fake ticker while FileReader loads */
  var ticker = setInterval(function(){
    if(prog < 8){
      prog += isXLarge ? 0.3 : 1.5;
      setBar(prog, isXLarge ? 'Reading '+Math.round(file.size/1024/1024)+' MB fileâ€¦ please wait' : 'Reading fileâ€¦');
    }
  }, 200);

  var reader = new FileReader();

  reader.onprogress = function(e){
    if(e.lengthComputable){
      var p = Math.min((e.loaded/e.total)*8, 8);
      if(p > prog) setBar(p, 'Reading fileâ€¦');
    }
  };

  reader.onload = function(e){
    clearInterval(ticker);
    setBar(9, 'Starting parserâ€¦');

    var worker;
    try {
      worker = new Worker(getWorkerURL());
    } catch(we) {
      /* Web Workers blocked (e.g. file:// protocol) â€” fall back to main thread */
      setBar(10, 'Parsing on main threadâ€¦');
      parseOnMainThread(type, file, e.target.result, setBar, upEl, inp);
      return;
    }

    worker.onmessage = function(ev) {
      var d = ev.data;

      if(d.error){
        worker.terminate();
        if(upEl) upEl.classList.remove('on');
        showErr('âŒ '+d.error);
        return;
      }

      if(d.pct !== undefined){
        setBar(d.pct, d.msg);
        return;
      }

      if(d.done){
        worker.terminate();
        setBar(100,'âœ… Done!');
        finishLoad(type, file, d.rows, d.headers, d.hdrIdx, upEl);
      }
    };

    worker.onerror = function(err){
      worker.terminate();
      /* Worker crashed â€” likely still memory issue â€” try main thread as last resort */
      if(upEl) upEl.classList.remove('on');
      showErr('âŒ Worker error: '+err.message+
        ' â€” Try converting your file to CSV first (File â†’ Save As â†’ CSV in Excel), then upload the CSV.');
    };

    /* Transfer the ArrayBuffer to worker â€” zero-copy, no duplication */
    worker.postMessage({ buffer: e.target.result, type: type }, [e.target.result]);
  };

  reader.onerror = function(){
    clearInterval(ticker);
    if(upEl) upEl.classList.remove('on');
    showErr('Could not read file. Please try again.');
  };

  reader.readAsArrayBuffer(file);
}

/* â”€â”€ Main-thread fallback for environments where Workers are blocked â”€â”€ */
function parseOnMainThread(type, file, buf, setBar, upEl, inp) {
  setTimeout(function(){
    try {
      var wb = XLSX.read(buf, { type:'buffer', cellDates:false, cellNF:false, cellStyles:false, WTF:false });
      buf = null;
      setBar(40,'Reading sheetâ€¦');
      var ws = wb.Sheets[wb.SheetNames[0]]; wb = null;
      if(!ws){ if(upEl) upEl.classList.remove('on'); showErr('Could not read sheet â€” file may be corrupted.'); return; }
      setTimeout(function(){
        var raw = XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:true}); ws=null;
        if(!raw||raw.length<2){ if(upEl) upEl.classList.remove('on'); showErr('File appears empty.'); return; }
        var best=-1,hdrIdx=0;
        for(var i=0;i<Math.min(20,raw.length);i++){
          var sc=0;
          for(var j=0;j<raw[i].length;j++){var cv=String(raw[i][j]!==null&&raw[i][j]!==undefined?raw[i][j]:'').trim();if(cv.length>0&&isNaN(Number(cv)))sc++;}
          if(sc>best){best=sc;hdrIdx=i;}if(sc>=5&&i>=1)break;
        }
        var rawH=raw[hdrIdx],headers=[];
        for(var c=0;c<rawH.length;c++) headers.push(cleanKey(String(rawH[c]!==null&&rawH[c]!==undefined?rawH[c]:'')));
        var dataRows=raw.slice(hdrIdx+1); raw=null;
        var rows=[],totalRows=dataRows.length; setBar(70,'Processing rowsâ€¦');
        for(var r=0;r<totalRows;r++){
          var obj={},has=false,row=dataRows[r];
          for(var c2=0;c2<headers.length;c2++){if(headers[c2]){var v=(row[c2]!==undefined&&row[c2]!==null)?row[c2]:'';obj[headers[c2]]=v;if(String(v).trim()!=='')has=true;}}
          if(has)rows.push(obj);
        }
        setBar(100,'âœ… Done!');
        finishLoad(type, file, rows, headers, hdrIdx, upEl);
      },60);
    } catch(ex){ if(upEl) upEl.classList.remove('on'); showErr('Error: '+ex.message); }
  },40);
}

/* â”€â”€ Called when rows are ready (from worker OR fallback) â”€â”€ */
function finishLoad(type, file, rows, headers, hdrIdx, upEl) {
  DATA[type] = rows;
  DATA[type+'_headers'] = headers;

  setTimeout(function(){
    if(upEl) upEl.classList.remove('on');

    var usEl   = document.getElementById('us-'+type);
    var usText = document.getElementById('us-text-'+type);
    var usMeta = document.getElementById('us-meta-'+type);
    if(usEl && usText && usMeta){
      var sz = file.size>1024*1024
        ? (file.size/(1024*1024)).toFixed(1)+' MB'
        : Math.round(file.size/1024)+' KB';
      var dn = file.name.length>40 ? file.name.substring(0,37)+'â€¦' : file.name;
      usText.textContent = dn+' â€” uploaded successfully!';
      usMeta.textContent = rows.length.toLocaleString()+' rows Â· '+sz;
      usEl.classList.add('on');
    }

    document.getElementById('fn-'+type).textContent = file.name;
    document.getElementById('fm-'+type).textContent =
      rows.length.toLocaleString()+' rows Â· '+headers.filter(Boolean).length+' cols Â· hdr row #'+(hdrIdx+1);
    document.getElementById('fi-'+type).classList.add('on');
    document.getElementById('card-'+type).classList.add('loaded');
    showColDetect(type, headers);
    checkReady();
  }, 350);
}

function showColDetect(type,headers){
  var defs=type==='emg'
    ?[{l:'Invoice type',c:EMG_COL.INV_TYPE},{l:'Document Type',c:EMG_COL.DOC_TYPE},{l:'Taxable value',c:EMG_COL.TAXABLE_VALUE},{l:'Tax applicability',c:EMG_COL.TAX_APPLICABILITY},{l:'Document Status',c:EMG_COL.DOC_STATUS}]
    :[{l:'GST_APPLICABILITY',c:COMP_COL.GST_APP},{l:'DOCUMENT_STATUS',c:COMP_COL.DOC_STATUS},{l:'CP_GSTIN_NO',c:COMP_COL.CP_GSTIN},{l:'ENTRY_TRADETYPE',c:COMP_COL.ENTRY_TRADETYPE},{l:'TAXABLE_AMOUNT',c:COMP_COL.TAXABLE_AMOUNT}];
  var grid=document.getElementById('dg-'+type);
  grid.innerHTML='';
  defs.forEach(function(d){
    var found=findExactCol(headers,d.c);
    var div=document.createElement('div');div.className='debug-row';
    div.innerHTML='<span class="debug-field">'+d.l+'</span><span class="'+(found?'debug-found':'debug-miss')+'">'+(found?'âœ“ Found':'âœ— NOT FOUND')+'</span>';
    grid.appendChild(div);
  });
  var allDiv=document.createElement('div');
  allDiv.style.cssText='margin-top:7px;font-size:9px;color:var(--text3);border-top:1px solid var(--border);padding-top:5px;word-break:break-all;line-height:1.8;font-family:monospace';
  allDiv.innerHTML='<span style="color:var(--warn);font-weight:700">All columns:</span> '+headers.filter(Boolean).map(function(h){return'<span style="background:rgba(255,255,255,0.05);padding:1px 5px;border-radius:4px;margin:1px;display:inline-block">'+h+'</span>';}).join('');
  grid.appendChild(allDiv);
  document.getElementById('db-'+type).classList.add('on');
}

function clearF(type){
  DATA[type]=null;document.getElementById('file-'+type).value='';
  document.getElementById('fi-'+type).classList.remove('on');
  document.getElementById('db-'+type).classList.remove('on');
  document.getElementById('card-'+type).classList.remove('loaded');
  var up=document.getElementById('up-'+type); if(up) up.classList.remove('on');
  var us=document.getElementById('us-'+type); if(us) us.classList.remove('on');
  var fill=document.getElementById('up-fill-'+type); if(fill) fill.style.width='0%';
  checkReady();
}
function checkReady(){
  var ok=DATA.emg&&DATA.composite;
  document.getElementById('btn-run').disabled=!ok;
  var h=document.getElementById('run-hint');
  h.textContent=ok?'Both files ready â€” click to reconcile':'Upload both files to begin';
  h.style.color=ok?'var(--orange)':'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VALUE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resolveCol(row,col){
  if(!row||!col)return undefined;
  if(row[col]!==undefined)return row[col];
  var t=cleanKey(col).toLowerCase(),keys=Object.keys(row);
  for(var i=0;i<keys.length;i++) if(cleanKey(keys[i]).toLowerCase()===t) return row[keys[i]];
  return undefined;
}
function getNum(row,col){var v=resolveCol(row,col);if(v===undefined||v===null||v==='')return 0;if(typeof v==='number')return v;var s=String(v).trim().replace(/[,\u20b9$\u00a3\u20ac\s]/g,'').replace(/^\((.+)\)$/,'-$1');var n=parseFloat(s);return isNaN(n)?0:n;}
function getStr(row,col){var v=resolveCol(row,col);return v===undefined||v===null?'':String(v).trim();}
function contains(s,sub){return String(s).toLowerCase().indexOf(String(sub).toLowerCase())!==-1;}
function eq(a,b){return String(a).trim().toLowerCase()===String(b).trim().toLowerCase();}
function isBlank(v){var s=String(v===undefined||v===null?'':v).trim().toLowerCase();return s===''||s==='null'||s==='undefined'||s==='nan'||s==='none'||s==='n/a';}
function isPosted(v){var s=String(v).trim().toLowerCase();return s===''||s==='posted'||s==='approved'||s==='confirmed'||s==='null'||s==='undefined';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECONCILIATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runRecon(){clearErr();if(!DATA.emg||!DATA.composite){showErr('Upload both files first.');return;}setProg(true,5,'Starting...');setTimeout(doCalcAsync,80);}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PERFORMANCE ENGINE â€” chunked async for 10L+ rows
// Uses setTimeout(0) to yield to browser between chunks
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doCalcAsync(){
  var C=DATA.composite, E=DATA.emg;
  RESULTS_STORE={};

  // Numeric totals helpers (optimised tight loop)
  function sumC(arr){var s=0,n=arr.length;for(var i=0;i<n;i++)s+=getNum(arr[i],COMP_COL.TAXABLE_AMOUNT);return s;}
  function sumE(arr){var s=0,n=arr.length;for(var i=0;i<n;i++)s+=getNum(arr[i],EMG_COL.TAXABLE_VALUE);return s;}

  // Pre-build lookup caches for column resolution (avoid repeated object key scans)
  function buildCache(rows, colName){
    var map={};
    for(var i=0,n=rows.length;i<n;i++){
      var v=getStr(rows[i],colName);
      if(!map[v])map[v]=[];
      map[v].push(i);
    }
    return map;
  }

  // Pre-extract all key fields once for each file to avoid repeated resolveCol calls
  setProg(true,8,'Pre-processing columns...');

  // Build pre-extracted arrays for fast filtering
  var CN=C.length, EN=E.length;

  // Composite pre-extracted
  var cGST=new Array(CN), cDS=new Array(CN), cCPGST=new Array(CN),
      cTT=new Array(CN), cHSN=new Array(CN), cAMT=new Array(CN),
      cCR=new Array(CN), cSR=new Array(CN), cIR=new Array(CN), cCPREG=new Array(CN);
  for(var i=0;i<CN;i++){
    var r=C[i];
    cGST[i]  = getStr(r,COMP_COL.GST_APP).toLowerCase();
    cDS[i]   = getStr(r,COMP_COL.DOC_STATUS).toLowerCase();
    cCPGST[i]= getStr(r,COMP_COL.CP_GSTIN).toLowerCase();
    cTT[i]   = getStr(r,COMP_COL.ENTRY_TRADETYPE).toLowerCase();
    cHSN[i]  = getStr(r,COMP_COL.HSN).toUpperCase();
    cCPREG[i]= getStr(r,COMP_COL.CP_REG_STATUS).toLowerCase();
    cCR[i]   = getNum(r,COMP_COL.CGST_RATE);
    cSR[i]   = getNum(r,COMP_COL.SGST_RATE);
    cIR[i]   = getNum(r,COMP_COL.IGST_RATE);
    cAMT[i]  = getNum(r,COMP_COL.TAXABLE_AMOUNT);
  }

  // EMG pre-extracted
  var eIT=new Array(EN), eDT=new Array(EN), eTA=new Array(EN),
      eDS=new Array(EN), eVal=new Array(EN);
  for(var j=0;j<EN;j++){
    var re=E[j];
    eIT[j] = getStr(re,EMG_COL.INV_TYPE).toLowerCase();
    eDT[j] = getStr(re,EMG_COL.DOC_TYPE).toLowerCase();
    eTA[j] = getStr(re,EMG_COL.TAX_APPLICABILITY).toUpperCase();
    eDS[j] = getStr(re,EMG_COL.DOC_STATUS).toLowerCase();
    eVal[j]= getNum(re,EMG_COL.TAXABLE_VALUE);
  }

  // Helper: is posted
  function posted(s){return s===''||s==='posted'||s==='approved'||s==='confirmed'||s==='null'||s==='undefined';}
  // Helper: outward applicability
  function isAOA(s){return s.indexOf('outward supply')!==-1||s.indexOf('other outward')!==-1||s.indexOf('sales credit')!==-1||s.indexOf('sales debit')!==-1||s.indexOf('credit note')!==-1||s.indexOf('debit note')!==-1;}
  // Helper: all-zero rates
  function allZero(i){return cCR[i]===0&&cSR[i]===0&&cIR[i]===0;}

  // Fast filter â€” returns index arrays
  function filterC(fn){var out=[];for(var i=0;i<CN;i++)if(fn(i))out.push(i);return out;}
  function filterE(fn){var out=[];for(var j=0;j<EN;j++)if(fn(j))out.push(j);return out;}
  // Get actual rows from index arrays
  function cRows(idxs){return idxs.map(function(i){return C[i];});}
  function eRows(idxs){return idxs.map(function(j){return E[j];});}
  function sumCI(idxs){var s=0;for(var k=0;k<idxs.length;k++)s+=cAMT[idxs[k]];return s;}
  function sumEI(idxs){var s=0;for(var k=0;k<idxs.length;k++)s+=eVal[idxs[k]];return s;}

  // Run all category filters (sync but fast with pre-extracted arrays)
  setProg(true,20,'Filtering B2B...');

  var iB2B_c = filterC(function(i){return (cGST[i].indexOf('outward supply')!==-1||cGST[i].indexOf('other outward')!==-1)&&posted(cDS[i])&&cCPGST[i]!==''&&cAMT[i]>=0;});
  var iB2B_e = filterE(function(j){return eIT[j]==='b2b'&&eDT[j]==='ri';});

  setProg(true,30,'Filtering CDN...');
  // B2B CDN Composite logic:
  // (a) Sales Credit/Debit Note + GSTIN present
  // (b) Outward Supply / Other Outward + GSTIN present + Taxable Amount is NEGATIVE (returns)
  var iCDN_c = filterC(function(i){
    var isCDN_a = (cGST[i].indexOf('sales credit')!==-1||cGST[i].indexOf('sales debit')!==-1||cGST[i].indexOf('credit note')!==-1||cGST[i].indexOf('debit note')!==-1)&&posted(cDS[i])&&cCPGST[i]!=='';
    var isCDN_b = (cGST[i].indexOf('outward supply')!==-1||cGST[i].indexOf('other outward')!==-1)&&posted(cDS[i])&&cCPGST[i]!==''&&cAMT[i]<0;
    return isCDN_a||isCDN_b;
  });
  var iCDN_e = filterE(function(j){return eIT[j]==='b2b'&&(eDT[j]==='c'||eDT[j]==='d');});

  setProg(true,38,'Filtering B2CS...');
  var iB2CS_c = filterC(function(i){return cGST[i].indexOf('outward supply')!==-1&&posted(cDS[i])&&cCPGST[i]==='';});
  var iB2CS_e = filterE(function(j){return eIT[j]==='b2cs'&&(eDT[j]==='ri'||eDT[j]==='c');});

  setProg(true,46,'Filtering Export RI...');
  var iExRI_c = filterC(function(i){return cGST[i].indexOf('outward supply')!==-1&&posted(cDS[i])&&(cTT[i].indexOf('export')!==-1||cTT[i].indexOf('import')!==-1);});
  var iExRI_e = filterE(function(j){return(eIT[j]==='exwop'||eIT[j]==='exwp')&&eDT[j]==='ri';});

  setProg(true,54,'Filtering Export CDN...');
  var iExCDN_c= filterC(function(i){return(cGST[i].indexOf('sales credit')!==-1||cGST[i].indexOf('credit note')!==-1)&&posted(cDS[i])&&(cTT[i].indexOf('export')!==-1||cTT[i].indexOf('import')!==-1);});
  var iExCDN_e= filterE(function(j){return(eIT[j]==='exwop'||eIT[j]==='exwp')&&eDT[j]==='c';});

  setProg(true,62,'Filtering Non-GST...');
  var iNG_c   = filterC(function(i){return isAOA(cGST[i])&&allZero(i)&&(cHSN[i]==='NONGSTIN'||cHSN[i].indexOf('NONGSTIN')!==-1);});
  var iNG_e   = filterE(function(j){return eTA[j]==='N'&&(eDT[j]==='ri'||eDT[j]==='c');});

  setProg(true,70,'Filtering Exempt...');
  var iEx_c   = filterC(function(i){return isAOA(cGST[i])&&allZero(i)&&(cCPREG[i].indexOf('exempt')!==-1||cCPREG[i]==='e');});
  var iEx_e   = filterE(function(j){return eTA[j]==='E'&&(eDT[j]==='ri'||eDT[j]==='c');});

  setProg(true,78,'Filtering Nil Rated...');
  var iNil_e  = filterE(function(j){return eTA[j]==='L'&&(eDT[j]==='ri'||eDT[j]==='c');});

  setProg(true,88,'Computing totals...');

  var cats=[
    {key:'b2b_ri',  cat:'B2B â€“ Regular Invoices',     sub:'Comp: GST_APPLICABILITY âŠ‡ Outward/Other Outward + CP_GSTIN not blank | EMG: Invoice type=B2B, DocType=RI',    cRows:cRows(iB2B_c),  eRows:eRows(iB2B_e),  cV:sumCI(iB2B_c),  eV:sumEI(iB2B_e)},
    {key:'b2b_cdn', cat:'B2B â€“ Credit/Debit Notes',   sub:'Comp: (a) Sales Credit/Debit Note+GSTIN OR (b) Outward Supply+GSTIN+Taxable<0 | EMG: B2B + DocType=C or D',                    cRows:cRows(iCDN_c),  eRows:eRows(iCDN_e),  cV:sumCI(iCDN_c),  eV:sumEI(iCDN_e)},
    {key:'b2cs',    cat:'B2CS',                        sub:'Comp: Outward Supply + CP_GSTIN blank | EMG: Invoice type=B2CS, DocType=RI+C',                                  cRows:cRows(iB2CS_c), eRows:eRows(iB2CS_e), cV:sumCI(iB2CS_c), eV:sumEI(iB2CS_e)},
    {key:'exp_ri',  cat:'Export Invoices',             sub:'Comp: Outward Supply + ENTRY_TRADETYPE âŠ‡ Export/Import | EMG: EXWOP/EXWP, RI',                                  cRows:cRows(iExRI_c), eRows:eRows(iExRI_e), cV:sumCI(iExRI_c), eV:sumEI(iExRI_e)},
    {key:'exp_cdn', cat:'Export Credit Notes',         sub:'Comp: Sales Credit Note + Trade=Export/Import | EMG: EXWOP/EXWP, DocType=C',                                   cRows:cRows(iExCDN_c),eRows:eRows(iExCDN_e),cV:sumCI(iExCDN_c),eV:sumEI(iExCDN_e)},
    {key:'non_gst', cat:'Non-GST (NonGSTIN)',          sub:'Comp: HSN=NONGSTIN + all rates=0 | EMG: Tax applicability=N, RI/C',                                             cRows:cRows(iNG_c),   eRows:eRows(iNG_e),   cV:sumCI(iNG_c),   eV:sumEI(iNG_e)},
    {key:'exempt',  cat:'Exempt',                      sub:'Comp: CP_GST_REGISTRATION_STATUS=Exempt + all rates=0 | EMG: Tax applicability=E, RI/C',                        cRows:cRows(iEx_c),   eRows:eRows(iEx_e),   cV:sumCI(iEx_c),   eV:sumEI(iEx_e)},
    {key:'nil',     cat:'Nil Rated',                   sub:'EMG only â€” Tax applicability=L, DocType=RI/C (no Composite filter)',                                             cRows:[],             eRows:eRows(iNil_e),  cV:null,            eV:sumEI(iNil_e)}
  ];

  cats.forEach(function(c){RESULTS_STORE[c.key]=c;});
  setProg(true,100,'Complete!');
  setTimeout(function(){setProg(false);renderTable(cats);},400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyStatusFilter(filter, btn) {
  // Update active button
  document.querySelectorAll('.sf-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  // Show/hide rows
  var rows = document.querySelectorAll('#res-body tr');
  rows.forEach(function(tr) {
    var rowSt = tr.getAttribute('data-status') || '';
    if (filter === 'ALL' || rowSt === filter) {
      tr.classList.remove('sf-hidden');
    } else {
      tr.classList.add('sf-hidden');
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  4-STATUS CLASSIFICATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var TOL_MATCH = 0.01;   // â‰¤ this â†’ MATCH
var TOL_DEEMED = 1.00;  // â‰¤ this (and > TOL_MATCH) â†’ DEEMED MATCH

// Derive 4-status for a category given totals and row counts
function getCategoryStatus(cV, eV, cRows, eRows) {
  if (cV === null || eV === null) return 'N/A';
  var diff = Math.abs(cV - eV);
  // Invoice mismatch: one side has 0 rows and the other doesn't
  if ((cRows.length === 0 && eRows.length > 0) || (cRows.length > 0 && eRows.length === 0)) {
    return 'INVOICE MISMATCH';
  }
  // Both empty
  if (cRows.length === 0 && eRows.length === 0) return 'MATCH';
  // Row count mismatch = invoice mismatch (structural)
  if (cRows.length !== eRows.length) return 'INVOICE MISMATCH';
  // Same row counts â€” check value
  if (diff <= TOL_MATCH) return 'MATCH';
  if (diff <= TOL_DEEMED) return 'DEEMED MATCH';
  return 'VALUE MISMATCH';
}

function statusBadge(st) {
  if (st === 'MATCH')           return '<span class="badge bm">âœ“ MATCH</span>';
  if (st === 'DEEMED MATCH')    return '<span class="badge bdm">~ DEEMED MATCH</span>';
  if (st === 'VALUE MISMATCH')  return '<span class="badge bvm">âš  VALUE MISMATCH</span>';
  if (st === 'INVOICE MISMATCH')return '<span class="badge bim">âœ— INVOICE MISMATCH</span>';
  return '<span class="badge bn">N/A</span>';
}

function statusRowClass(st) {
  if (st === 'VALUE MISMATCH')   return 'amber-row';
  if (st === 'INVOICE MISMATCH') return 'red-row';
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TABLE + DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(cats){
  function fmt(v){if(v===null)return'â€”';return'â‚¹â€¯'+v.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});}
  var cntMatch=0,cntDeemed=0,cntValMis=0,cntInvMis=0,totC=0,totE=0;
  var matchRows=0,deemedRows=0,invMisRows=0,valMisRows=0;
  var tbody=document.getElementById('res-body');tbody.innerHTML='';
  cats.forEach(function(row){
    var diff=(row.cV!==null&&row.eV!==null)?row.cV-row.eV:null;
    var st = getCategoryStatus(row.cV, row.eV, row.cRows, row.eRows);
    if(row.cV!==null)totC+=row.cV;if(row.eV!==null)totE+=row.eV;
    var totalRowsForCat=row.cRows.length+row.eRows.length;
    if(st==='MATCH'){cntMatch++;matchRows+=totalRowsForCat;}
    else if(st==='DEEMED MATCH'){cntDeemed++;deemedRows+=totalRowsForCat;}
    else if(st==='VALUE MISMATCH'){cntValMis++;valMisRows+=totalRowsForCat;}
    else if(st==='INVOICE MISMATCH'){cntInvMis++;invMisRows+=totalRowsForCat;}
    var dc='dz';if(diff!==null&&Math.abs(diff)>TOL_MATCH)dc=diff>0?'dp':'dn';
    var badge = statusBadge(st);
    var invSummary = '<div class="cd" style="margin-top:4px;font-size:9px;">'
      +'Rows â€” Comp: <b>'+row.cRows.length+'</b> &nbsp;|&nbsp; EMG: <b>'+row.eRows.length+'</b>'
      +'</div>';
    var tr=document.createElement('tr');tr.className=statusRowClass(st);
    tr.setAttribute('data-status', st);
    tr.innerHTML='<td><div class="ct">'+row.cat+'</div>'
      +invSummary
      +'<div class="cd" style="color:var(--text3);font-size:9px;margin-top:2px">'+row.sub+'</div></td>'
      +'<td class="'+(row.cV===0?'vm':'')+'">'+fmt(row.cV)+'</td>'
      +'<td class="'+(row.eV===0?'vm':'')+'">'+fmt(row.eV)+'</td>'
      +'<td class="'+dc+'">'+fmt(diff)+'</td>'
      +'<td>'+badge+'</td>';
    tbody.appendChild(tr);
  });
  var td2=totC-totE;
  var grandBadge;
  if(Math.abs(td2)<=TOL_MATCH) grandBadge=statusBadge('MATCH');
  else if(Math.abs(td2)<=TOL_DEEMED) grandBadge=statusBadge('DEEMED MATCH');
  else grandBadge=statusBadge('VALUE MISMATCH');
  var dc2=td2===0?'dz':td2>0?'dp':'dn';
  document.getElementById('res-foot').innerHTML='<tr><td style="text-align:left">GRAND TOTAL</td><td>'+fmt(totC)+'</td><td>'+fmt(totE)+'</td><td class="'+dc2+'">'+fmt(td2)+'</td><td>'+grandBadge+'</td></tr>';
  document.getElementById('ch-m').textContent=cntMatch+' Match';
  document.getElementById('ch-d').textContent=(cntDeemed+cntValMis+cntInvMis)+' Issues';
  var total=cats.length;
  document.getElementById('sf-cnt-all').textContent    = total;
  document.getElementById('sf-cnt-match').textContent  = cntMatch;
  document.getElementById('sf-cnt-deemed').textContent = cntDeemed;
  document.getElementById('sf-cnt-valmis').textContent = cntValMis;
  document.getElementById('sf-cnt-invmis').textContent = cntInvMis;
  document.querySelectorAll('.sf-btn').forEach(function(b){b.classList.remove('active');});
  var allBtn=document.querySelector('.sf-btn.sf-all');
  if(allBtn) allBtn.classList.add('active');
  // DASHBOARD CARDS
  document.getElementById('dashTotal').textContent    = total;
  document.getElementById('dashMatch').textContent    = cntMatch+cntDeemed;
  document.getElementById('dashMismatch').textContent = cntValMis+cntInvMis;
  document.getElementById('dashMissing').textContent  = cntInvMis;
  // CATEGORY STRIP
  document.getElementById('catMatch').textContent      = cntMatch;
  document.getElementById('catDeemed').textContent     = cntDeemed;
  document.getElementById('catInvMis').textContent     = cntInvMis;
  document.getElementById('catValMis').textContent     = cntValMis;
  document.getElementById('catMatchRows').textContent  = matchRows.toLocaleString()+' rows';
  document.getElementById('catDeemedRows').textContent = deemedRows.toLocaleString()+' rows';
  document.getElementById('catInvMisRows').textContent = invMisRows.toLocaleString()+' rows';
  document.getElementById('catValMisRows').textContent = valMisRows.toLocaleString()+' rows';
  // INVOICE-LEVEL TABS
  buildInvDetailTabs(cats);
  buildDrillDownTabs(cats);
  buildInvMatchSummary(cats);
  document.getElementById('notes').innerHTML='<strong>Note:</strong> Click any category card above to jump to invoice-level rows. Mismatched categories are further analysed in the <strong>Mismatch Drill-Down</strong> panel below. Use <em>Export Working Excel</em> to download full row-level data.';
  var r=document.getElementById('results');r.style.display='block';
  setTimeout(function(){r.scrollIntoView({behavior:'smooth',block:'start'});},100);
}

// ======================================================
//  INVOICE-LEVEL DETAIL ENGINE
// ======================================================
var INV_CATS=[];
var INV_CUR_KEY='';
var INV_CUR_SRC='comp';
var INV_ALL_ROWS=[];

function buildInvDetailTabs(cats){
  INV_CATS=cats;
  var tabBar=document.getElementById('inv-cat-tabs');
  tabBar.innerHTML='';
  cats.forEach(function(c,idx){
    var st=getCategoryStatus(c.cV,c.eV,c.cRows,c.eRows);
    var stLabel=st==='MATCH'?'âœ“':st==='DEEMED MATCH'?'~':st==='VALUE MISMATCH'?'âš ':'âœ—';
    var btn=document.createElement('button');
    btn.className='inv-tab'+(idx===0?' active':'');
    btn.setAttribute('data-key',c.key);
    btn.innerHTML=stLabel+' '+c.cat+' <span style="opacity:0.5;font-weight:400">('+( c.cRows.length+c.eRows.length)+')</span>';
    btn.onclick=(function(cat){return function(){
      document.querySelectorAll('.inv-tab').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderInvTable(cat.key);
    };})(c);
    tabBar.appendChild(btn);
  });
  if(cats.length) renderInvTable(cats[0].key);
}

function switchInvSrc(src){
  INV_CUR_SRC=src;
  document.getElementById('ist-comp').classList.toggle('active',src==='comp');
  document.getElementById('ist-emg').classList.toggle('active',src==='emg');
  document.getElementById('ist-both').classList.toggle('active',src==='both');
  if(INV_CUR_KEY) renderInvTable(INV_CUR_KEY);
}

function scrollToInvDetail(){
  var invSect=document.getElementById('inv-detail-section');
  if(invSect) invSect.scrollIntoView({behavior:'smooth',block:'start'});
}

function renderInvTable(key){
  INV_CUR_KEY=key;
  document.getElementById('inv-search').value='';
  var cat=null;
  for(var i=0;i<INV_CATS.length;i++) if(INV_CATS[i].key===key){cat=INV_CATS[i];break;}
  if(!cat){document.getElementById('inv-tbl-wrap').innerHTML='<div class="inv-empty">No data.</div>';return;}
  var rows=[];
  if(INV_CUR_SRC==='comp'||INV_CUR_SRC==='both') cat.cRows.forEach(function(r){rows.push({src:'comp',row:r});});
  if(INV_CUR_SRC==='emg' ||INV_CUR_SRC==='both') cat.eRows.forEach(function(r){rows.push({src:'emg',row:r});});
  INV_ALL_ROWS=rows;
  renderInvRows(rows);
}

function renderInvRows(rows){
  var wrap=document.getElementById('inv-tbl-wrap');
  document.getElementById('inv-count-lbl').textContent=rows.length.toLocaleString()+' rows';
  if(!rows.length){wrap.innerHTML='<div class="inv-empty">No rows for this selection.</div>';return;}
  var showComp=rows.some(function(r){return r.src==='comp';});
  var showEMG =rows.some(function(r){return r.src==='emg';});
  var html='<table><thead><tr>';
  if(showComp&&showEMG) html+='<th>Source</th>';
  html+='<th>GSTIN / Party</th>';
  if(showComp) html+='<th>GST Applicability</th><th>Trade Type</th><th>Doc Status</th>';
  if(showEMG)  html+='<th>Invoice Type</th><th>Doc Type</th><th>Tax Appl.</th>';
  html+='<th class="r">Taxable Value (â‚¹)</th>';
  if(showComp) html+='<th class="r">CGST%</th><th class="r">SGST%</th><th class="r">IGST%</th>';
  html+='</tr></thead><tbody>';
  var fmtV=function(v){var n=typeof v==='number'?v:parseFloat(String(v).replace(/[,â‚¹\s]/g,''));if(isNaN(n))return'<span class="dim">â€”</span>';return n.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});};
  var esc=function(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');};
  rows.forEach(function(item){
    var r=item.row,isComp=item.src==='comp';
    var gstin,gst='',tt='',ds='',it='',dt='',ta='',val,cgst='',sgst='',igst='';
    if(isComp){
      gstin=esc(getStr(r,COMP_COL.CP_GSTIN)||'â€”');
      gst=esc(getStr(r,COMP_COL.GST_APP));
      tt=esc(getStr(r,COMP_COL.ENTRY_TRADETYPE));
      ds=esc(getStr(r,COMP_COL.DOC_STATUS));
      val=fmtV(getNum(r,COMP_COL.TAXABLE_AMOUNT));
      cgst=esc(getStr(r,COMP_COL.CGST_RATE));
      sgst=esc(getStr(r,COMP_COL.SGST_RATE));
      igst=esc(getStr(r,COMP_COL.IGST_RATE));
    } else {
      gstin=esc(getStr(r,EMG_COL.CP_GSTIN)||getStr(r,EMG_COL.GSTIN_TAXPAYER)||'â€”');
      it=esc(getStr(r,EMG_COL.INV_TYPE));
      dt=esc(getStr(r,EMG_COL.DOC_TYPE));
      ta=esc(getStr(r,EMG_COL.TAX_APPLICABILITY));
      ds=esc(getStr(r,EMG_COL.DOC_STATUS));
      val=fmtV(getNum(r,EMG_COL.TAXABLE_VALUE));
    }
    html+='<tr>';
    if(showComp&&showEMG) html+='<td>'+(isComp?'<span class="inv-src-badge isb-comp">Comp</span>':'<span class="inv-src-badge isb-emg">EMG</span>')+'</td>';
    html+='<td style="font-family:monospace;font-size:11px">'+gstin+'</td>';
    if(showComp) html+='<td>'+gst+'</td><td class="dim">'+tt+'</td><td class="dim">'+ds+'</td>';
    if(showEMG)  html+='<td><span class="inv-src-badge isb-emg" style="font-size:9px">'+it+'</span></td><td class="dim">'+dt+'</td><td class="dim">'+ta+'</td>';
    html+='<td class="mono">'+val+'</td>';
    if(showComp) html+='<td class="mono dim">'+cgst+'</td><td class="mono dim">'+sgst+'</td><td class="mono dim">'+igst+'</td>';
    html+='</tr>';
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;
}

function filterInvTable(){
  var q=document.getElementById('inv-search').value.trim().toLowerCase();
  if(!q){renderInvRows(INV_ALL_ROWS);return;}
  var filtered=INV_ALL_ROWS.filter(function(item){
    var hay='';Object.keys(item.row).forEach(function(k){hay+=String(item.row[k]||'')+' ';});
    return hay.toLowerCase().indexOf(q)!==-1;
  });
  renderInvRows(filtered);
}

// ======================================================
//  LOGIC PANEL TOGGLE
// ======================================================
function toggleLogicPanel(){
  var body=document.getElementById('logic-panel-body');
  var chev=document.getElementById('lp-chevron');
  var open=body.classList.toggle('lp-open');
  chev.style.transform=open?'rotate(180deg)':'rotate(0deg)';
}


// ======================================================
//  MISMATCH DRILL-DOWN ENGINE
//  Shows invoice-level cause of each mismatch category
// ======================================================

var DD_MISMATCH_CATS = [];  // categories with INVOICE MISMATCH or VALUE MISMATCH
var DD_CUR_KEY = '';

// Helper: get best invoice/doc number from a row (Composite)
function getCompInvNo(row) {
  var v = getStr(row, 'VOUCHER_NO') || getStr(row, 'INVOICE_NO') || getStr(row, 'DOCUMENT_NO')
        || getStr(row, 'VOUCHER NO') || getStr(row, 'INVOICE NO') || getStr(row, 'DOC NO')
        || getStr(row, 'ENTRY_NO') || getStr(row, 'SALES_INVOICE_NO');
  // fallback: scan all keys for something that looks like an invoice number
  if (!v) {
    var keys = Object.keys(row);
    for (var k = 0; k < keys.length; k++) {
      if (/voucher|invoice|doc.?no|entry.?no/i.test(keys[k])) {
        v = getStr(row, keys[k]);
        if (v) break;
      }
    }
  }
  return v || 'â€”';
}

// Helper: get best invoice/doc number from a row (EMG)
function getEmgInvNo(row) {
  var v = getStr(row, 'Invoice No') || getStr(row, 'Document No') || getStr(row, 'Invoice Number')
        || getStr(row, 'Doc No') || getStr(row, 'INVOICE NO');
  if (!v) {
    var keys = Object.keys(row);
    for (var k = 0; k < keys.length; k++) {
      if (/invoice.?no|doc.?no/i.test(keys[k])) {
        v = getStr(row, keys[k]);
        if (v) break;
      }
    }
  }
  return v || 'â€”';
}

// Helper: normalise invoice no for matching
function normInv(s) {
  return String(s).trim().toLowerCase().replace(/[\s\-\/]/g,'');
}

// Build drill-down tabs for mismatch categories
function buildDrillDownTabs(cats) {
  DD_MISMATCH_CATS = cats.filter(function(c) {
    var st = getCategoryStatus(c.cV, c.eV, c.cRows, c.eRows);
    return st === 'INVOICE MISMATCH' || st === 'VALUE MISMATCH';
  });

  var panel = document.getElementById('mismatch-drilldown');
  var tabBar = document.getElementById('dd-cat-tabs');
  tabBar.innerHTML = '';

  if (DD_MISMATCH_CATS.length === 0) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = 'block';

  DD_MISMATCH_CATS.forEach(function(c, idx) {
    var st = getCategoryStatus(c.cV, c.eV, c.cRows, c.eRows);
    var col = st === 'INVOICE MISMATCH' ? 'var(--danger)' : 'var(--warn)';
    var ico = st === 'INVOICE MISMATCH' ? 'âœ—' : 'âš ';
    var btn = document.createElement('button');
    btn.className = 'inv-tab' + (idx === 0 ? ' active' : '');
    btn.setAttribute('data-key', c.key);
    btn.innerHTML = '<span style="color:' + col + '">' + ico + '</span> ' + c.cat;
    btn.style.borderColor = idx === 0 ? col : '';
    btn.onclick = (function(cat, b, color) {
      return function() {
        document.querySelectorAll('#dd-cat-tabs .inv-tab').forEach(function(x) {
          x.classList.remove('active'); x.style.borderColor = '';
        });
        b.classList.add('active');
        b.style.borderColor = color;
        renderDrillDown(cat.key);
      };
    })(c, btn, col);
    tabBar.appendChild(btn);
  });

  if (DD_MISMATCH_CATS.length > 0) renderDrillDown(DD_MISMATCH_CATS[0].key);
}

// Core drill-down render
function renderDrillDown(key) {
  DD_CUR_KEY = key;
  var cat = null;
  for (var i = 0; i < DD_MISMATCH_CATS.length; i++) if (DD_MISMATCH_CATS[i].key === key) { cat = DD_MISMATCH_CATS[i]; break; }
  if (!cat) return;

  var wrap = document.getElementById('dd-tbl-wrap');
  var summaryEl = document.getElementById('dd-summary');
  var st = getCategoryStatus(cat.cV, cat.eV, cat.cRows, cat.eRows);

  // Build invoice-level comparison
  // Step 1: index both sides by (GSTIN + normalised invoice no)
  // Step 2: find: only-in-comp, only-in-emg, in-both-value-differs
  var compMap = {}; // key -> {row, idx, val}
  var emgMap  = {};

  cat.cRows.forEach(function(row, idx) {
    var gstin = (getStr(row, COMP_COL.CP_GSTIN) || 'UNKNOWN').toUpperCase().trim();
    var invno = getCompInvNo(row);
    var normKey = gstin + '::' + normInv(invno);
    // Collect by compound key; if duplicate, append row index
    if (!compMap[normKey]) compMap[normKey] = [];
    compMap[normKey].push({ row: row, val: getNum(row, COMP_COL.TAXABLE_AMOUNT), invno: invno, gstin: gstin, srcLine: idx + 1 });
  });

  cat.eRows.forEach(function(row, idx) {
    var gstin = (getStr(row, EMG_COL.CP_GSTIN) || getStr(row, EMG_COL.GSTIN_TAXPAYER) || 'UNKNOWN').toUpperCase().trim();
    var invno = getEmgInvNo(row);
    var normKey = gstin + '::' + normInv(invno);
    if (!emgMap[normKey]) emgMap[normKey] = [];
    emgMap[normKey].push({ row: row, val: getNum(row, EMG_COL.TAXABLE_VALUE), invno: invno, gstin: gstin, srcLine: idx + 1 });
  });

  // Step 3: classify each key
  var drillRows = [];
  var allKeys = {};
  Object.keys(compMap).forEach(function(k) { allKeys[k] = 1; });
  Object.keys(emgMap).forEach(function(k)  { allKeys[k] = 1; });

  Object.keys(allKeys).forEach(function(k) {
    var cItems = compMap[k] || [];
    var eItems = emgMap[k]  || [];

    if (cItems.length > 0 && eItems.length === 0) {
      // Only in Composite
      cItems.forEach(function(ci) {
        drillRows.push({ issue: 'ONLY IN COMPOSITE', gstin: ci.gstin, invno: ci.invno, compVal: ci.val, emgVal: null, diff: null, compLine: ci.srcLine, emgLine: null, compRow: ci.row, emgRow: null });
      });
    } else if (cItems.length === 0 && eItems.length > 0) {
      // Only in EMG
      eItems.forEach(function(ei) {
        drillRows.push({ issue: 'ONLY IN EMG', gstin: ei.gstin, invno: ei.invno, compVal: null, emgVal: ei.val, diff: null, compLine: null, emgLine: ei.srcLine, compRow: null, emgRow: ei.row });
      });
    } else {
      // Both sides â€” check counts and values
      var maxLen = Math.max(cItems.length, eItems.length);
      for (var m = 0; m < maxLen; m++) {
        var ci2 = cItems[m] || null;
        var ei2 = eItems[m] || null;
        if (ci2 && ei2) {
          var diff = ci2.val - ei2.val;
          var issue = Math.abs(diff) <= 0.01 ? 'MATCH' : 'VALUE DIFFERS';
          drillRows.push({ issue: issue, gstin: ci2.gstin, invno: ci2.invno, compVal: ci2.val, emgVal: ei2.val, diff: diff, compLine: ci2.srcLine, emgLine: ei2.srcLine, compRow: ci2.row, emgRow: ei2.row });
        } else if (ci2) {
          drillRows.push({ issue: 'EXTRA IN COMPOSITE', gstin: ci2.gstin, invno: ci2.invno, compVal: ci2.val, emgVal: null, diff: null, compLine: ci2.srcLine, emgLine: null, compRow: ci2.row, emgRow: null });
        } else {
          drillRows.push({ issue: 'EXTRA IN EMG', gstin: ei2.gstin, invno: ei2.invno, compVal: null, emgVal: ei2.val, diff: null, compLine: null, emgLine: ei2.srcLine, compRow: null, emgRow: ei2.row });
        }
      }
    }
  });

  // Sort: mismatches first
  var issueOrder = { 'ONLY IN COMPOSITE': 0, 'ONLY IN EMG': 1, 'EXTRA IN COMPOSITE': 2, 'EXTRA IN EMG': 3, 'VALUE DIFFERS': 4, 'MATCH': 5 };
  drillRows.sort(function(a, b) { return (issueOrder[a.issue] || 9) - (issueOrder[b.issue] || 9); });

  var onlyComp = drillRows.filter(function(r) { return r.issue === 'ONLY IN COMPOSITE' || r.issue === 'EXTRA IN COMPOSITE'; });
  var onlyEmg  = drillRows.filter(function(r) { return r.issue === 'ONLY IN EMG'       || r.issue === 'EXTRA IN EMG'; });
  var valDiff  = drillRows.filter(function(r) { return r.issue === 'VALUE DIFFERS'; });
  var matched  = drillRows.filter(function(r) { return r.issue === 'MATCH'; });

  var fmt = function(v) {
    if (v === null || v === undefined) return '<span style="color:var(--text3)">â€”</span>';
    return 'â‚¹ ' + v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };
  var esc = function(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };

  var isInvMis = (onlyComp.length + onlyEmg.length) > 0;

  var html = '<table style="width:100%;border-collapse:collapse;min-width:900px;">';
  html += '<thead><tr style="background:var(--ink3);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5;">';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;">Issue Type</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;">GSTIN</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;">Invoice No</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:right;white-space:nowrap;">Composite Value (â‚¹)</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:right;white-space:nowrap;">EMG Value (â‚¹)</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:right;white-space:nowrap;">Difference (â‚¹)</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;">Comp Line #</th>';
  html += '<th style="padding:10px 13px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:left;white-space:nowrap;">EMG Line #</th>';
  html += '</tr></thead><tbody>';

  drillRows.forEach(function(dr) {
    var rowBg = '';
    var badge = '';
    var diffCell = '';

    if (dr.issue === 'ONLY IN COMPOSITE' || dr.issue === 'EXTRA IN COMPOSITE') {
      rowBg = 'background:rgba(255,59,92,0.06);';
      badge = '<span style="background:rgba(59,130,246,0.15);color:#60a5fa;border:1px solid rgba(59,130,246,0.3);padding:2px 8px;border-radius:100px;font-size:9px;font-weight:700;text-transform:uppercase;">Only Composite</span>';
      diffCell = '<span style="color:var(--text3)">â€”</span>';
    } else if (dr.issue === 'ONLY IN EMG' || dr.issue === 'EXTRA IN EMG') {
      rowBg = 'background:rgba(255,59,92,0.06);';
      badge = '<span style="background:rgba(255,107,0,0.12);color:var(--orange);border:1px solid rgba(255,107,0,0.3);padding:2px 8px;border-radius:100px;font-size:9px;font-weight:700;text-transform:uppercase;">Only EMG</span>';
      diffCell = '<span style="color:var(--text3)">â€”</span>';
    } else if (dr.issue === 'VALUE DIFFERS') {
      rowBg = 'background:rgba(245,158,11,0.05);';
      badge = '<span style="background:rgba(245,158,11,0.12);color:var(--warn);border:1px solid rgba(245,158,11,0.3);padding:2px 8px;border-radius:100px;font-size:9px;font-weight:700;text-transform:uppercase;">Value Differs</span>';
      var dv = dr.diff;
      var dcolor = dv > 0 ? 'var(--success)' : 'var(--danger)';
      diffCell = '<span style="color:' + dcolor + ';font-family:monospace">â‚¹ ' + Math.abs(dv).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + (dv > 0 ? ' â†‘Comp higher' : ' â†“EMG higher') + '</span>';
    } else {
      rowBg = '';
      badge = '<span style="background:rgba(0,219,160,0.1);color:var(--success);border:1px solid rgba(0,219,160,0.25);padding:2px 8px;border-radius:100px;font-size:9px;font-weight:700;text-transform:uppercase;">âœ“ Match</span>';
      diffCell = '<span style="color:var(--success)">â‚¹ 0.00</span>';
    }

    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.03);' + rowBg + '">';
    html += '<td style="padding:9px 13px;font-size:12px;">' + badge + '</td>';
    html += '<td style="padding:9px 13px;font-size:11px;font-family:monospace;color:var(--text2)">' + esc(dr.gstin) + '</td>';
    html += '<td style="padding:9px 13px;font-size:11px;font-family:monospace;color:var(--text)">' + esc(dr.invno) + '</td>';
    html += '<td style="padding:9px 13px;font-size:12px;text-align:right;font-family:monospace;">' + fmt(dr.compVal) + '</td>';
    html += '<td style="padding:9px 13px;font-size:12px;text-align:right;font-family:monospace;">' + fmt(dr.emgVal) + '</td>';
    html += '<td style="padding:9px 13px;font-size:12px;text-align:right;">' + diffCell + '</td>';
    html += '<td style="padding:9px 13px;font-size:11px;color:var(--text3)">' + (dr.compLine ? 'Row ' + dr.compLine : '<span style="color:var(--text3)">â€”</span>') + '</td>';
    html += '<td style="padding:9px 13px;font-size:11px;color:var(--text3)">' + (dr.emgLine  ? 'Row ' + dr.emgLine  : '<span style="color:var(--text3)">â€”</span>') + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';

  if (drillRows.length === 0) {
    wrap.innerHTML = '<div style="padding:40px;text-align:center;font-size:12px;color:var(--text3);">No invoice-level data found for this category (invoice numbers may not be present in the files).</div>';
  } else {
    wrap.innerHTML = html;
  }

  // Summary
  summaryEl.style.display = 'block';
  var totalCompVal = cat.cV !== null ? cat.cV : 0;
  var totalEmgVal  = cat.eV !== null ? cat.eV : 0;
  summaryEl.innerHTML =
    '<strong style="color:var(--text)">ğŸ“Š ' + esc(cat.cat) + ' â€” Mismatch Summary:</strong><br>' +
    '&nbsp;&nbsp;â€¢ <span style="color:var(--blue2)">Only in Composite</span>: <b>' + onlyComp.length + ' invoice(s)</b> â€” â‚¹ ' + onlyComp.reduce(function(s,r){return s+(r.compVal||0);},0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + '<br>' +
    '&nbsp;&nbsp;â€¢ <span style="color:var(--orange)">Only in EMG</span>: <b>' + onlyEmg.length + ' invoice(s)</b> â€” â‚¹ ' + onlyEmg.reduce(function(s,r){return s+(r.emgVal||0);},0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + '<br>' +
    '&nbsp;&nbsp;â€¢ <span style="color:var(--warn)">Value differs (same GSTIN+Invoice)</span>: <b>' + valDiff.length + ' invoice(s)</b>' + (valDiff.length > 0 ? ' â€” total diff â‚¹ ' + Math.abs(valDiff.reduce(function(s,r){return s+(r.diff||0);},0)).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) : '') + '<br>' +
    '&nbsp;&nbsp;â€¢ <span style="color:var(--success)">Matched invoices</span>: <b>' + matched.length + ' invoice(s)</b><br>' +
    '&nbsp;&nbsp;â€¢ <strong>Composite total: â‚¹ ' + totalCompVal.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</strong> &nbsp;|&nbsp; <strong>EMG total: â‚¹ ' + totalEmgVal.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</strong> &nbsp;|&nbsp; <strong style="color:' + (Math.abs(totalCompVal - totalEmgVal) > 1 ? 'var(--danger)' : 'var(--success)') + '">Net diff: â‚¹ ' + (totalCompVal - totalEmgVal).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</strong>';
}

// ======================================================
//  INVOICE MATCH SUMMARY â€” shown in UI after recon
// ======================================================
function buildInvMatchSummary(cats) {
  var banner = document.getElementById('inv-match-banner');
  var grid   = document.getElementById('inv-match-grid');
  var totEl  = document.getElementById('inv-match-total');
  if (!banner || !grid || !totEl) return;

  grid.innerHTML = '';
  var grandTotalInv = 0, grandMatchedInv = 0;

  cats.forEach(function(c) {
    if (c.key === 'nil') return; // EMG-only, skip side-by-side
    var st = getCategoryStatus(c.cV, c.eV, c.cRows, c.eRows);

    // Build invoice-level match count for this category
    var compMap = {}, emgMap = {};
    c.cRows.forEach(function(row) {
      var gstin = (getStr(row, COMP_COL.CP_GSTIN)||'UNKNOWN').toUpperCase().trim();
      var inv   = normInv(getCompInvNo(row));
      var k     = gstin + '::' + inv;
      if (!compMap[k]) compMap[k] = 0;
      compMap[k]++;
    });
    c.eRows.forEach(function(row) {
      var gstin = (getStr(row, EMG_COL.CP_GSTIN)||getStr(row,EMG_COL.GSTIN_TAXPAYER)||'UNKNOWN').toUpperCase().trim();
      var inv   = normInv(getEmgInvNo(row));
      var k     = gstin + '::' + inv;
      if (!emgMap[k]) emgMap[k] = 0;
      emgMap[k]++;
    });

    // Count matched: keys present in both sides
    var allK = {}, matched = 0;
    Object.keys(compMap).forEach(function(k){ allK[k]=1; });
    Object.keys(emgMap).forEach(function(k){ allK[k]=1; });
    Object.keys(allK).forEach(function(k){
      if (compMap[k] && emgMap[k]) matched += Math.min(compMap[k], emgMap[k]);
    });
    var total = Math.max(c.cRows.length, c.eRows.length);
    grandTotalInv   += total;
    grandMatchedInv += matched;

    var pct = total > 0 ? Math.round((matched/total)*100) : 100;
    var col = pct === 100 ? '#00dba0' : pct >= 70 ? '#f59e0b' : '#ff3b5c';

    var div = document.createElement('div');
    div.style.cssText = 'background:rgba(0,0,0,0.25);border:1px solid var(--border);border-radius:10px;padding:12px;';
    div.innerHTML =
      '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:6px;">' + c.cat + '</div>' +
      '<div style="font-size:20px;font-weight:800;color:' + col + ';font-family:Syne,sans-serif;">' + matched + ' / ' + total + '</div>' +
      '<div style="font-size:10px;color:var(--text3);margin-top:2px;">' + pct + '% matched</div>' +
      '<div style="margin-top:6px;height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;">' +
        '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:2px;transition:width 0.5s;"></div>' +
      '</div>';
    grid.appendChild(div);
  });

  var grandPct = grandTotalInv > 0 ? Math.round((grandMatchedInv/grandTotalInv)*100) : 100;
  totEl.innerHTML =
    '<strong style="color:var(--text)">Grand Total:</strong> &nbsp;' +
    '<span style="color:#00dba0;font-weight:700">' + grandMatchedInv.toLocaleString() + ' invoices matched</span>' +
    ' out of <strong>' + grandTotalInv.toLocaleString() + ' total</strong>' +
    ' &nbsp;=&nbsp; <strong style="color:' + (grandPct===100?'#00dba0':grandPct>=70?'#f59e0b':'#ff3b5c') + '">' + grandPct + '% match rate</strong>';

  banner.style.display = 'block';
}

// ======================================================
//  SIDE-BY-SIDE INVOICE PAIRING ENGINE (for Excel + UI)
// ======================================================
// Returns array of paired rows: {compRow, emgRow, matchStatus, diffAmt, invoiceNo, gstin, correctionNote}
function buildSideBySidePairs(catKey) {
  var cat = RESULTS_STORE[catKey];
  if (!cat) return [];

  var compMap = {}, emgMap = {};

  cat.cRows.forEach(function(row, idx) {
    var gstin  = (getStr(row, COMP_COL.CP_GSTIN)||'UNKNOWN').toUpperCase().trim();
    var invno  = getCompInvNo(row);
    var normK  = gstin + '::' + normInv(invno);
    if (!compMap[normK]) compMap[normK] = [];
    compMap[normK].push({ row: row, val: getNum(row, COMP_COL.TAXABLE_AMOUNT), invno: invno, gstin: gstin, srcLine: idx+1 });
  });
  cat.eRows.forEach(function(row, idx) {
    var gstin  = (getStr(row, EMG_COL.CP_GSTIN)||getStr(row,EMG_COL.GSTIN_TAXPAYER)||'UNKNOWN').toUpperCase().trim();
    var invno  = getEmgInvNo(row);
    var normK  = gstin + '::' + normInv(invno);
    if (!emgMap[normK]) emgMap[normK] = [];
    emgMap[normK].push({ row: row, val: getNum(row, EMG_COL.TAXABLE_VALUE), invno: invno, gstin: gstin, srcLine: idx+1 });
  });

  var allKeys = {}, pairs = [];
  Object.keys(compMap).forEach(function(k){ allKeys[k]=1; });
  Object.keys(emgMap).forEach(function(k){ allKeys[k]=1; });

  function correctionNote(issue, diff, invno, gstin, catLabel) {
    var notes = {
      'MATCH':             'Invoice matched correctly. No action needed.',
      'VALUE DIFFERS':     'Invoice "' + invno + '" (GSTIN: ' + gstin + ') found in both files but taxable value differs by â‚¹' + Math.abs(diff).toFixed(2) + '. ' +
                           (diff > 0 ? 'Composite shows higher value â€” verify if EMG sync missed an amendment or partial credit.' : 'EMG shows higher value â€” check if Composite has a partial/reversed entry.') +
                           ' Action: Cross-verify original invoice in Ginesys and match with IRN on EaseMyGST.',
      'ONLY IN COMPOSITE': 'Invoice "' + invno + '" (GSTIN: ' + gstin + ') exists in Composite (Ginesys) but is MISSING in EMG sync. ' +
                           'Possible causes: (1) Invoice not yet synced to EaseMyGST, (2) Invoice filtered out due to status mismatch, (3) GSTIN mismatch between systems. ' +
                           'Action: Re-sync this invoice from Ginesys to EaseMyGST, or check if GSTIN/invoice number differs slightly.',
      'ONLY IN EMG':       'Invoice "' + invno + '" (GSTIN: ' + gstin + ') exists in EMG sync but is MISSING in Composite (Ginesys). ' +
                           'Possible causes: (1) Invoice manually added in EaseMyGST without Ginesys entry, (2) Cancelled in Ginesys but not in EMG, (3) Wrong category mapping. ' +
                           'Action: Check if this invoice was manually entered in EMG. If cancelled in Ginesys, cancel the corresponding entry in EaseMyGST.',
      'EXTRA IN COMPOSITE':'Duplicate/extra invoice "' + invno + '" in Composite (row count > EMG for this GSTIN+Invoice). ' +
                           'Action: Check for duplicate entries in Ginesys for invoice "' + invno + '".',
      'EXTRA IN EMG':      'Duplicate/extra invoice "' + invno + '" in EMG (row count > Composite for this GSTIN+Invoice). ' +
                           'Action: Check for duplicate entries in EaseMyGST for invoice "' + invno + '".'
    };
    return notes[issue] || 'Unknown issue. Manual review required.';
  }

  Object.keys(allKeys).forEach(function(k) {
    var cItems = compMap[k] || [];
    var eItems = emgMap[k]  || [];

    if (cItems.length > 0 && eItems.length === 0) {
      cItems.forEach(function(ci) {
        pairs.push({ gstin:ci.gstin, invno:ci.invno, compLine:ci.srcLine, emgLine:null,
          compVal:ci.val, emgVal:null, diff:ci.val, issue:'ONLY IN COMPOSITE', compRow:ci.row, emgRow:null,
          note: correctionNote('ONLY IN COMPOSITE', ci.val, ci.invno, ci.gstin) });
      });
    } else if (cItems.length === 0 && eItems.length > 0) {
      eItems.forEach(function(ei) {
        pairs.push({ gstin:ei.gstin, invno:ei.invno, compLine:null, emgLine:ei.srcLine,
          compVal:null, emgVal:ei.val, diff:-ei.val, issue:'ONLY IN EMG', compRow:null, emgRow:ei.row,
          note: correctionNote('ONLY IN EMG', -ei.val, ei.invno, ei.gstin) });
      });
    } else {
      var maxLen = Math.max(cItems.length, eItems.length);
      for (var m = 0; m < maxLen; m++) {
        var ci2 = cItems[m]||null, ei2 = eItems[m]||null;
        if (ci2 && ei2) {
          var dv = ci2.val - ei2.val;
          var iss = Math.abs(dv) <= 0.01 ? 'MATCH' : 'VALUE DIFFERS';
          pairs.push({ gstin:ci2.gstin, invno:ci2.invno, compLine:ci2.srcLine, emgLine:ei2.srcLine,
            compVal:ci2.val, emgVal:ei2.val, diff:dv, issue:iss, compRow:ci2.row, emgRow:ei2.row,
            note: correctionNote(iss, dv, ci2.invno, ci2.gstin) });
        } else if (ci2) {
          pairs.push({ gstin:ci2.gstin, invno:ci2.invno, compLine:ci2.srcLine, emgLine:null,
            compVal:ci2.val, emgVal:null, diff:ci2.val, issue:'EXTRA IN COMPOSITE', compRow:ci2.row, emgRow:null,
            note: correctionNote('EXTRA IN COMPOSITE', ci2.val, ci2.invno, ci2.gstin) });
        } else {
          pairs.push({ gstin:ei2.gstin, invno:ei2.invno, compLine:null, emgLine:ei2.srcLine,
            compVal:null, emgVal:ei2.val, diff:-ei2.val, issue:'EXTRA IN EMG', compRow:null, emgRow:ei2.row,
            note: correctionNote('EXTRA IN EMG', -ei2.val, ei2.invno, ei2.gstin) });
        }
      }
    }
  });

  // Sort: mismatches first
  var order = {'ONLY IN COMPOSITE':0,'ONLY IN EMG':1,'EXTRA IN COMPOSITE':2,'EXTRA IN EMG':3,'VALUE DIFFERS':4,'MATCH':5};
  pairs.sort(function(a,b){ return (order[a.issue]||9)-(order[b.issue]||9); });
  return pairs;
}

// ======================================================
//  EXPORT EXCEL â€” SIDE-BY-SIDE WITH CORRECTIONS
// ======================================================
function exportExcel(){
  if(!Object.keys(RESULTS_STORE).length)return;
  var wb=XLSX.utils.book_new();
  var ord=['b2b_ri','b2b_cdn','b2cs','exp_ri','exp_cdn','non_gst','exempt','nil'];
  var sn={b2b_ri:'B2B_RI',b2b_cdn:'B2B_CDN',b2cs:'B2CS',exp_ri:'Export_RI',exp_cdn:'Export_CDN',non_gst:'Non_GST',exempt:'Exempt',nil:'Nil_Rated'};

  // â”€â”€ SUMMARY SHEET â”€â”€
  var tC=0,tE=0,grandTotalInv=0,grandMatchedInv=0;
  var sumRows=[
    ['GSTR-1 Reconciliation Report â€” Side-by-Side Invoice Analysis'],
    ['Generated: '+new Date().toLocaleString('en-IN')],
    ['B2B CDN Logic: Composite = Sales Credit/Debit Note (GSTIN present) OR Outward Supply (GSTIN present + Taxable < 0). EMG = B2B + DocType C/D'],
    [],
    ['Category','Comp Taxable (â‚¹)','EMG Taxable (â‚¹)','Difference (â‚¹)','Category Status','Comp Rows','EMG Rows','Matched Invoices','Total Invoices','Match %']
  ];

  ord.forEach(function(k){
    var r=RESULTS_STORE[k]; if(!r)return;
    var d=(r.cV!==null&&r.eV!==null)?r.cV-r.eV:null;
    var st=d===null?'N/A':getCategoryStatus(r.cV,r.eV,r.cRows,r.eRows);
    if(r.cV!==null)tC+=r.cV; if(r.eV!==null)tE+=r.eV;

    var matchedInv=0, totalInv=0;
    if(k!=='nil'){
      var pairs=buildSideBySidePairs(k);
      matchedInv=pairs.filter(function(p){return p.issue==='MATCH';}).length;
      totalInv=pairs.length;
      grandMatchedInv+=matchedInv; grandTotalInv+=totalInv;
    }
    var pct = totalInv>0 ? (matchedInv/totalInv*100).toFixed(1)+'%' : 'N/A';
    sumRows.push([r.cat, r.cV!==null?r.cV:'N/A', r.eV!==null?r.eV:'N/A', d!==null?d:'N/A', st, r.cRows.length, r.eRows.length, matchedInv, totalInv, pct]);
  });

  var grandDiff=Math.abs(tC-tE);
  var grandSt=grandDiff<=TOL_MATCH?'MATCH':grandDiff<=TOL_DEEMED?'DEEMED MATCH':'VALUE MISMATCH';
  var grandPct = grandTotalInv>0 ? (grandMatchedInv/grandTotalInv*100).toFixed(1)+'%' : 'N/A';
  sumRows.push([]);
  sumRows.push(['GRAND TOTAL', tC, tE, tC-tE, grandSt, '', '', grandMatchedInv, grandTotalInv, grandPct]);
  sumRows.push([]);
  sumRows.push(['NOTE: "Matched Invoices" = invoices with same GSTIN + Invoice No on both sides with value difference â‰¤ â‚¹0.01']);

  var wsSum=XLSX.utils.aoa_to_sheet(sumRows);
  wsSum['!cols']=[{wch:32},{wch:20},{wch:18},{wch:16},{wch:18},{wch:12},{wch:12},{wch:18},{wch:16},{wch:12}];
  XLSX.utils.book_append_sheet(wb,wsSum,'Summary');

  // â”€â”€ PER-CATEGORY SIDE-BY-SIDE SHEETS â”€â”€
  ord.forEach(function(k){
    var r=RESULTS_STORE[k]; if(!r)return;

    if(k==='nil'){
      // EMG-only â€” simple listing
      var nilRows=[['NIL RATED â€” EMG Only (No Composite Filter)'],['EMG Taxable Total: '+r.eV],[]];
      if(r.eRows.length>0){
        var eh=Object.keys(r.eRows[0]); nilRows.push(eh);
        r.eRows.forEach(function(row){ nilRows.push(eh.map(function(h){return row[h]!==undefined?row[h]:'';})); });
      } else { nilRows.push(['No rows']); }
      var wsNil=XLSX.utils.aoa_to_sheet(nilRows); wsNil['!cols']=Array(20).fill({wch:22});
      XLSX.utils.book_append_sheet(wb,wsNil,sn[k]);
      return;
    }

    var pairs=buildSideBySidePairs(k);
    var st=getCategoryStatus(r.cV,r.eV,r.cRows,r.eRows);

    // Header section
    var sheetRows=[
      [r.cat+' â€” Side-by-Side Invoice Reconciliation'],
      ['Filter Logic: '+r.sub],
      ['Category Status: '+st],
      ['Composite Total: '+(r.cV!==null?r.cV:0)+'  |  EMG Total: '+(r.eV!==null?r.eV:0)+'  |  Difference: '+((r.cV!==null&&r.eV!==null)?r.cV-r.eV:0)],
      ['Total Pairs: '+pairs.length+'  |  Matched: '+pairs.filter(function(p){return p.issue==='MATCH';}).length+'  |  Mismatched: '+pairs.filter(function(p){return p.issue!=='MATCH';}).length],
      []
    ];

    // Column headers â€” COMPOSITE side | EMG side | COMPARISON
    var compSampleRow = r.cRows[0] || null;
    var emgSampleRow  = r.eRows[0] || null;
    var compCols = compSampleRow ? Object.keys(compSampleRow) : [];
    var emgCols  = emgSampleRow  ? Object.keys(emgSampleRow)  : [];

    // Fixed comparison columns first, then full Composite columns, then full EMG columns
    var headerRow = [
      // Comparison block
      'Match Status', 'GSTIN', 'Invoice No (Comp)', 'Invoice No (EMG)',
      'Comp Line #', 'EMG Line #',
      'Comp Taxable Value (â‚¹)', 'EMG Taxable Value (â‚¹)', 'Difference (â‚¹)', 'Difference Direction',
      // Composite detail columns
      '--- COMPOSITE FILE ---'
    ];
    compCols.forEach(function(c){ headerRow.push('C: '+c); });
    headerRow.push('--- EMG FILE ---');
    emgCols.forEach(function(c){ headerRow.push('E: '+c); });
    headerRow.push('--- CORRECTION GUIDE ---');
    headerRow.push('Error Explanation & How to Fix');

    sheetRows.push(headerRow);

    pairs.forEach(function(p){
      var diffDir = p.diff === null ? '' : p.diff > 0.01 ? 'Composite Higher â†‘' : p.diff < -0.01 ? 'EMG Higher â†‘' : 'Equal';
      var invNoComp = p.compRow ? getCompInvNo(p.compRow) : 'â€”';
      var invNoEmg  = p.emgRow  ? getEmgInvNo(p.emgRow)   : 'â€”';
      var row = [
        p.issue,
        p.gstin,
        invNoComp,
        invNoEmg,
        p.compLine !== null ? p.compLine : 'â€”',
        p.emgLine  !== null ? p.emgLine  : 'â€”',
        p.compVal !== null ? p.compVal : 'â€”',
        p.emgVal  !== null ? p.emgVal  : 'â€”',
        p.diff    !== null ? p.diff    : 'â€”',
        diffDir,
        ''  // separator
      ];
      // Composite columns
      compCols.forEach(function(c){ row.push(p.compRow ? (p.compRow[c]!==undefined?p.compRow[c]:'') : ''); });
      row.push(''); // separator
      // EMG columns
      emgCols.forEach(function(c){ row.push(p.emgRow ? (p.emgRow[c]!==undefined?p.emgRow[c]:'') : ''); });
      row.push(''); // separator
      row.push(p.note);
      sheetRows.push(row);
    });

    // Totals row
    sheetRows.push([]);
    var matchedC = pairs.filter(function(p){return p.issue==='MATCH';});
    var onlyComp = pairs.filter(function(p){return p.issue==='ONLY IN COMPOSITE'||p.issue==='EXTRA IN COMPOSITE';});
    var onlyEmg  = pairs.filter(function(p){return p.issue==='ONLY IN EMG'||p.issue==='EXTRA IN EMG';});
    var valDiff  = pairs.filter(function(p){return p.issue==='VALUE DIFFERS';});
    sheetRows.push(['SUMMARY','','','','','',
      r.cV!==null?r.cV:'', r.eV!==null?r.eV:'',
      (r.cV!==null&&r.eV!==null)?r.cV-r.eV:'', '',''
    ]);
    sheetRows.push(['  Matched invoices: '+matchedC.length]);
    sheetRows.push(['  Only in Composite: '+onlyComp.length+' invoices, Total: â‚¹'+onlyComp.reduce(function(s,p){return s+(p.compVal||0);},0).toFixed(2)]);
    sheetRows.push(['  Only in EMG: '+onlyEmg.length+' invoices, Total: â‚¹'+onlyEmg.reduce(function(s,p){return s+(p.emgVal||0);},0).toFixed(2)]);
    sheetRows.push(['  Value differs: '+valDiff.length+' invoices, Total diff: â‚¹'+Math.abs(valDiff.reduce(function(s,p){return s+(p.diff||0);},0)).toFixed(2)]);

    var ws=XLSX.utils.aoa_to_sheet(sheetRows);
    // Set column widths
    var colWidths=[{wch:22},{wch:20},{wch:22},{wch:22},{wch:12},{wch:12},{wch:22},{wch:22},{wch:16},{wch:20},{wch:5}];
    compCols.forEach(function(){colWidths.push({wch:20});});
    colWidths.push({wch:5});
    emgCols.forEach(function(){colWidths.push({wch:20});});
    colWidths.push({wch:5},{wch:80});
    ws['!cols']=colWidths;
    XLSX.utils.book_append_sheet(wb,ws,sn[k]||k);
  });

  XLSX.writeFile(wb,'GSTR1_Recon_SideBySide_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setProg(show,pct,msg){
  document.getElementById('prog-wrap').style.display=show?'block':'none';
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-lbl').textContent=msg;
  var btn=document.getElementById('btn-run');
  btn.disabled=show&&pct<100;
  btn.innerHTML=(show&&pct<100)?'<span class="spin"></span>Processing...':'âš¡ Run Reconciliation';
}
function showErr(m){var e=document.getElementById('err-bar');e.innerHTML='âš  '+m;e.style.display='block';}
function clearErr(){document.getElementById('err-bar').style.display='none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAQ LANGUAGE & CONTENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var selectedLang = 'en';

function setLanguage(lang) {
  selectedLang = lang;
  navigate('screen-faq-category');
}

function loadFAQ(type) {
  navigate('screen-faq-content');
  var labels = { einvoice: 'E-Invoice', eway: 'E-Way Bill', gstr: 'GSTR' };
  var lbl = labels[type] || type;
  document.getElementById('faq-breadcrumb-label').textContent = lbl;
  document.getElementById('faq-content-title').innerHTML = '<em>' + lbl + '</em> FAQs';

  var container = document.getElementById('faq-container');
  container.innerHTML = '';

  // Customer support banner
  var support = document.createElement("div");
  support.style.marginBottom = "20px";
  support.style.padding = "15px";
  support.style.background = "#fff3eb";
  support.style.border = "1px solid #ff6b00";
  support.style.borderRadius = "8px";
  support.style.color = "#111";
  support.style.fontFamily = "'Inter',sans-serif";
  support.innerHTML = "<strong>Ease My GST Customer Support:</strong> 08068175757";
  container.appendChild(support);

  var data = {
    en: {
      einvoice: [
        { q: 'What is E-Invoice?', a: 'E-Invoice is an electronically generated invoice validated and registered by the GST IRP portal, which assigns a unique IRN (Invoice Reference Number) and QR code to each invoice.' },
        { q: 'Who needs to generate E-Invoices?', a: 'Businesses with aggregate annual turnover above â‚¹5 crore in any preceding financial year are required to generate E-Invoices for B2B transactions.' },
        { q: 'What is the time limit to generate IRN?', a: 'Invoices must be uploaded within 7 days of the invoice date if the taxpayer\'s turnover exceeds â‚¹100 crore. For others, there is currently no specific deadline but timely upload is recommended.' },
        { q: 'Can an E-Invoice be cancelled?', a: 'Yes, an E-Invoice can be cancelled within 24 hours of IRN generation on the IRP portal. After 24 hours, cancellation must be done on the GST portal.' },
        { q: 'Is E-Invoice mandatory for B2C transactions?', a: 'No, E-Invoice is currently mandatory only for B2B, B2G, and export transactions. B2C invoices are not required to be reported on the IRP portal.' },
        { q: 'What is IRN?', a: 'IRN stands for Invoice Reference Number â€” a unique number generated by the IRP portal for each valid e-invoice.' },
        { q: 'Is QR code mandatory on e-invoice?', a: 'Yes, a QR code containing key invoice details must be printed on every e-invoice.' },
        { q: 'Can IRN be generated twice for same invoice?', a: 'No, duplicate IRN generation is not allowed. Each invoice can have only one valid IRN.' },
        { q: 'Is e-invoice required for export transactions?', a: 'Yes, export invoices also require IRN generation on the IRP portal if the turnover threshold is met.' },
        { q: 'Can we edit an e-invoice after IRN is generated?', a: 'No, once IRN is generated the invoice cannot be edited. You must cancel it within 24 hours and reissue a corrected invoice.' },
        { q: 'What is the penalty for not generating IRN?', a: 'Invoices without IRN are treated as invalid under GST law and can attract penalties and ITC reversal for the recipient.' },
        { q: 'Which portal generates IRN?', a: 'The Invoice Registration Portal (IRP) under the GST framework generates IRN for e-invoices.' },
        { q: 'Is API integration available for e-invoicing?', a: 'Yes, businesses can integrate with the IRP via GSP (GST Suvidha Providers) for automated IRN generation through APIs.' },
        { q: 'Is e-invoice currently required for B2C?', a: 'B2C transactions are not currently mandated to generate e-invoices on the IRP portal.' },
        { q: 'Is digital signature required on e-invoice?', a: 'A digital signature is optional but recommended for authenticity. The IRP-generated IRN and QR code serve as authentication.' },
        { q: 'Can multiple e-way bills be generated from one IRN?', a: 'Yes, you can generate multiple e-way bills from a single IRN depending on logistics requirements.' },
        { q: 'Does IRN auto-update GSTR-1?', a: 'Yes, e-invoices with valid IRN auto-populate in GSTR-1, reducing manual data entry.' },
        { q: 'Is amendment of e-invoice allowed?', a: 'Direct amendment is not possible. Corrections must be made through a credit note or debit note.' },
        { q: 'Is the turnover threshold calculated yearly?', a: 'Yes, the e-invoice applicability threshold is based on aggregate turnover in any preceding financial year.' },
        { q: 'Is IRN required under RCM?', a: 'Yes, if the recipient\'s turnover meets the threshold, IRN must be generated even for RCM transactions.' }
      ],
      eway: [
        { q: 'When is an E-Way Bill required?', a: 'An E-Way Bill is required when the value of goods being transported exceeds â‚¹50,000, either for supply, return, or job work purposes.' },
        { q: 'What is the validity of an E-Way Bill?', a: 'The validity depends on the distance: 1 day for up to 200 km, and 1 additional day for every 200 km or part thereof beyond that. For over-dimensional cargo, validity is halved.' },
        { q: 'Can we cancel an E-Way Bill?', a: 'Yes, an E-Way Bill can be cancelled within 24 hours of its generation, provided goods have not been verified by a tax officer in transit.' },
        { q: 'Who can generate an E-Way Bill?', a: 'The registered supplier, recipient, or the transporter can generate an E-Way Bill. If the supplier does not generate it, the transporter must.' },
        { q: 'Can the validity of an E-Way Bill be extended?', a: 'Yes, an E-Way Bill can be extended before 8 hours of its expiry or within 8 hours after its expiry by the person who generated it or the transporter.' },
        { q: 'What is the threshold limit for E-Way Bill?', a: 'The threshold limit is â‚¹50,000 in value of goods being transported.' },
        { q: 'Can Part B of E-Way Bill be updated?', a: 'Yes, Part B (vehicle details) can be updated any time before the E-Way Bill expires.' },
        { q: 'How is distance calculated for E-Way Bill validity?', a: 'Distance is calculated based on PIN codes of the origin and destination as mapped in the E-Way Bill portal.' },
        { q: 'What is a Consolidated E-Way Bill?', a: 'A Consolidated E-Way Bill is generated by a transporter to carry multiple consignments in a single vehicle under one document.' },
        { q: 'What is the penalty for travelling without E-Way Bill?', a: 'Goods may be detained and a penalty of â‚¹10,000 or the tax amount (whichever is higher) can be levied.' },
        { q: 'Can the transporter generate an E-Way Bill?', a: 'Yes, if the supplier or recipient fails to generate the E-Way Bill, the transporter can generate it based on the invoice details.' },
        { q: 'Can E-Way Bill validity be extended after expiry?', a: 'Yes, extension is allowed up to 8 hours after expiry in genuine cases.' },
        { q: 'Is E-Way Bill required for job work?', a: 'Yes, movement of goods for job work also requires an E-Way Bill if the value exceeds the threshold.' },
        { q: 'Is E-Way Bill required for services?', a: 'No, E-Way Bill is applicable only for movement of goods, not services.' },
        { q: 'Can E-Way Bill be updated for multiple vehicles?', a: 'Yes, if goods are transhipped, the E-Way Bill can be updated with new vehicle details via the "Update Vehicle" option.' },
        { q: 'Can a cancelled E-Way Bill be reused?', a: 'No, once an E-Way Bill is cancelled it cannot be reused or reinstated.' },
        { q: 'Can E-Way Bill be blocked?', a: 'Yes, E-Way Bill generation can be blocked for taxpayers who have not filed GSTR-3B for two or more consecutive months.' },
        { q: 'Who generates E-Way Bill for unregistered suppliers?', a: 'When the supplier is unregistered, the recipient must generate the E-Way Bill.' },
        { q: 'What is the E-Way Bill portal URL?', a: 'The official E-Way Bill portal is ewaybillgst.gov.in.' },
        { q: 'Is E-Way Bill required for intra-state movement?', a: 'Yes, most states have adopted E-Way Bills for intra-state movement of goods above â‚¹50,000.' }
      ],
      gstr: [
        { q: 'What is GSTR-1?', a: 'GSTR-1 is a monthly or quarterly return that every registered taxpayer must file to declare outward supplies (sales) of goods and services.' },
        { q: 'What is GSTR-2B?', a: 'GSTR-2B is an auto-drafted, static ITC (Input Tax Credit) statement generated on the 14th of every month based on suppliers\' GSTR-1, GSTR-5, and GSTR-6 filings.' },
        { q: 'What is the due date for GSTR-1?', a: 'For monthly filers, GSTR-1 is due on the 11th of the following month. For quarterly filers (QRMP scheme), it is due on the 13th of the month following the quarter.' },
        { q: 'Can GSTR-1 be revised after filing?', a: 'GSTR-1 cannot be revised once filed. Corrections must be made in the next period\'s return by making amendments in Table 9A, 9B, or 9C.' },
        { q: 'What is the difference between GSTR-2A and GSTR-2B?', a: 'GSTR-2A is a dynamic document that updates continuously as suppliers file returns. GSTR-2B is a static document generated once a month on the 14th, showing ITC available for that specific tax period.' },
        { q: 'What is GSTR-3B?', a: 'GSTR-3B is a monthly self-declared summary return used to report summary GST liabilities and claim input tax credit.' },
        { q: 'What is the due date for GSTR-3B?', a: 'GSTR-3B is generally due on the 20th of the following month, though dates vary for different taxpayer categories.' },
        { q: 'What is Input Tax Credit (ITC)?', a: 'ITC is the credit a business can claim for GST paid on purchases, which can be used to offset GST liability on sales.' },
        { q: 'What is the late fee for GST returns?', a: 'The late fee is â‚¹50 per day (â‚¹25 CGST + â‚¹25 SGST) for regular returns, and â‚¹20 per day for nil returns.' },
        { q: 'Is nil return mandatory?', a: 'Yes, even if there are no transactions in a period, a nil return must be filed to avoid late fees and penalties.' },
        { q: 'What is the QRMP scheme?', a: 'The Quarterly Return Monthly Payment (QRMP) scheme allows small taxpayers with turnover up to â‚¹5 crore to file GSTR-1 and GSTR-3B quarterly while paying tax monthly.' },
        { q: 'What is CMP-08?', a: 'CMP-08 is a quarterly challan-cum-return filed by composition scheme dealers to declare tax payable.' },
        { q: 'What is GSTR-9?', a: 'GSTR-9 is the annual return that consolidates all monthly/quarterly returns filed during the financial year.' },
        { q: 'Is reconciliation required for GST audit?', a: 'Yes, GSTR-9C requires a reconciliation statement between audited annual accounts and GST returns.' },
        { q: 'What is the structure of GSTIN?', a: 'GSTIN is a 15-digit alphanumeric code: first 2 digits are state code, next 10 are PAN, 13th is entity number, 14th is Z by default, and 15th is a checksum digit.' },
        { q: 'What are blocked ITC credits?', a: 'Certain goods and services like motor vehicles for personal use, food and beverages, and club memberships have ITC blocked under Section 17(5) of CGST Act.' },
        { q: 'How is GST refund processed?', a: 'GST refunds are applied through the GST portal under the RFD-01 form and are processed by the tax officer within 60 days of application.' },
        { q: 'What is the interest rate on delayed GST payment?', a: 'Interest is levied at 18% per annum on delayed payment of GST liability.' },
        { q: 'Can ITC be claimed on capital goods?', a: 'Yes, ITC is allowed on capital goods subject to conditions. However, if the goods are used for both taxable and exempt supplies, ITC must be apportioned.' },
        { q: 'What happens if GSTR-1 and GSTR-3B are mismatched?', a: 'Mismatches between GSTR-1 and GSTR-3B can lead to notices from the GST department and potential reversal of ITC claimed by recipients.' }
      ]
    },
    hi: {
      einvoice: [
        { q: 'à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?', a: 'à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ GST à¤•à¥‡ IRP à¤ªà¥‹à¤°à¥à¤Ÿà¤² à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤¸à¤¤à¥à¤¯à¤¾à¤ªà¤¿à¤¤ à¤à¤• à¤‡à¤²à¥‡à¤•à¥à¤Ÿà¥à¤°à¥‰à¤¨à¤¿à¤• à¤šà¤¾à¤²à¤¾à¤¨ à¤¹à¥ˆ, à¤œà¤¿à¤¸à¥‡ à¤à¤• à¤µà¤¿à¤¶à¥‡à¤· IRN (à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤°à¥‡à¤«à¤°à¥‡à¤‚à¤¸ à¤¨à¤‚à¤¬à¤°) à¤”à¤° QR à¤•à¥‹à¤¡ à¤¦à¤¿à¤¯à¤¾ à¤œà¤¾à¤¤à¤¾ à¤¹à¥ˆà¥¤' },
        { q: 'à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤•à¥‡ à¤²à¤¿à¤ à¤•à¥Œà¤¨ à¤ªà¤¾à¤¤à¥à¤° à¤¹à¥ˆ?', a: 'à¤œà¤¿à¤¨ à¤µà¥à¤¯à¤µà¤¸à¤¾à¤¯à¥‹à¤‚ à¤•à¤¾ à¤ªà¤¿à¤›à¤²à¥‡ à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤µà¤¿à¤¤à¥à¤¤ à¤µà¤°à¥à¤· à¤®à¥‡à¤‚ à¤•à¥à¤² à¤µà¤¾à¤°à¥à¤·à¤¿à¤• à¤•à¤¾à¤°à¥‹à¤¬à¤¾à¤° â‚¹5 à¤•à¤°à¥‹à¤¡à¤¼ à¤¸à¥‡ à¤…à¤§à¤¿à¤• à¤¹à¥ˆ, à¤‰à¤¨à¥à¤¹à¥‡à¤‚ B2B à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤¬à¤¨à¤¾à¤¨à¤¾ à¤…à¤¨à¤¿à¤µà¤¾à¤°à¥à¤¯ à¤¹à¥ˆà¥¤' },
        { q: 'IRN à¤•à¥€ à¤¸à¤®à¤¯ à¤¸à¥€à¤®à¤¾ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?', a: 'â‚¹100 à¤•à¤°à¥‹à¤¡à¤¼ à¤¸à¥‡ à¤…à¤§à¤¿à¤• à¤Ÿà¤°à¥à¤¨à¤“à¤µà¤° à¤µà¤¾à¤²à¥‡ à¤•à¤°à¤¦à¤¾à¤¤à¤¾à¤“à¤‚ à¤•à¥‹ à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤•à¥€ à¤¤à¤¾à¤°à¥€à¤– à¤¸à¥‡ 7 à¤¦à¤¿à¤¨à¥‹à¤‚ à¤•à¥‡ à¤…à¤‚à¤¦à¤° IRN à¤œà¤¨à¤°à¥‡à¤Ÿ à¤•à¤°à¤¨à¤¾ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤' },
        { q: 'à¤•à¥à¤¯à¤¾ à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤°à¤¦à¥à¤¦ à¤•à¥€ à¤œà¤¾ à¤¸à¤•à¤¤à¥€ à¤¹à¥ˆ?', a: 'à¤¹à¤¾à¤, IRN à¤œà¤¨à¤°à¥‡à¤¶à¤¨ à¤•à¥‡ 24 à¤˜à¤‚à¤Ÿà¥‹à¤‚ à¤•à¥‡ à¤­à¥€à¤¤à¤° IRP à¤ªà¥‹à¤°à¥à¤Ÿà¤² à¤ªà¤° à¤‡à¤¸à¥‡ à¤°à¤¦à¥à¤¦ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆà¥¤ 24 à¤˜à¤‚à¤Ÿà¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ GST à¤ªà¥‹à¤°à¥à¤Ÿà¤² à¤¸à¥‡ à¤°à¤¦à¥à¤¦ à¤•à¤°à¤¨à¤¾ à¤¹à¥‹à¤—à¤¾à¥¤' },
        { q: 'à¤•à¥à¤¯à¤¾ B2C à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤ªà¤° à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤œà¤°à¥‚à¤°à¥€ à¤¹à¥ˆ?', a: 'à¤¨à¤¹à¥€à¤‚, à¤«à¤¿à¤²à¤¹à¤¾à¤² à¤ˆ-à¤‡à¤¨à¤µà¥‰à¤‡à¤¸ à¤•à¥‡à¤µà¤² B2B, B2G à¤”à¤° à¤à¤•à¥à¤¸à¤ªà¥‹à¤°à¥à¤Ÿ à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤¨à¤¿à¤µà¤¾à¤°à¥à¤¯ à¤¹à¥ˆà¥¤' }
      ],
      eway: [
        { q: 'à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤•à¤¬ à¤œà¤°à¥‚à¤°à¥€ à¤¹à¥ˆ?', a: 'à¤œà¤¬ à¤®à¤¾à¤² à¤•à¥€ à¤®à¥‚à¤²à¥à¤¯ â‚¹50,000 à¤¸à¥‡ à¤…à¤§à¤¿à¤• à¤¹à¥‹ à¤”à¤° à¤‰à¤¸à¥‡ à¤¸à¤ªà¥à¤²à¤¾à¤ˆ, à¤µà¤¾à¤ªà¤¸à¥€ à¤¯à¤¾ à¤œà¥‰à¤¬ à¤µà¤°à¥à¤• à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤ªà¥‹à¤°à¥à¤Ÿ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥‹à¥¤' },
        { q: 'à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤•à¥€ à¤µà¥ˆà¤§à¤¤à¤¾ à¤•à¤¿à¤¤à¤¨à¥€ à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆ?', a: '200 km à¤¤à¤• à¤•à¥‡ à¤²à¤¿à¤ 1 à¤¦à¤¿à¤¨, à¤‰à¤¸à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¹à¤° 200 km à¤•à¥‡ à¤²à¤¿à¤ 1 à¤…à¤¤à¤¿à¤°à¤¿à¤•à¥à¤¤ à¤¦à¤¿à¤¨à¥¤ à¤“à¤µà¤°-à¤¡à¤¾à¤¯à¤®à¥‡à¤‚à¤¶à¤¨à¤² à¤•à¤¾à¤°à¥à¤—à¥‹ à¤•à¥‡ à¤²à¤¿à¤ à¤µà¥ˆà¤§à¤¤à¤¾ à¤†à¤§à¥€ à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆà¥¤' },
        { q: 'à¤•à¥à¤¯à¤¾ à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤°à¤¦à¥à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚?', a: 'à¤¹à¤¾à¤, à¤œà¤¨à¤°à¥‡à¤¶à¤¨ à¤•à¥‡ 24 à¤˜à¤‚à¤Ÿà¥‹à¤‚ à¤•à¥‡ à¤­à¥€à¤¤à¤°, à¤¬à¤¶à¤°à¥à¤¤à¥‡ à¤®à¤¾à¤² à¤•à¤¾ à¤Ÿà¥à¤°à¤¾à¤‚à¤œà¤¿à¤Ÿ à¤®à¥‡à¤‚ à¤•à¤° à¤…à¤§à¤¿à¤•à¤¾à¤°à¥€ à¤¨à¥‡ à¤¸à¤¤à¥à¤¯à¤¾à¤ªà¤¨ à¤¨ à¤•à¤¿à¤¯à¤¾ à¤¹à¥‹à¥¤' },
        { q: 'à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤•à¥Œà¤¨ à¤¬à¤¨à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆ?', a: 'à¤ªà¤‚à¤œà¥€à¤•à¥ƒà¤¤ à¤¸à¤ªà¥à¤²à¤¾à¤¯à¤°, à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤à¤•à¤°à¥à¤¤à¤¾ à¤¯à¤¾ à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤ªà¥‹à¤°à¥à¤Ÿà¤° à¤®à¥‡à¤‚ à¤¸à¥‡ à¤•à¥‹à¤ˆ à¤­à¥€ à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤¬à¤¨à¤¾ à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆà¥¤' },
        { q: 'à¤•à¥à¤¯à¤¾ à¤ˆ-à¤µà¥‡ à¤¬à¤¿à¤² à¤•à¥€ à¤µà¥ˆà¤§à¤¤à¤¾ à¤¬à¤¢à¤¼à¤¾à¤ˆ à¤œà¤¾ à¤¸à¤•à¤¤à¥€ à¤¹à¥ˆ?', a: 'à¤¹à¤¾à¤, à¤¸à¤®à¤¾à¤ªà¥à¤¤à¤¿ à¤¸à¥‡ 8 à¤˜à¤‚à¤Ÿà¥‡ à¤ªà¤¹à¤²à¥‡ à¤¯à¤¾ à¤¸à¤®à¤¾à¤ªà¥à¤¤à¤¿ à¤•à¥‡ 8 à¤˜à¤‚à¤Ÿà¥‡ à¤¬à¤¾à¤¦ à¤¤à¤• à¤µà¥ˆà¤§à¤¤à¤¾ à¤¬à¤¢à¤¼à¤¾à¤ˆ à¤œà¤¾ à¤¸à¤•à¤¤à¥€ à¤¹à¥ˆà¥¤' }
      ],
      gstr: [
        { q: 'GSTR-1 à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?', a: 'GSTR-1 à¤à¤• à¤®à¤¾à¤¸à¤¿à¤• à¤¯à¤¾ à¤¤à¤¿à¤®à¤¾à¤¹à¥€ à¤°à¤¿à¤Ÿà¤°à¥à¤¨ à¤¹à¥ˆ à¤œà¤¿à¤¸à¤®à¥‡à¤‚ à¤ªà¤‚à¤œà¥€à¤•à¥ƒà¤¤ à¤•à¤°à¤¦à¤¾à¤¤à¤¾ à¤…à¤ªà¤¨à¥€ à¤†à¤‰à¤Ÿà¤µà¤°à¥à¤¡ à¤¸à¤ªà¥à¤²à¤¾à¤ˆ (à¤¬à¤¿à¤•à¥à¤°à¥€) à¤˜à¥‹à¤·à¤¿à¤¤ à¤•à¤°à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤' },
        { q: 'GSTR-2B à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?', a: 'GSTR-2B à¤à¤• à¤‘à¤Ÿà¥‹-à¤¡à¥à¤°à¤¾à¤«à¥à¤Ÿà¥‡à¤¡, à¤¸à¥à¤¥à¤¿à¤° ITC à¤¸à¥à¤Ÿà¥‡à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¹à¥ˆ à¤œà¥‹ à¤¹à¤° à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¥€ 14 à¤¤à¤¾à¤°à¥€à¤– à¤•à¥‹ à¤œà¤¨à¤°à¥‡à¤Ÿ à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆà¥¤' },
        { q: 'GSTR-1 à¤•à¥€ à¤†à¤–à¤¿à¤°à¥€ à¤¤à¤¾à¤°à¥€à¤– à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?', a: 'à¤®à¤¾à¤¸à¤¿à¤• à¤«à¤¾à¤‡à¤²à¤° à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤—à¤²à¥‡ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¥€ 11 à¤¤à¤¾à¤°à¥€à¤–à¥¤ QRMP à¤¸à¥à¤•à¥€à¤® à¤µà¤¾à¤²à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤¤à¤¿à¤®à¤¾à¤¹à¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¥€ 13 à¤¤à¤¾à¤°à¥€à¤–à¥¤' },
        { q: 'à¤•à¥à¤¯à¤¾ GSTR-1 à¤«à¤¾à¤‡à¤² à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¤‚à¤¶à¥‹à¤§à¤¿à¤¤ à¤•à¥€ à¤œà¤¾ à¤¸à¤•à¤¤à¥€ à¤¹à¥ˆ?', a: 'à¤¨à¤¹à¥€à¤‚, GSTR-1 à¤•à¥‹ à¤«à¤¾à¤‡à¤² à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤°à¤¿à¤µà¤¾à¤‡à¤œà¤¼ à¤¨à¤¹à¥€à¤‚ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤¸à¤•à¤¤à¤¾à¥¤ à¤¸à¤‚à¤¶à¥‹à¤§à¤¨ à¤…à¤—à¤²à¥‡ à¤ªà¥€à¤°à¤¿à¤¯à¤¡ à¤•à¥€ à¤°à¤¿à¤Ÿà¤°à¥à¤¨ à¤®à¥‡à¤‚ Table 9A/9B/9C à¤•à¥‡ à¤®à¤¾à¤§à¥à¤¯à¤® à¤¸à¥‡ à¤•à¤°à¤¨à¤¾ à¤¹à¥‹à¤—à¤¾à¥¤' },
        { q: 'GSTR-2A à¤”à¤° GSTR-2B à¤®à¥‡à¤‚ à¤•à¥à¤¯à¤¾ à¤…à¤‚à¤¤à¤° à¤¹à¥ˆ?', a: 'GSTR-2A à¤à¤• à¤¡à¤¾à¤¯à¤¨à¤¾à¤®à¤¿à¤• à¤¡à¥‰à¤•à¥à¤¯à¥‚à¤®à¥‡à¤‚à¤Ÿ à¤¹à¥ˆ à¤œà¥‹ à¤¸à¤ªà¥à¤²à¤¾à¤¯à¤° à¤•à¥€ à¤«à¤¾à¤‡à¤²à¤¿à¤‚à¤— à¤¸à¥‡ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤¹à¥‹à¤¤à¤¾ à¤°à¤¹à¤¤à¤¾ à¤¹à¥ˆ, à¤œà¤¬à¤•à¤¿ GSTR-2B à¤à¤• à¤¸à¥à¤¥à¤¿à¤° à¤®à¤¾à¤¸à¤¿à¤• à¤¸à¥à¤Ÿà¥‡à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¹à¥ˆà¥¤' }
      ]
    }
  };

  var faqs = data[selectedLang][type] || [];
  faqs.forEach(function(faq, i) {
    var item = document.createElement('div');
    item.style.cssText = 'margin-bottom:14px;background:var(--card-bg);border:1px solid var(--border);border-radius:14px;overflow:hidden;backdrop-filter:blur(16px);';
    item.innerHTML =
      '<div onclick="toggleFAQ(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;transition:background 0.2s;" onmouseover="this.style.background=\'var(--card-hover)\'" onmouseout="this.style.background=\'\'">' +
        '<div style="font-size:13px;font-weight:600;color:var(--text);line-height:1.5;flex:1">' + faq.q + '</div>' +
        '<div class="faq-chevron" style="color:var(--orange);font-size:18px;flex-shrink:0;transition:transform 0.25s;margin-top:1px;">+</div>' +
      '</div>' +
      '<div class="faq-answer" style="max-height:0;overflow:hidden;transition:max-height 0.35s ease;">' +
        '<div style="padding:0 20px 16px;font-size:13px;color:var(--text2);line-height:1.75;border-top:1px solid var(--border);">' + faq.a + '</div>' +
      '</div>';
    container.appendChild(item);
  });
}

function toggleFAQ(header) {
  var answer = header.nextElementSibling;
  var chevron = header.querySelector('.faq-chevron');
  var isOpen = answer.style.maxHeight && answer.style.maxHeight !== '0px';
  if (isOpen) {
    answer.style.maxHeight = '0';
    chevron.style.transform = 'rotate(0deg)';
    chevron.textContent = '+';
  } else {
    answer.style.maxHeight = answer.scrollHeight + 'px';
    chevron.style.transform = 'rotate(45deg)';
    chevron.textContent = '+';
  }
}

['emg','composite'].forEach(function(t){
  var z=document.getElementById('zone-'+t);
  z.addEventListener('dragover',function(e){e.preventDefault();z.classList.add('over');});
  z.addEventListener('dragleave',function(){z.classList.remove('over');});
  z.addEventListener('drop',function(e){e.preventDefault();z.classList.remove('over');var inp=document.getElementById('file-'+t);if(e.dataTransfer.files.length){inp.files=e.dataTransfer.files;loadFile(t,inp);}});
});
</script>
<!-- â•â• USER TOPBAR â•â• -->
<div id="userTopbar" style="
  position:fixed;top:0;left:0;right:0;
  background:rgba(7,9,15,0.96);
  border-bottom:1px solid rgba(255,107,0,0.15);
  padding:8px 20px;
  display:flex;align-items:center;justify-content:space-between;
  z-index:9996;
  font-family:'Inter',sans-serif;
  backdrop-filter:blur(20px);
">
  <div style="display:flex;align-items:center;gap:10px;">
    <div style="
      width:30px;height:30px;
      background:linear-gradient(135deg,#ff6b00,#ff4000);
      border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-size:14px;font-weight:800;color:#fff;
    " id="userInitial">U</div>
    <div>
      <div id="userWelcome" style="font-size:12px;font-weight:700;color:#eef0f6;">Welcome</div>
      <div id="userRole" style="font-size:10px;color:#8892a4;text-transform:uppercase;letter-spacing:0.8px;">User</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <button id="topbar-back-btn" onclick="goBack()" style="
      display:none;
      background:rgba(255,107,0,0.1);border:1px solid rgba(255,107,0,0.3);
      color:var(--orange);border-radius:8px;padding:6px 12px;
      font-size:11px;font-weight:700;cursor:pointer;
      font-family:'Inter',sans-serif;transition:all 0.2s;
      align-items:center;gap:5px;
    " onmouseover="this.style.background='rgba(255,107,0,0.2)'" onmouseout="this.style.background='rgba(255,107,0,0.1)'">
      â† Back
    </button>
    <button onclick="logout()" style="
      background:rgba(255,59,92,0.1);border:1px solid rgba(255,59,92,0.3);
      color:#ff3b5c;border-radius:8px;padding:6px 14px;
      font-size:11px;font-weight:700;cursor:pointer;
      font-family:'Inter',sans-serif;transition:all 0.2s;
    " onmouseover="this.style.background='rgba(255,59,92,0.2)'" onmouseout="this.style.background='rgba(255,59,92,0.1)'">
      Logout â¬¡
    </button>
  </div>
</div>

</div><!-- end #mainApp -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Pre-seed default admin account if not present
(function(){
  if (!localStorage.getItem('user_admin')) {
    localStorage.setItem('user_admin', JSON.stringify({
      first:'Admin', last:'User', gmail:'admin@easemygst.com',
      user:'admin', pass:'admin123', role:'admin'
    }));
  }
})();

function showSignup() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('signupScreen').style.display = 'flex';
}
function backToLogin() {
  document.getElementById('signupScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('signupMsg').textContent = '';
}
function signup() {
  var fn = document.getElementById('firstName').value.trim();
  var ln = document.getElementById('lastName').value.trim();
  var gm = document.getElementById('gmail').value.trim();
  var nu = document.getElementById('newUser').value.trim();
  var np = document.getElementById('newPass').value;
  var msg = document.getElementById('signupMsg');
  if (!fn||!ln||!gm||!nu||!np) { msg.style.color='#ff3b5c'; msg.textContent='Please fill all fields.'; return; }
  if (localStorage.getItem('user_'+nu)) { msg.style.color='#ff3b5c'; msg.textContent='User ID already taken.'; return; }
  var userData = { first:fn, last:ln, gmail:gm, user:nu, pass:np, role: nu==='admin' ? 'admin' : 'user' };
  localStorage.setItem('user_'+nu, JSON.stringify(userData));
  msg.style.color='#00dba0';
  msg.textContent='Account Created Successfully âœ… Please login.';
  setTimeout(backToLogin, 1800);
}
function login() {
  var uid = document.getElementById('loginUser').value.trim();
  var pwd = document.getElementById('loginPass').value;
  var err = document.getElementById('loginError');
  var stored = localStorage.getItem('user_'+uid);
  if (!stored) { err.textContent='âŒ User ID not found. Please sign up first.'; return; }
  var data = JSON.parse(stored);
  if (data.pass !== pwd) { err.textContent='âŒ Wrong password. Try again.'; return; }
  localStorage.setItem('currentUser', JSON.stringify(data));
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  // Update topbar
  document.getElementById('userWelcome').textContent = 'Welcome, ' + data.first + ' ' + data.last;
  document.getElementById('userRole').textContent = data.role === 'admin' ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ User';
  document.getElementById('userInitial').textContent = (data.first[0]||'U').toUpperCase();
  updateTopbarBack();
  err.textContent = '';
}
function logout() {
  localStorage.removeItem('currentUser');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}
function getCurrentUser() {
  var u = localStorage.getItem('currentUser');
  return u ? JSON.parse(u) : null;
}
function isAdmin() {
  var u = getCurrentUser();
  return u && u.role === 'admin';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SATURDAY TRACKER (with log)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSaturday(team) {
  var today = new Date();
  var year = 2026;
  var d = new Date(year, 0, 1);
  var saturdays = [];
  while (d.getFullYear() === year) {
    if (d.getDay() === 6) saturdays.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }
  var upcoming = saturdays.find(function(date){ return date > today; });
  if (!upcoming) {
    upcoming = new Date(year + 1, 0, 1);
    while (upcoming.getDay() !== 6) upcoming.setDate(upcoming.getDate() + 1);
  }

  // Log the access
  var cu = getCurrentUser();
  var logEntry = {
    user: cu ? cu.user : 'guest',
    fullName: cu ? cu.first + ' ' + cu.last : 'Guest',
    team: team,
    date: new Date().toLocaleString('en-IN'),
    viewedSaturday: upcoming.toDateString()
  };
  var logs = [];
  try { logs = JSON.parse(localStorage.getItem('trackerLogs')) || []; } catch(e){}
  logs.push(logEntry);
  try { localStorage.setItem('trackerLogs', JSON.stringify(logs)); } catch(e){}

  var options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
  document.getElementById('trackerResult').innerHTML =
    'ğŸ“… Next Saturday for <strong>' + team + ' Team</strong>: ' +
    upcoming.toLocaleDateString('en-IN', options);
}

function viewTrackerLogs() {
  if (!isAdmin()) { alert('âŒ Only Admin can view logs.'); return; }
  var logs = [];
  try { logs = JSON.parse(localStorage.getItem('trackerLogs')) || []; } catch(e){}
  if (!logs.length) { alert('No tracker logs yet.'); return; }
  var display = 'ğŸ“‹ TRACKER ACCESS LOGS\n' + 'â”€'.repeat(40) + '\n';
  logs.slice().reverse().forEach(function(l, i){
    display += (i+1) + '. User: ' + l.user + ' (' + (l.fullName||'') + ')' +
      '\n   Team: ' + l.team + ' | Saturday: ' + l.viewedSaturday +
      '\n   Accessed: ' + l.date + '\n\n';
  });
  alert(display);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN TRAINING FOLDER SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTrainingDeck(section) {
  if (!isAdmin()) {
    alert('âŒ Only Admin can access Training Decks.\nPlease contact your administrator.');
    return;
  }
  var titles = { training_edoc:'E-Doc Training', training_gst:'GST Training' };
  var content = '';
  try { content = localStorage.getItem(section) || ''; } catch(e){}

  var folders = [];
  try { folders = JSON.parse(localStorage.getItem(section+'_folders')) || []; } catch(e){}

  var folderHtml = folders.length
    ? '<br><strong>Folders:</strong><br>' + folders.map(function(f){ return 'ğŸ“ ' + f; }).join('<br>')
    : '<br><em style="color:#aaa;">No folders yet.</em>';

  var panel = document.getElementById('trainingPanel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'trainingPanel';
    panel.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9990;display:flex;align-items:center;justify-content:center;font-family:Inter,sans-serif;';
    document.body.appendChild(panel);
  }
  panel.innerHTML = '<div style="background:#fff;border-radius:16px;padding:32px;width:500px;max-width:94vw;max-height:80vh;overflow-y:auto;box-shadow:0 32px 80px rgba(0,0,0,0.4);">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">' +
      '<h3 style="font-family:Syne,sans-serif;font-size:18px;font-weight:800;color:#111;">ğŸ“˜ ' + (titles[section]||section) + '</h3>' +
      '<button onclick="document.getElementById(\'trainingPanel\').remove()" style="background:#f5f5f5;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:16px;">Ã—</button>' +
    '</div>' +
    '<label style="font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:0.8px;">Notes &amp; Content</label>' +
    '<textarea id="training-content-'+section+'" rows="6" style="width:100%;border:1.5px solid #e5e5e5;border-radius:10px;padding:10px;font-family:Inter,sans-serif;font-size:13px;margin:8px 0;box-sizing:border-box;resize:vertical;">' + content + '</textarea>' +
    '<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">' +
      '<button onclick="saveTraining(\''+section+'\')" style="background:#ff6b00;color:#fff;border:none;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-family:Inter,sans-serif;font-size:13px;">ğŸ’¾ Save</button>' +
      '<button onclick="createTrainingFolder(\''+section+'\')" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-family:Inter,sans-serif;font-size:13px;">ğŸ“ New Folder</button>' +
      '<button onclick="viewFolders(\''+section+'\')" style="background:#f5f5f5;border:1.5px solid #e5e5e5;color:#555;border-radius:8px;padding:9px 18px;font-weight:700;cursor:pointer;font-family:Inter,sans-serif;font-size:13px;">ğŸ‘ View Folders</button>' +
    '</div>' +
    '<div id="trainingFolderList-'+section+'" style="font-size:13px;color:#555;">' + folderHtml + '</div>' +
  '</div>';
  panel.style.display = 'flex';
}

function saveTraining(section) {
  var ta = document.getElementById('training-content-'+section);
  if (!ta) return;
  try {
    localStorage.setItem(section, ta.value);
    ta.style.borderColor = '#00dba0';
    setTimeout(function(){ ta.style.borderColor = '#e5e5e5'; }, 1500);
  } catch(e){ alert('Save failed.'); }
}

function createTrainingFolder(section) {
  var name = prompt('Enter folder name:');
  if (!name || !name.trim()) return;
  var folders = [];
  try { folders = JSON.parse(localStorage.getItem(section+'_folders')) || []; } catch(e){}
  folders.push(name.trim());
  try {
    localStorage.setItem(section+'_folders', JSON.stringify(folders));
    viewFolders(section);
  } catch(e){}
}

function viewFolders(section) {
  var folders = [];
  try { folders = JSON.parse(localStorage.getItem(section+'_folders')) || []; } catch(e){}
  var el = document.getElementById('trainingFolderList-'+section);
  if (el) {
    el.innerHTML = folders.length
      ? '<strong>Folders:</strong><br>' + folders.map(function(f,i){
          return '<span style="display:inline-block;background:#fff3eb;border:1px solid #ffcca0;border-radius:6px;padding:3px 10px;margin:3px;font-size:12px;cursor:pointer;" onclick="deleteFolder(\''+section+'\','+i+')">ğŸ“ ' + f + ' âœ•</span>';
        }).join('')
      : '<em style="color:#aaa;">No folders yet.</em>';
  }
}

function deleteFolder(section, idx) {
  var folders = [];
  try { folders = JSON.parse(localStorage.getItem(section+'_folders')) || []; } catch(e){}
  if (confirm('Delete folder "' + folders[idx] + '"?')) {
    folders.splice(idx, 1);
    localStorage.setItem(section+'_folders', JSON.stringify(folders));
    viewFolders(section);
  }
}

</script>

<!-- â•â• MINI-BOT CURSOR â•â• -->
<div id="mini-bot">ğŸ¤–</div>
<style>
#mini-bot {
  position: fixed;
  top: 0; left: 0;
  font-size: 22px;
  pointer-events: none;
  z-index: 99999;
  transition: transform 0.12s linear;
  filter: drop-shadow(0 2px 6px rgba(255,107,0,0.4));
}
</style>
<script>
(function() {
  var bot = document.getElementById('mini-bot');
  document.addEventListener('mousemove', function(e) {
    bot.style.transform = 'translate(' + (e.clientX + 14) + 'px, ' + (e.clientY + 10) + 'px)';
  });
})();
</script>

<!-- â•â• FLOATING SUPPORT CHATBOT â•â• -->
<style>
/* â”€â”€ CHATBOT STYLES (EaseMyGST Support Bot) â”€â”€ */
#emg-launcher {
  position:fixed; bottom:22px; right:22px;
  width:62px; height:62px;
  background:linear-gradient(135deg,#ff6b00,#ff8c42);
  border-radius:50%; cursor:pointer;
  box-shadow:0 4px 22px rgba(255,107,0,.55);
  display:flex; align-items:center; justify-content:center;
  font-size:28px; z-index:9998;
  animation:emgPopIn .4s cubic-bezier(.175,.885,.32,1.275);
  transition:transform .2s, box-shadow .2s;
}
#emg-launcher:hover { transform:scale(1.1); box-shadow:0 10px 32px rgba(255,107,0,.7); }
@keyframes emgPopIn { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }

#emg-win {
  position:fixed; bottom:100px; right:22px;
  width:420px; max-width:calc(100vw - 32px);
  height:680px; max-height:calc(100vh - 120px);
  background:#fff;
  border-radius:22px;
  box-shadow:0 8px 44px rgba(0,0,0,.22), 0 0 0 1px rgba(0,0,0,.06);
  display:flex; flex-direction:column;
  overflow:hidden; z-index:9999;
  transform:scale(0.9) translateY(20px);
  opacity:0; pointer-events:none;
  transform-origin:bottom right;
  transition:all .25s cubic-bezier(.175,.885,.32,1.275);
  font-family:'Inter','Plus Jakarta Sans',sans-serif;
}
#emg-win.open {
  transform:scale(1) translateY(0);
  opacity:1; pointer-events:all;
}

/* Header */
.emg-hdr {
  background:linear-gradient(135deg,#ff6b00,#ff8c42);
  padding:14px 16px;
  display:flex; align-items:center; gap:11px;
  flex-shrink:0; position:relative; overflow:hidden;
}
.emg-hdr::after { content:''; position:absolute; right:-30px; top:-30px; width:110px; height:110px; border-radius:50%; background:rgba(255,255,255,0.08); }
.emg-hdr-ico { width:42px; height:42px; background:rgba(255,255,255,.2); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0; }
.emg-hdr h2  { color:#fff; font-size:14px; font-weight:700; }
.emg-hdr p   { color:rgba(255,255,255,0.85); font-size:11px; display:flex; align-items:center; gap:4px; margin-top:2px; }
.emg-dot { width:6px; height:6px; background:#4ade80; border-radius:50%; animation:emgBlink 2s infinite; }
@keyframes emgBlink{0%,100%{opacity:1}50%{opacity:.3}}
.emg-close { margin-left:auto; background:rgba(255,255,255,.2); border:none; color:#fff; width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center; z-index:1; flex-shrink:0; transition:background .2s; }
.emg-close:hover { background:rgba(255,255,255,.35); }

/* Messages */
#emg-msgs {
  flex:1; overflow-y:auto; padding:14px 13px 8px;
  display:flex; flex-direction:column; gap:10px;
  min-height:0;
}
#emg-msgs::-webkit-scrollbar { width:4px; }
#emg-msgs::-webkit-scrollbar-thumb { background:#e2e8f0; border-radius:4px; }

.emg-msg { display:flex; gap:8px; animation:emgUp .25s ease; }
@keyframes emgUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.emg-msg.u { flex-direction:row-reverse; }
.emg-av { width:28px; height:28px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:13px; flex-shrink:0; }
.emg-msg.b .emg-av { background:#ff6b00; color:#fff; }
.emg-msg.u .emg-av { background:#374151; color:#fff; }
.emg-bub { max-width:83%; padding:9px 13px; border-radius:15px; font-size:13.5px; line-height:1.55; }
.emg-msg.b .emg-bub { background:#fff3eb; color:#111; border-bottom-left-radius:3px; border:1px solid rgba(255,107,0,.15); }
.emg-msg.u .emg-bub { background:#ff6b00; color:#fff; border-bottom-right-radius:3px; }
.emg-bub b { font-weight:700; }
.emg-bub a { color:#c2410c; font-weight:600; text-decoration:underline; }

/* Dynamic area */
#emg-dyn { flex-shrink:0; }

/* Option buttons */
.emg-opt-row { display:flex; flex-wrap:wrap; gap:7px; padding:4px 13px 12px; }
.emg-obtn { background:#fff; border:1.5px solid #ff6b00; color:#ff6b00; border-radius:20px; padding:7px 14px; font-size:13px; font-family:inherit; font-weight:600; cursor:pointer; transition:all .18s; white-space:nowrap; }
.emg-obtn:hover { background:#ff6b00; color:#fff; transform:translateY(-1px); }
.emg-obtn.green { border-color:#10b981; color:#10b981; }
.emg-obtn.green:hover { background:#10b981; color:#fff; }
.emg-obtn.amber { border-color:#f59e0b; color:#f59e0b; }
.emg-obtn.amber:hover { background:#f59e0b; color:#fff; }
.emg-obtn.red   { border-color:#ef4444; color:#ef4444; }
.emg-obtn.red:hover { background:#ef4444; color:#fff; }

/* Multi-select */
.emg-ms-wrap { padding:4px 13px 10px; }
.emg-ms-hint { font-size:12px; color:#64748b; font-style:italic; background:#f8fafc; border-left:3px solid #06b6d4; border-radius:7px; padding:6px 10px; margin-bottom:8px; }
.emg-ms-grid { display:flex; flex-direction:column; gap:5px; max-height:200px; overflow-y:auto; margin-bottom:10px; padding-right:2px; }
.emg-ms-grid::-webkit-scrollbar { width:3px; }
.emg-ms-grid::-webkit-scrollbar-thumb { background:#e2e8f0; border-radius:3px; }
.emg-ms-btn { background:#f8fafc; border:1.5px solid #cbd5e1; color:#1e293b; border-radius:10px; padding:8px 12px; font-size:13px; font-family:inherit; font-weight:500; cursor:pointer; transition:all .16s; display:flex; align-items:center; gap:8px; text-align:left; width:100%; }
.emg-ms-btn:hover { border-color:#ff6b00; background:#fff3eb; }
.emg-ms-btn.sel   { background:#ff6b00; border-color:#ff6b00; color:#fff; }
.emg-ms-actions { display:flex; gap:8px; }
.emg-ms-back { flex:1; background:#fff; border:1.5px solid #94a3b8; color:#64748b; border-radius:11px; padding:9px; font-size:13px; font-family:inherit; font-weight:600; cursor:pointer; transition:all .18s; }
.emg-ms-back:hover { border-color:#ff6b00; color:#ff6b00; }
.emg-ms-confirm { flex:2; background:#cbd5e1; color:#fff; border:none; border-radius:11px; padding:9px; font-size:14px; font-weight:700; font-family:inherit; cursor:not-allowed; transition:all .2s; }
.emg-ms-confirm.on { background:linear-gradient(135deg,#ff6b00,#ff4000); cursor:pointer; box-shadow:0 4px 14px rgba(255,107,0,.3); }
.emg-ms-confirm.on:hover { transform:translateY(-1px); }

/* Solution box */
.emg-sol-scroller { padding:2px 13px 8px; max-height:240px; overflow-y:auto; }
.emg-sol-scroller::-webkit-scrollbar { width:3px; }
.emg-sol-scroller::-webkit-scrollbar-thumb { background:#e2e8f0; border-radius:3px; }
.emg-sol-box { background:#fff3eb; border-left:3px solid #ff6b00; border-radius:10px; padding:10px 12px; margin-bottom:8px; }
.emg-sol-box .emg-stitle { font-weight:700; color:#c2410c; font-size:11.5px; text-transform:uppercase; letter-spacing:.4px; margin-bottom:6px; }
.emg-sol-box ul { padding-left:16px; }
.emg-sol-box ul li { margin-bottom:5px; font-size:13px; line-height:1.55; color:#111; }
.emg-sol-box ul li a { color:#c2410c; font-weight:700; }

/* Escalation banner */
.emg-esc { background:linear-gradient(135deg,#fef3c7,#fde68a); border:1.5px solid #f59e0b; border-radius:12px; padding:12px 14px; margin:4px 13px 10px; }
.emg-esc .emg-etitle { font-weight:700; color:#92400e; margin-bottom:6px; font-size:14px; }
.emg-esc p { color:#78350f; line-height:1.65; font-size:13px; }

/* Typing */
.emg-typing { display:flex; gap:4px; align-items:center; padding:10px 13px; background:#fff3eb; border-radius:15px; border-bottom-left-radius:3px; width:fit-content; border:1px solid rgba(255,107,0,.15); }
.emg-typing span { width:7px; height:7px; border-radius:50%; background:#ff6b00; animation:emgBounce 1.2s infinite; }
.emg-typing span:nth-child(2){animation-delay:.2s}
.emg-typing span:nth-child(3){animation-delay:.4s}
@keyframes emgBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

/* Input bar */
.emg-input-bar { padding:10px 13px; border-top:1px solid #f1f5f9; display:flex; gap:8px; align-items:center; background:#fafbff; flex-shrink:0; }
#emg-txt { flex:1; border:1.5px solid #e2e8f0; border-radius:20px; padding:9px 15px; font-size:13.5px; font-family:inherit; outline:none; background:#fff; color:#111; transition:border .2s; }
#emg-txt:focus { border-color:#ff6b00; }
#emg-txt:disabled { background:#f1f5f9; color:#94a3b8; cursor:not-allowed; }
#emg-snd { width:37px; height:37px; background:#ff6b00; border:none; border-radius:50%; color:#fff; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:15px; transition:all .2s; }
#emg-snd:hover:not(:disabled) { background:#e05a00; transform:scale(1.08); }
#emg-snd:disabled { background:#cbd5e1; cursor:not-allowed; }
</style>

<!-- Launcher Button -->
<div id="emg-launcher" onclick="emgToggle()" title="Support Chat">&#129302;</div>

<!-- Chat Window -->
<div id="emg-win">
  <div class="emg-hdr">
    <div class="emg-hdr-ico">&#129302;</div>
    <div>
      <h2>EaseMyGST Support</h2>
      <p><span class="emg-dot"></span> Online &bull; Instant assistance</p>
    </div>
    <button class="emg-close" onclick="emgToggle()">&#10005;</button>
  </div>
  <div id="emg-msgs"></div>
  <div id="emg-dyn"></div>
  <div class="emg-input-bar">
    <input type="text" id="emg-txt" placeholder='Type "agent" to connect...' disabled />
    <button id="emg-snd" disabled>&#10148;</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EASEMYGST SUPPORT CHATBOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){

var msgsEl = document.getElementById('emg-msgs');
var dynEl  = document.getElementById('emg-dyn');
var txtIn  = document.getElementById('emg-txt');
var sndBtn = document.getElementById('emg-snd');
var chatWin= document.getElementById('emg-win');

var S = { category:'', selectedIssues:[], awaitingKW:false };
var KW = ['agent','support','executive','human','connect','talk','speak','person','staff','operator','call','escalate','urgent'];

// â”€â”€ SOLUTIONS DATA â”€â”€
var SOL = {
  einvoice: {
    'HSN Code Invalid': { ico:'&#128258;', steps:[
      'HSN code entered is invalid or not recognized by the IRP portal.',
      '&#9989; Verify your HSN code here: <a href="https://einvoice1.gst.gov.in/Others/MasterCodes" target="_blank">HSN Master Codes &rarr;</a>',
      'HSN must be 4, 6, or 8 digits based on your annual turnover.',
      'Update the correct HSN in all invoice line items and retry on EaseMyGST: <a href="https://easemygst.taxilla.com/" target="_blank">easemygst.taxilla.com &rarr;</a>'
    ]},
    'Supplier / Buyer GSTIN Invalid': { ico:'&#127970;', steps:[
      'Verify GSTIN is active at <a href="https://www.gst.gov.in" target="_blank">gst.gov.in &rarr;</a>.',
      'If GSTIN appears valid on GST Portal, additionally verify Buyer GSTIN here: <a href="https://einvoice1.gst.gov.in/Others/TaxpayerSearch" target="_blank">Taxpayer Search &rarr;</a>',
      'GSTIN must be exactly 15 characters (e.g. 27AABCU9603R1ZX).',
      'Newly registered GSTINs may take 24&ndash;48 hours to sync. Retry after that on <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'Duplicate E-Invoice Error': { ico:'&#128257;', steps:[
      'E-Invoice is already generated for this invoice number.',
      'This is a <b>warning message only</b> &mdash; please ignore it.',
      'Check if your E-Invoice PDF is already generated: go to <b>Reports</b> option in EaseMyGST.',
      'If PDF is available in Reports, your E-Invoice is successfully generated. No action needed.'
    ]},
    'Incorrect Password': { ico:'&#128274;', steps:[
      'Your GSP password has been <b>changed or expired</b>.',
      'Step 1: Update your password on the GSP portal: <a href="https://ewaybillgst.gov.in/Login.aspx" target="_blank">ewaybillgst.gov.in &rarr;</a>',
      'Step 2: After updating, also update the new password in <b>EaseMyGST Org Master</b>.',
      'Login to EaseMyGST: <a href="https://easemygst.taxilla.com/" target="_blank">easemygst.taxilla.com &rarr;</a> and update credentials under Org Master.'
    ]},
    'Unable to Login to EaseMyGST': { ico:'&#128513;', steps:[
      'Verify your login credentials (username and password) are correct.',
      'If you forgot your password, click the <b>"Forgot Password"</b> button on the login page.',
      'Login here: <a href="https://easemygst.taxilla.com/" target="_blank">easemygst.taxilla.com &rarr;</a>',
      'If issue persists after password reset, contact your account admin or support.'
    ]},
    'Invoice No More Than 16 Digits': { ico:'&#128290;', steps:[
      'Your invoice number length exceeds the <b>16-character limit</b> allowed by IRP.',
      'Please check your invoice number in your ERP system.',
      'Shorten the invoice number to <b>16 digits or less</b> in your ERP.',
      'Re-generate the E-Invoice from <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> after updating.'
    ]},
    'Pincode Does Not Match State Code': { ico:'&#128205;', steps:[
      'Supplier or Buyer pincode and state code are mismatched.',
      'Click <b>Edit Button &rarr; Invoice Details &rarr; Bill From Details</b> and verify your pincode matches your state.',
      'Also check <b>Bill To Details</b> &mdash; ensure buyer pincode matches buyer state.',
      'Update and re-generate on <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'Ship To Pincode / Address Missing': { ico:'&#128230;', steps:[
      'The <b>Dispatch to Details</b> section has incomplete information.',
      'Verify all fields in the "Dispatch to Details" section are filled:',
      '<b>Name, Address, City, Pincode, State</b> &mdash; all are mandatory.',
      'Edit the invoice on <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> and fill all Dispatch to Details before retrying.'
    ]},
    'Address More Than 100 Characters': { ico:'&#128196;', steps:[
      'Address field exceeds the <b>100 character limit</b> allowed by IRP.',
      'Click <b>Edit Button &rarr; Invoice Details &rarr; Bill From Details</b> and check Address 1 length.',
      'Also check <b>Bill To Details</b> for Buyer address length.',
      'If address is more than 100 characters, <b>split it</b>: put first half in Address 1 and remaining in Address 2.'
    ]},
    'API End Point Error': { ico:'&#9881;', steps:[
      'The GSTIN you are using is <b>not registered</b> on EaseMyGST.',
      'Verify that the GSTIN used for E-Invoice generation is registered and active in your EaseMyGST account.',
      'Login and check your GSTIN configuration at <a href="https://easemygst.taxilla.com/" target="_blank">easemygst.taxilla.com &rarr;</a>',
      'Contact support if GSTIN registration needs to be added to your account.'
    ]},
    'Supplier PIN Code Cannot Be 999999': { ico:'&#128203;', steps:[
      'An incorrect PIN code (999999) has been passed under Supplier Details.',
      'Correct the PIN code with the actual valid PIN code of the supplier.',
      'For valid PIN codes, visit the portal: <b>Search &rarr; PIN Code Search</b> on EaseMyGST.',
      'Update Supplier details on <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> and retry.'
    ]},
    'Invoice Not Visible in E-Invoice Generator': { ico:'&#128269;', steps:[
      'The invoice is not showing in the E-Invoice Generator on EaseMyGST.',
      'This is usually caused by a <b>missing or incorrect Customer GSTIN</b> on the invoice.',
      'In <b>Ginesys ERP</b>, open the invoice and check the Customer GSTIN using the <b>"Side Panel"</b> option.',
      'Verify and update the correct Customer GSTIN, save the invoice, and retry generating from <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'Cancel IRN': { ico:'&#10060;', steps:[
      'IRN can <b>only be cancelled within 24 hours</b> of generation.',
      'Go to <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> &rarr; E-Invoice &rarr; Cancel IRN &rarr; Enter IRN and select reason.',
      'After cancellation, a new E-Invoice must be generated with a new invoice number.',
      'If 24 hours have passed, cancellation is not possible &mdash; contact your CA or GST consultant.'
    ]},
    'Invoice Date More Than 30 Days': { ico:'&#128197;', steps:[
      'E-Invoice cannot be generated for invoices older than <b>30 days</b> from the invoice date.',
      'Check the invoice date on EaseMyGST &mdash; ensure it is within the last 30 days.',
      'If the invoice date needs correction, amend it in your ERP and re-sync to EaseMyGST.',
      'For very old invoices, consult your GST consultant on how to handle this legally.'
    ]}
  },
  ewaybill: {
    'Invalid JSON / HSN Non-GST': { ico:'&#128203;', steps:[
      'The JSON data contains an HSN code that is not applicable under GST.',
      'Identify the product with the invalid HSN and verify its GST applicability.',
      'Check HSN validity at <a href="https://einvoice1.gst.gov.in/Others/MasterCodes" target="_blank">HSN Master Codes &rarr;</a>',
      'Update the correct HSN in your ERP and re-generate the E-Way Bill from <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'Transporter ID Invalid': { ico:'&#128667;', steps:[
      'The Transporter ID (GSTIN) entered is not valid or not registered.',
      'Verify the transporter GSTIN at <a href="https://www.gst.gov.in" target="_blank">gst.gov.in &rarr;</a>.',
      'Ensure the transporter is registered on the E-Way Bill portal.',
      'Update the correct Transporter ID in <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> and retry.'
    ]},
    'Cancel E-Way Bill': { ico:'&#128465;', steps:[
      'E-Way Bill can be cancelled within <b>24 hours</b> of generation only.',
      'Go to <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> &rarr; E-Way Bill &rarr; Cancel EWB &rarr; Enter EWB number.',
      'Select cancellation reason and confirm.',
      'If goods are already in transit, cancellation may not be permitted &mdash; consult your transporter.'
    ]},
    'Distance Between Pincodes Too High': { ico:'&#128739;', steps:[
      'The system-calculated distance between Supplier and Buyer pincodes exceeds the allowed limit.',
      'Verify the pincodes entered for both supplier and buyer are correct.',
      'If pincodes are correct, you can manually override the distance in EaseMyGST.',
      'Login at <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> and update the distance manually in the E-Way Bill form.'
    ]},
    'Transport Document Number Missing (Air/Rail)': { ico:'&#9992;', steps:[
      'For Air or Rail transport mode, the Transport Document Number is mandatory.',
      'Enter the Airway Bill number (for Air) or Railway Receipt number (for Rail).',
      'This field is under <b>Part-B of E-Way Bill</b> &mdash; update it in EaseMyGST.',
      'Login at <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> and update Part-B with the correct document number.'
    ]},
    'Vehicle Mode Must Be Road': { ico:'&#128739;', steps:[
      'The vehicle mode selected is not valid for this type of transport.',
      'For road transport, ensure the <b>Vehicle Number</b> is also entered.',
      'Change the transport mode to <b>Road</b> in the E-Way Bill form.',
      'Update and regenerate the E-Way Bill at <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'E-Way Bill Not Generated': { ico:'&#128230;', steps:[
      'Check if there is an error message displayed in EaseMyGST after attempting to generate.',
      'Verify all mandatory fields are filled: GSTIN, HSN, value, vehicle number, transporter details.',
      'Ensure the consignment value is above &#8377;50,000 for mandatory E-Way Bill requirement.',
      'Retry generation at <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> or contact support.'
    ]},
    'Invoice Not Visible in E-Way Bill Generator': { ico:'&#128269;', steps:[
      'The invoice is not appearing in the E-Way Bill Generator module.',
      'This is usually caused by a <b>missing Customer GSTIN</b> on the invoice.',
      'In <b>Ginesys ERP</b>, open the invoice and verify the Customer GSTIN via the <b>Side Panel</b>.',
      'Update the correct GSTIN, save, and then retry in the E-Way Bill Generator at <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a>'
    ]},
    'E-Way Bill Already Generated for this IRN': { ico:'&#128257;', steps:[
      'An E-Way Bill has already been generated for this IRN (Invoice Reference Number).',
      'Go to <b>Reports</b> in EaseMyGST and check the existing E-Way Bill for this invoice.',
      'If an update is needed (e.g. vehicle number change), use the <b>Update Part-B</b> option.',
      'Visit <a href="https://easemygst.taxilla.com/" target="_blank">EaseMyGST &rarr;</a> to view or update.'
    ]}
  },
  gstreturns: {
    'OTP Not Receiving': { ico:'&#128241;', steps:[
      'Ensure your registered mobile number and email on the GST portal are correct and active.',
      'Check if your mobile network has good signal. Try requesting OTP again after 2 minutes.',
      'If OTP is still not received, login to <a href="https://www.gst.gov.in" target="_blank">gst.gov.in &rarr;</a> and update your mobile number.',
      'Alternatively, use DSC (Digital Signature Certificate) as an alternative authentication method.'
    ]},
    'Structural Error Duplicate Invoice': { ico:'&#128202;', steps:[
      'One or more invoice numbers in your upload file are duplicated.',
      'Download the error report from EaseMyGST and identify duplicate invoice numbers.',
      'In your ERP, check and correct the duplicate invoice numbers.',
      'Re-upload the corrected file at <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a>'
    ]},
    'Invalid HSN': { ico:'&#128258;', steps:[
      'One or more HSN codes in your return data are invalid.',
      'Download the HSN Summary from your return data.',
      '&#9989; Verify HSN codes using the bulk search tool: <a href="https://ginesys.sapphire-portal.easemygst.com/#/bulksearch" target="_blank">Bulk HSN Search &rarr;</a>',
      'Correct all invalid HSN codes and re-upload on <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a>'
    ]},
    'Invalid POS (Place of Supply)': { ico:'&#128205;', steps:[
      'Place of Supply (POS) code in one or more invoices is not valid.',
      'Add the correct Place of Supply code for each invoice.',
      'POS codes are 2-digit state codes (e.g. 27 for Maharashtra, 07 for Delhi).',
      'Update and re-file on <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a>'
    ]},
    'Tax Invalid / Tax Mismatch': { ico:'&#128176;', steps:[
      'Tax amount is invalid &mdash; this usually happens when <b>POS and Tax Type do not match</b>.',
      'Check: if POS is <b>same state as supplier</b> &rarr; use CGST + SGST.',
      'If POS is <b>different state from supplier</b> &rarr; use IGST.',
      'Correct the tax type and amount, then re-upload on <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a>'
    ]},
    'GSTR-1 Filing Error': { ico:'&#128209;', steps:[
      'Ensure all B2B and B2C invoices are uploaded correctly before filing.',
      'Check for duplicate invoice numbers &mdash; each must be unique.',
      'Verify DSC is valid or EVC OTP is received for authentication.',
      'File from <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a> using Chrome or Edge browser.'
    ]},
    'GSTR-3B Mismatch': { ico:'&#9878;', steps:[
      'Reconcile GSTR-3B values with GSTR-1 and GSTR-2B before filing.',
      'ITC in GSTR-3B must not exceed auto-populated GSTR-2B figures.',
      'Outward supply values must match GSTR-1 data exactly.',
      'File from <a href="https://portal.easemygst.com/" target="_blank">EaseMyGST Returns Portal &rarr;</a> after reconciliation.'
    ]}
  }
};

var MENUS = {
  einvoice: [
    { label:'HSN Code Invalid',                          value:'HSN Code Invalid',                          ico:'&#128258;' },
    { label:'Supplier / Buyer GSTIN Invalid',            value:'Supplier / Buyer GSTIN Invalid',            ico:'&#127970;' },
    { label:'Duplicate E-Invoice Error',                 value:'Duplicate E-Invoice Error',                 ico:'&#128257;' },
    { label:'Incorrect Password',                        value:'Incorrect Password',                        ico:'&#128274;' },
    { label:'Unable to Login to EaseMyGST',              value:'Unable to Login to EaseMyGST',              ico:'&#128513;' },
    { label:'Invoice No More Than 16 Digits',            value:'Invoice No More Than 16 Digits',            ico:'&#128290;' },
    { label:'Pincode Does Not Match State Code',         value:'Pincode Does Not Match State Code',         ico:'&#128205;' },
    { label:'Ship To Pincode / Address Missing',         value:'Ship To Pincode / Address Missing',         ico:'&#128230;' },
    { label:'Address More Than 100 Characters',          value:'Address More Than 100 Characters',          ico:'&#128196;' },
    { label:'API End Point Error',                       value:'API End Point Error',                       ico:'&#9881;'   },
    { label:'Supplier PIN Code Cannot Be 999999',        value:'Supplier PIN Code Cannot Be 999999',        ico:'&#128203;' },
    { label:'Invoice Not Visible in E-Invoice Generator',value:'Invoice Not Visible in E-Invoice Generator',ico:'&#128269;' },
    { label:'Cancel IRN',                                value:'Cancel IRN',                                ico:'&#10060;'  },
    { label:'Invoice Date More Than 30 Days',            value:'Invoice Date More Than 30 Days',            ico:'&#128197;' }
  ],
  ewaybill: [
    { label:'Invalid JSON / HSN Non-GST',                value:'Invalid JSON / HSN Non-GST',                ico:'&#128203;' },
    { label:'Transporter ID Invalid',                    value:'Transporter ID Invalid',                    ico:'&#128667;' },
    { label:'Cancel E-Way Bill',                         value:'Cancel E-Way Bill',                         ico:'&#128465;' },
    { label:'Distance Between Pincodes Too High',        value:'Distance Between Pincodes Too High',        ico:'&#128739;' },
    { label:'Transport Document Number Missing (Air/Rail)',value:'Transport Document Number Missing (Air/Rail)',ico:'&#9992;'},
    { label:'Vehicle Mode Must Be Road',                 value:'Vehicle Mode Must Be Road',                 ico:'&#128739;' },
    { label:'E-Way Bill Not Generated',                  value:'E-Way Bill Not Generated',                  ico:'&#128230;' },
    { label:'Invoice Not Visible in E-Way Bill Generator',value:'Invoice Not Visible in E-Way Bill Generator',ico:'&#128269;'},
    { label:'E-Way Bill Already Generated for this IRN', value:'E-Way Bill Already Generated for this IRN', ico:'&#128257;' }
  ],
  gstreturns: [
    { label:'OTP Not Receiving',                         value:'OTP Not Receiving',                         ico:'&#128241;' },
    { label:'Structural Error Duplicate Invoice',        value:'Structural Error Duplicate Invoice',        ico:'&#128202;' },
    { label:'Invalid HSN',                               value:'Invalid HSN',                               ico:'&#128258;' },
    { label:'Invalid POS (Place of Supply)',              value:'Invalid POS (Place of Supply)',              ico:'&#128205;' },
    { label:'Tax Invalid / Tax Mismatch',                value:'Tax Invalid / Tax Mismatch',                ico:'&#128176;' },
    { label:'GSTR-1 Filing Error',                       value:'GSTR-1 Filing Error',                       ico:'&#128209;' },
    { label:'GSTR-3B Mismatch',                          value:'GSTR-3B Mismatch',                          ico:'&#9878;'   }
  ]
};

var CAT = { einvoice:'E-Invoice Generation', ewaybill:'E-Way Bill Generation', gstreturns:'GST Returns' };

// â”€â”€ UTILS â”€â”€
var wait = function(ms){ return new Promise(function(r){ setTimeout(r,ms); }); };

function addMsg(type, html){
  return new Promise(function(resolve){
    var d = document.createElement('div');
    d.className = 'emg-msg ' + type;
    d.innerHTML = '<div class="emg-av">'+(type==='b'?'&#129302;':'&#128100;')+'</div><div class="emg-bub">'+html+'</div>';
    msgsEl.appendChild(d);
    msgsEl.scrollTop = msgsEl.scrollHeight;
    setTimeout(resolve, 50);
  });
}

function showTyping(){
  var d = document.createElement('div');
  d.className='emg-msg b'; d.id='emg-typing';
  d.innerHTML='<div class="emg-av">&#129302;</div><div class="emg-typing"><span></span><span></span><span></span></div>';
  msgsEl.appendChild(d); msgsEl.scrollTop=msgsEl.scrollHeight;
}
function hideTyping(){ var t=document.getElementById('emg-typing'); if(t) t.remove(); }
function clearDyn(){ dynEl.innerHTML=''; }

function showOpts(opts, cb){
  clearDyn();
  var row=document.createElement('div'); row.className='emg-opt-row';
  opts.forEach(function(o){
    var b=document.createElement('button');
    b.className='emg-obtn'+(o.cls?' '+o.cls:'');
    b.innerHTML=o.label;
    b.onclick=function(){ cb(o); };
    row.appendChild(b);
  });
  dynEl.appendChild(row);
}

function showMulti(items, cb){
  clearDyn();
  var wrap=document.createElement('div'); wrap.className='emg-ms-wrap';
  var hint=document.createElement('div'); hint.className='emg-ms-hint';
  hint.innerHTML='&#9989; Select <b>all issues</b> you are facing, then tap <b>Confirm</b>';
  wrap.appendChild(hint);

  var grid=document.createElement('div'); grid.className='emg-ms-grid';
  var selected={};

  var confirmBtn=document.createElement('button');
  confirmBtn.className='emg-ms-confirm';
  confirmBtn.textContent='Confirm Selection';
  confirmBtn.onclick=function(){
    var vals=Object.keys(selected);
    if(vals.length>0) cb(vals);
  };

  items.forEach(function(item){
    var btn=document.createElement('button'); btn.className='emg-ms-btn';
    btn.innerHTML='<span class="emg-chk">&#9744;</span><span>'+item.ico+'</span>'+item.label;
    btn.onclick=function(){
      if(selected[item.value]){
        delete selected[item.value];
        btn.classList.remove('sel');
        btn.querySelector('.emg-chk').innerHTML='&#9744;';
      } else {
        selected[item.value]=true;
        btn.classList.add('sel');
        btn.querySelector('.emg-chk').innerHTML='&#9745;';
      }
      var n=Object.keys(selected).length;
      confirmBtn.classList.toggle('on', n>0);
      confirmBtn.textContent = n>0 ? 'Confirm ('+n+' selected)' : 'Confirm Selection';
    };
    grid.appendChild(btn);
  });
  wrap.appendChild(grid);

  var actions=document.createElement('div'); actions.className='emg-ms-actions';
  var backBtn=document.createElement('button'); backBtn.className='emg-ms-back';
  backBtn.textContent='\u2190 Back';
  backBtn.onclick=function(){ clearDyn(); emgStartFlow(); };
  actions.appendChild(backBtn);
  actions.appendChild(confirmBtn);
  wrap.appendChild(actions);
  dynEl.appendChild(wrap);
  msgsEl.scrollTop=msgsEl.scrollHeight;
}

function showSolutions(issues, withBtns){
  clearDyn();
  var scroller=document.createElement('div'); scroller.className='emg-sol-scroller';
  issues.forEach(function(key,i){
    var sol=SOL[S.category]&&SOL[S.category][key];
    if(!sol) return;
    var box=document.createElement('div'); box.className='emg-sol-box';
    box.innerHTML='<div class="emg-stitle">'+sol.ico+' '+(i+1)+'. '+key+'</div>'+
      '<ul>'+sol.steps.map(function(s){ return '<li>'+s+'</li>'; }).join('')+'</ul>';
    scroller.appendChild(box);
  });
  dynEl.appendChild(scroller);

  if(withBtns){
    setTimeout(function(){
      var note=document.createElement('div');
      note.style.cssText='padding:2px 13px 5px;font-size:12.5px;color:#64748b;';
      note.textContent='Were these solutions helpful?';
      dynEl.appendChild(note);
      var row=document.createElement('div'); row.className='emg-opt-row'; row.style.paddingTop='0';
      [
        { label:'&#9989; Yes, resolved!',              cls:'green', fn:onResolved   },
        { label:'&#9888;&#65039; Some still pending',  cls:'amber', fn:onPending    },
        { label:'&#128104;&#8205;&#128187; Connect Agent', cls:'red', fn:connectAgent }
      ].forEach(function(o){
        var b=document.createElement('button');
        b.className='emg-obtn '+o.cls; b.innerHTML=o.label; b.onclick=o.fn; row.appendChild(b);
      });
      dynEl.appendChild(row);
      msgsEl.scrollTop=msgsEl.scrollHeight;
    },300);
  }
}

// â”€â”€ FLOW â”€â”€
async function emgStartFlow(){
  clearDyn();
  S={ category:'', selectedIssues:[], awaitingKW:false };
  txtIn.disabled=true; sndBtn.disabled=true;
  showTyping(); await wait(700); hideTyping();
  await addMsg('b','&#128075; <b>Welcome to EaseMyGST Support!</b><br>I\'m your virtual assistant. Please select your issue category to get started.');
  showOpts([
    { label:'&#129534; E-Invoice Generation', value:'einvoice'    },
    { label:'&#128666; E-Way Bill Generation', value:'ewaybill'   },
    { label:'&#128203; GST Returns',           value:'gstreturns' }
  ], onCategory);
}

async function onCategory(opt){
  S.category=opt.value;
  clearDyn();
  await addMsg('u', opt.label);
  showTyping(); await wait(600); hideTyping();
  await addMsg('b','Please <b>select all the issues</b> you are facing in <b>'+CAT[opt.value]+'</b>. You can pick multiple.');
  showMulti(MENUS[opt.value], onIssuesSelected);
}

async function onIssuesSelected(selected){
  S.selectedIssues=selected;
  clearDyn();
  await addMsg('u','&#128269; '+selected.join(' &bull; '));
  showTyping(); await wait(800); hideTyping();
  var msg=selected.length===1
    ? 'Here is the solution for <b>&ldquo;'+selected[0]+'&rdquo;</b>. Please try the steps below:'
    : 'You\'ve reported <b>'+selected.length+' issues</b>. Here are solutions &mdash; scroll and try each step:';
  await addMsg('b', msg);
  showSolutions(selected, true);
}

async function onResolved(){
  clearDyn();
  await addMsg('u','&#9989; Yes, all resolved!');
  showTyping(); await wait(600); hideTyping();
  await addMsg('b','&#127881; <b>Great!</b> Glad your issue is resolved. Have a productive day!');
  showOpts([{ label:'&#128260; Start Over', value:'r' }], function(){ msgsEl.innerHTML=''; emgStartFlow(); });
}

async function onPending(){
  clearDyn();
  await addMsg('u','&#9888;&#65039; Some still pending');
  showTyping(); await wait(700); hideTyping();
  await addMsg('b','No problem! Please <b>re-select the issues still pending</b> and I\'ll show the solutions again.');
  showMulti(MENUS[S.category], onIssuesSelected);
}

async function connectAgent(){
  clearDyn();
  S.awaitingKW=false;
  txtIn.disabled=true; sndBtn.disabled=true;
  txtIn.placeholder='Support session ended.';
  await addMsg('u','&#128104;&#8205;&#128187; Connect Support Executive');
  showTyping(); await wait(1100); hideTyping();

  var banner=document.createElement('div'); banner.className='emg-esc';
  banner.innerHTML=
    '<div class="emg-etitle">&#128104;&#8205;&#128187; Connecting to Support Executive&hellip;</div>'+
    '<p>Our support team has been notified and will contact you shortly.<br><br>'+
    '&#128222; <b>Helpline:</b> 08068175757<br>(Mon&ndash;Sat, 9 AM &ndash; 6 PM)<br>'+
    '&#128231; <b>Email:</b> support@easemygst.com<br>'+
    '&#9203; <b>Expected wait:</b> 5&ndash;10 minutes</p>';
  dynEl.appendChild(banner);

  await addMsg('b','&#9989; A Support Executive will contact you shortly. Thank you for your patience!');
  showOpts([{ label:'&#128260; Start Over', value:'r' }], function(){ msgsEl.innerHTML=''; emgStartFlow(); });
  msgsEl.scrollTop=msgsEl.scrollHeight;
}

function emgHandleInput(){
  var raw=txtIn.value.trim(); if(!raw) return;
  var val=raw.toLowerCase(); txtIn.value='';
  if(!S.awaitingKW) return;
  if(KW.some(function(k){ return val.indexOf(k)!==-1; })){
    connectAgent();
  } else {
    addMsg('u',raw).then(function(){
      showTyping();
      setTimeout(async function(){ hideTyping(); await addMsg('b','I see you still need help! Type <b>&ldquo;agent&rdquo;</b> or click <b>Connect Agent</b> below.'); },700);
    });
  }
}

txtIn.addEventListener('keydown',function(e){ if(e.key==='Enter') emgHandleInput(); });
sndBtn.addEventListener('click', emgHandleInput);

window.emgToggle = function(){
  chatWin.classList.toggle('open');
  if(chatWin.classList.contains('open') && msgsEl.children.length === 0){
    emgStartFlow();
  }
};

})();
</script>
</body>
</html>
